<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include get_lib("org.phpframework.layer.cache.exception.CacheLayerException"); include_once get_lib("org.phpframework.cache.CacheHandlerUtil"); include_once get_lib("org.phpframework.xmlfile.XMLFileParser"); include_once get_lib("org.phpframework.bean.BeanSettingsFileFactory"); abstract class CacheLayer { public $modules_cache = array(); public $keys = array(); public $service_related_keys_to_delete = array(); public $bean_objs; public $Layer; public $settings; public function __construct($v847a7225e0, $v30857f7eca) { $this->Layer = $v847a7225e0; $this->settings = $v30857f7eca; } abstract public function getModulePath($pcd8c70bc); abstract public function initModuleCache($pcd8c70bc); abstract public function getModuleCacheObj($pcd8c70bc, $v20b8676a9f, $v539082ff30); abstract public function getCachedDirPath(); public function prepareModulesCache($pcd8c70bc) { if(!is_array($this->modules_cache[$pcd8c70bc]["beans"])) $this->modules_cache[$pcd8c70bc]["beans"] = array(); if(!is_array($this->modules_cache[$pcd8c70bc]["services"])) $this->modules_cache[$pcd8c70bc]["services"] = array(); $v1ce69f3b9f = $this->modules_cache[$pcd8c70bc]["services"]; $v264b964f12 = array_keys($v1ce69f3b9f); $pc37695cb = count($v264b964f12); for($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pbfa01ed1 = $v264b964f12[$v43dd7d0051]; if(!$v1ce69f3b9f[$pbfa01ed1]["key"]) { $this->modules_cache[$pcd8c70bc]["services"][$pbfa01ed1]["key"] = $pbfa01ed1; $this->keys[$pcd8c70bc][$pbfa01ed1] = $pbfa01ed1; } else $this->keys[$pcd8c70bc][ $v1ce69f3b9f[$pbfa01ed1]["key"] ] = $pbfa01ed1; if(!$v1ce69f3b9f[$pbfa01ed1]["module_id"]) $this->modules_cache[$pcd8c70bc]["services"][$pbfa01ed1]["module_id"] = $pcd8c70bc; } $this->f4fda8636e5($pcd8c70bc); } private function f4fda8636e5($pcd8c70bc) { $v1ce69f3b9f = $this->modules_cache[$pcd8c70bc]["services"]; $v264b964f12 = array_keys($v1ce69f3b9f); $pc37695cb = count($v264b964f12); for($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pd3546181 = $v264b964f12[$v43dd7d0051]; $v3dcab54b7d = $v1ce69f3b9f[ $pd3546181 ]["key"]; if($v1ce69f3b9f[ $pd3546181 ]["to_cache"]) { $pe7235a8d = array(); for($v9d27441e80 = 0; $v9d27441e80 < $pc37695cb; $v9d27441e80++) { $v6f52baa31a = $v264b964f12[$v9d27441e80]; $v68edb03921 = $v1ce69f3b9f[ $v6f52baa31a ]["to_delete"]; if($v68edb03921) { $paf3a3908 = count($v68edb03921); for($pc5166886 = 0; $pc5166886 < $paf3a3908; $pc5166886++) { $v342a134247 = $v68edb03921[$pc5166886]; $pc8001b34 = $v342a134247["key"]; $v8773b3a63a = $v342a134247["type"]; if(CacheHandlerUtil::checkIfKeyTypeMatchValue($v3dcab54b7d, $pc8001b34, $v8773b3a63a)) { $pe7235a8d[md5(serialize($v342a134247))] = $v342a134247; } } } } $this->service_related_keys_to_delete[$pcd8c70bc][$pd3546181] = array_values($pe7235a8d); } } } public function check($pcd8c70bc, $v20b8676a9f, $v539082ff30, &$v9ad1385268, $v5d3813882f = false) { $this->initModuleCache($pcd8c70bc); $v95eeadc9e9 = $this->f6e103434bf($pcd8c70bc, $v20b8676a9f); if($v95eeadc9e9) { $pbc96d822 = $this->getModuleCacheObj($v95eeadc9e9["module_id"], $v20b8676a9f, $v539082ff30); if($pbc96d822) { $v5c1c342594 = $this->f8a9e7d3a4c($v95eeadc9e9, $v539082ff30, $v9ad1385268); if($v5c1c342594) { if($v95eeadc9e9["to_cache"]) { $pbfa01ed1 = $this->f3deb89b05f($v95eeadc9e9["key"], $v539082ff30, $v5d3813882f); if($pbc96d822->create($v20b8676a9f, $pbfa01ed1, $v9ad1385268, $v95eeadc9e9["cache_type"])) { $pe7235a8d = $this->service_related_keys_to_delete[ $v95eeadc9e9["module_id"] ][$v20b8676a9f]; $pbc96d822->addServiceToRelatedKeysToDelete($v20b8676a9f, $pbfa01ed1, $pe7235a8d, $v95eeadc9e9["cache_type"]); } } $pe33d544d = $v95eeadc9e9["to_delete"]; $v8412f08d6e = $this->search($pcd8c70bc, $pe33d544d); $this->deleteSearchedServices($v95eeadc9e9["module_id"], $v8412f08d6e, $v539082ff30, $v5d3813882f); } } } return true; } public function deleteSearchedServices($pcd8c70bc, $pe4662d7b, $v539082ff30 = array(), $v5d3813882f = false) { $v5c1c342594 = true; if ($pe4662d7b) foreach($pe4662d7b as $v5e813b295b => $v67db1bd535) { $pca049f76 = $v539082ff30; $pa20c6d1a = $v67db1bd535; $pa20c6d1a["id"] = $v5e813b295b; if($pa20c6d1a["script"]) $this->mbeff4e6733b6($pa20c6d1a["script"], $pca049f76); if (!$this->delete($pcd8c70bc, $pa20c6d1a, $pca049f76, $v5d3813882f)) $v5c1c342594 = false; } return $v5c1c342594; } public function deleteServiceBySearch($pcd8c70bc, $v199705296a, $pb8d73565, $v539082ff30, $v5d3813882f = false) { $pce0d5fcd = array( array("key" => $v199705296a, "type" => $pb8d73565) ); $pe4662d7b = $this->search($pcd8c70bc, $pce0d5fcd); return $this->deleteSearchedServices($pcd8c70bc, $pe4662d7b, $v539082ff30, $v5d3813882f); } public function delete($pcd8c70bc, $pa20c6d1a, $v539082ff30, $v5d3813882f = false) { $v20b8676a9f = $pa20c6d1a["id"]; $pdb5a7ae5 = $pa20c6d1a["key"]; $pe9ab513c = $pa20c6d1a["type"]; $v4baa6dd108 = $pa20c6d1a["module_id"] ? $pa20c6d1a["module_id"] : $pcd8c70bc; $this->initModuleCache($v4baa6dd108); $v95eeadc9e9 = $this->f6e103434bf($v4baa6dd108, $v20b8676a9f); if($v95eeadc9e9) { $pbc96d822 = $this->getModuleCacheObj($v95eeadc9e9["module_id"], $v20b8676a9f, $v539082ff30); if($pbc96d822) { $pbfa01ed1 = $this->f3deb89b05f($pdb5a7ae5, $v539082ff30, $v5d3813882f); $v7e50d66231 = $this->modules_cache[$v4baa6dd108]["services"][$v20b8676a9f]["key"]; if(CacheHandlerUtil::checkIfKeyTypeMatchValue($v20b8676a9f, $pdb5a7ae5, $pe9ab513c) || (CacheHandlerUtil::checkIfKeyTypeMatchValue($v7e50d66231, $pdb5a7ae5, $pe9ab513c) && $pbfa01ed1 == $pdb5a7ae5)) { return $pbc96d822->deleteAll($v20b8676a9f, $v95eeadc9e9["cache_type"]); } else { $v4a58b2e287 = $this->me2b59df7ceb6($v95eeadc9e9["module_id"], $v20b8676a9f, $pdb5a7ae5, $pe9ab513c); return $pbc96d822->delete($v20b8676a9f, $pbfa01ed1, array("cache_type" => $v95eeadc9e9["cache_type"], "key_type" => $pe9ab513c, "original_key" => $pdb5a7ae5, "delete_mode" => $v4a58b2e287)); } } } return true; } private function me2b59df7ceb6($pcd8c70bc, $v20b8676a9f, $pdb5a7ae5, $pe9ab513c) { if($pe9ab513c == "regexp" || $pe9ab513c == "regex" || $pe9ab513c == "start" || $pe9ab513c == "begin" || $pe9ab513c == "prefix" || $pe9ab513c == "middle" || $pe9ab513c == "end" || $pe9ab513c == "finish" || $pe9ab513c == "suffix") { $pe7235a8d = $this->service_related_keys_to_delete[ $pcd8c70bc ][ $v20b8676a9f ]; $pc37695cb = $pe7235a8d ? count($pe7235a8d) : 0; for($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) if($pe7235a8d[$v43dd7d0051]["key"] == $pdb5a7ae5 && $pe7235a8d[$v43dd7d0051]["type"] == $pe9ab513c) return 3; return 2; } return 1; } public function get($pcd8c70bc, $v20b8676a9f, $v539082ff30, $v5d3813882f = false) { $this->initModuleCache($pcd8c70bc); $v95eeadc9e9 = $this->f6e103434bf($pcd8c70bc, $v20b8676a9f); if($v95eeadc9e9) { $pbc96d822 = $this->getModuleCacheObj($v95eeadc9e9["module_id"], $v20b8676a9f, $v539082ff30); if($pbc96d822) { $pbfa01ed1 = $this->f3deb89b05f($v95eeadc9e9["key"], $v539082ff30, $v5d3813882f); return $pbc96d822->get($v20b8676a9f, $pbfa01ed1, $v95eeadc9e9["cache_type"]); } } return false; } public function getHeaders($pcd8c70bc, $v20b8676a9f) { $this->initModuleCache($pcd8c70bc); $v95eeadc9e9 = $this->f6e103434bf($pcd8c70bc, $v20b8676a9f); return $v95eeadc9e9 ? str_replace('\n', "\n", $v95eeadc9e9["headers"]) : false; } public function isValid($pcd8c70bc, $v20b8676a9f, $v539082ff30, $v5d3813882f = false) { $this->initModuleCache($pcd8c70bc); $v95eeadc9e9 = $this->f6e103434bf($pcd8c70bc, $v20b8676a9f); if($v95eeadc9e9) { $pbc96d822 = $this->getModuleCacheObj($v95eeadc9e9["module_id"], $v20b8676a9f, $v539082ff30); if($pbc96d822) { $v5c1c342594 = $this->f8a9e7d3a4c($v95eeadc9e9, $v539082ff30, $v02a69d4e0f); if($v5c1c342594) { $pbfa01ed1 = $this->f3deb89b05f($v95eeadc9e9["key"], $v539082ff30, $v5d3813882f); $v0ff021f094 = $pbc96d822->isValid($v20b8676a9f, $pbfa01ed1, $v95eeadc9e9["ttl"], $v95eeadc9e9["cache_type"]); if($v0ff021f094) { $pe7235a8d = $this->service_related_keys_to_delete[ $v95eeadc9e9["module_id"] ][$v20b8676a9f]; $pbc96d822->checkServiceToRelatedKeysToDelete($v20b8676a9f, $pbfa01ed1, $pe7235a8d, $v95eeadc9e9["cache_type"]); return true; } } } } return false; } public function search($pcd8c70bc, $pce0d5fcd) { $this->initModuleCache($pcd8c70bc); $v264b964f12 = array_keys($this->keys[$pcd8c70bc]); $v549f37f2d8 = array(); $pc37695cb = $pce0d5fcd ? count($pce0d5fcd) : 0; for($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pbfa01ed1 = $pce0d5fcd[$v43dd7d0051]["key"]; $v3fb9f41470 = $pce0d5fcd[$v43dd7d0051]["type"]; $v09c2c210a4 = $pce0d5fcd[$v43dd7d0051]["module_id"] ? $pce0d5fcd[$v43dd7d0051]["module_id"] : $pcd8c70bc; if($v09c2c210a4 == $pcd8c70bc) { if($this->keys[$pcd8c70bc][ $pbfa01ed1 ]) $v549f37f2d8[ $this->keys[$pcd8c70bc][ $pbfa01ed1 ] ] = $pce0d5fcd[$v43dd7d0051]; else if(in_array($pbfa01ed1, $this->keys[$pcd8c70bc])) $v549f37f2d8[ $pbfa01ed1 ] = $pce0d5fcd[$v43dd7d0051]; else { $v2fc4617ace = self::f403d29e52c($pbfa01ed1); $v2668dc24ad = ($v3fb9f41470 == "regexp" || $v3fb9f41470 == "regex" || $v3fb9f41470 == "start" || $v3fb9f41470 == "begin" || $v3fb9f41470 == "prefix" || $v3fb9f41470 == "middle" || $v3fb9f41470 == "end" || $v3fb9f41470 == "finish" || $v3fb9f41470 == "suffix") ? true : false; $pd28479e5 = count($v264b964f12); for($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) { $v68f4c06577 = self::f403d29e52c($v264b964f12[$v9d27441e80]); $v28c1cd997a = false; if($v2668dc24ad) { if(CacheHandlerUtil::checkIfKeyTypeMatchValue($v68f4c06577, $v2fc4617ace, $v3fb9f41470)) $v28c1cd997a = true; } else if($v68f4c06577 == $v2fc4617ace) $v28c1cd997a = true; if($v28c1cd997a && $this->keys[$pcd8c70bc][ $v264b964f12[$v9d27441e80] ]) $v549f37f2d8[ $this->keys[$pcd8c70bc][ $v264b964f12[$v9d27441e80] ] ] = $pce0d5fcd[$v43dd7d0051]; } } } else { $pe551fc4f = $this->search($v09c2c210a4, array($pce0d5fcd[$v43dd7d0051])); $v549f37f2d8 = array_merge($v549f37f2d8, $pe551fc4f); } } return $v549f37f2d8; } private function f6e103434bf($pcd8c70bc, $v20b8676a9f) { if ($this->modules_cache[$pcd8c70bc]["services"][$v20b8676a9f] && empty($this->modules_cache[$pcd8c70bc]["services"][$v20b8676a9f]["id_type"])) return $this->modules_cache[$pcd8c70bc]["services"][$v20b8676a9f]; else if ($this->modules_cache[$pcd8c70bc]["services"]) foreach ($this->modules_cache[$pcd8c70bc]["services"] as $v1cbfbb49c5 => $v95eeadc9e9) if ($v95eeadc9e9["id_type"] && CacheHandlerUtil::checkIfKeyTypeMatchValue($v20b8676a9f, $v1cbfbb49c5, $v95eeadc9e9["id_type"])) return $v95eeadc9e9; return null; } private function f3deb89b05f($pbfa01ed1, $pa293a3d3, $v5d3813882f = false) { $pbfa01ed1 = str_replace("&lt;?", "<?", $pbfa01ed1); $pbfa01ed1 = str_replace("?&gt;", "?>", $pbfa01ed1); $v761f4d757f = array("input" => $pa293a3d3, "options" => $v5d3813882f); $pbfa01ed1 = PHPScriptHandler::parseContent($pbfa01ed1, $v761f4d757f); if (isset($v5d3813882f["key_prefix"])) $pbfa01ed1 = $v5d3813882f["key_prefix"] . $pbfa01ed1; if (isset($v5d3813882f["key_suffix"])) $pbfa01ed1 .= $v5d3813882f["key_suffix"]; return $pbfa01ed1; } private static function f403d29e52c($pbfa01ed1) { $pbfa01ed1 = str_replace("&lt;?", "<?", $pbfa01ed1); $pbfa01ed1 = str_replace("?&gt;", "?>", $pbfa01ed1); $v7e4b517c18 = strpos($pbfa01ed1, "<?"); if($v7e4b517c18 !== false) { $pdc71a34d = substr($pbfa01ed1, 0, $v7e4b517c18); $pa841e6c9 = false; $v7f4f4373e5 = false; for($v43dd7d0051 = $v7e4b517c18 + 2; $v43dd7d0051 < strlen($pbfa01ed1); $v43dd7d0051++) { if($pbfa01ed1[$v43dd7d0051] == "'" && !$pa841e6c9) { $v7f4f4373e5 = !$v7f4f4373e5; } elseif($pbfa01ed1[$v43dd7d0051] == '"' && !$v7f4f4373e5) { $pa841e6c9 = !$pa841e6c9; } elseif($pbfa01ed1[$v43dd7d0051] == "?" && $pbfa01ed1[$v43dd7d0051 + 1] == ">" && !$pa841e6c9 && !$v7f4f4373e5) { $v7e4b517c18 = strpos($pbfa01ed1, "<?", $v43dd7d0051 + 2); $v7e4b517c18 = $v7e4b517c18 === false ? strlen($pbfa01ed1) : $v7e4b517c18; $pdc71a34d .= substr($pbfa01ed1, $v43dd7d0051 + 2, $v7e4b517c18 - ($v43dd7d0051 + 2)); $v43dd7d0051 = $v7e4b517c18 + 1; } } return $pdc71a34d; } return $pbfa01ed1; } private function f8a9e7d3a4c($v95eeadc9e9, &$v539082ff30, &$v05b1c40a78) { $v4c35be41c4 = $v95eeadc9e9["validation_script"]; return $this->mbeff4e6733b6($v4c35be41c4, $v539082ff30, $v05b1c40a78); } private function mbeff4e6733b6($v3db870d9e7, &$input, &$output = false) { if($v3db870d9e7) { try { $v5c1c342594 = eval($v3db870d9e7); } catch(Exception $paec2c009) { launch_exception($paec2c009); } return $v5c1c342594; } return true; } public function parseCacheFile($pcd8c70bc, $v0ff71d0593) { $v52b4591032 = $this->bean_objs; $pc5a892eb = array("objs" => $v52b4591032, "vars" => $v52b4591032["vars"]); $v19ed750c63 = new BeanSettingsFileFactory(); $v1e9dc98c41 = $v19ed750c63->getSettingsFromFile($v0ff71d0593, $pc5a892eb); $pae77d38c = file_get_contents($v0ff71d0593); $v538cb1a1f7 = get_lib("org.phpframework.xmlfile.schema.beans", "xsd"); $v50d32a6fc4 = XMLFileParser::parseXMLContentToArray($pae77d38c, $pc5a892eb, $v0ff71d0593, $v538cb1a1f7); $pa266c7f5 = is_array($v50d32a6fc4) ? array_keys($v50d32a6fc4) : array(); $pa266c7f5 = $pa266c7f5[0]; $pade90f87 = is_array($v50d32a6fc4[$pa266c7f5][0]["childs"]["services"][0]["childs"]["service"]) ? $v50d32a6fc4[$pa266c7f5][0]["childs"]["services"][0]["childs"]["service"] : array(); $v1ce69f3b9f = array(); $pc37695cb = $pade90f87 ? count($pade90f87) : 0; for($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v1c90917628 = $pade90f87[$v43dd7d0051]; $v1cbfbb49c5 = XMLFileParser::getAttribute($v1c90917628, "id"); $v57c3cf2d15 = array("file", "query", "obj", "constructor", "function", "cache_handler", "to_cache", "module_id", "cache_type", "ttl", "key", "validation_script", "id_type", "headers"); $v95eeadc9e9 = XMLFileParser::getAttributes($v1c90917628, $v57c3cf2d15); if(isset($v95eeadc9e9["to_cache"])) { $v9ccadd156a = strtolower($v95eeadc9e9["to_cache"]); $v95eeadc9e9["to_cache"] = $v9ccadd156a && $v9ccadd156a != "0" && $v9ccadd156a != "false" && $v9ccadd156a != "null" ? true : false; } if(isset($v1c90917628["childs"]["to_delete"][0]["childs"]["service"])) { $pc18880e0 = $v1c90917628["childs"]["to_delete"][0]["childs"]["service"]; $pab3a825b = array(); $pd28479e5 = $pc18880e0 ? count($pc18880e0) : 0; for($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) { $pdb27cee1 = $pc18880e0[$v9d27441e80]; $v57c3cf2d15 = array("type", "module_id", "key", "script"); $pc94c48eb = XMLFileParser::getAttributes($pdb27cee1, $v57c3cf2d15); if(isset($pc94c48eb["type"])) $pc94c48eb["type"] = strtolower($pc94c48eb["type"]); $pab3a825b[] = $pc94c48eb; } $v95eeadc9e9["to_delete"] = $pab3a825b; } $v1ce69f3b9f[$v1cbfbb49c5] = $v95eeadc9e9; } return array("beans" => $v1e9dc98c41, "services" => $v1ce69f3b9f); } } ?>
