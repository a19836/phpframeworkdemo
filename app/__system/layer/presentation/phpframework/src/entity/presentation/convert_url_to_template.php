<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
include_once get_lib("org.phpframework.util.MimeTypeHandler"); include_once $EVC->getUtilPath("WorkFlowBeansFileHandler"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "access"); $bean_name = $_GET["bean_name"]; $bean_file_name = $_GET["bean_file_name"]; $path = $_GET["path"]; $path = str_replace("../", "", $path); if ($bean_name && $bean_file_name && $path) { $WorkFlowBeansFileHandler = new WorkFlowBeansFileHandler($user_beans_folder_path . $bean_file_name, $user_global_variables_file_path); $PEVC = $WorkFlowBeansFileHandler->getEVCBeanObject($bean_name, $path); if ($PEVC) { $PHPVariablesFileHandler = new PHPVariablesFileHandler(array($user_global_variables_file_path, $PEVC->getConfigPath("pre_init_config"))); $PHPVariablesFileHandler->startUserGlobalVariables(); $P = $PEVC->getPresentationLayer(); $selected_project = $P->getSelectedPresentationId(); $raw_post_data = file_get_contents("php://input"); if ($_POST || $raw_post_data) { $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); $UserAuthenticationHandler->checkInnerFilePermissionAuthentication($PEVC->getTemplatesPath(), "layer", "access"); if ($_POST["load"]) { $url = $_POST["url"]; if ($url) { $is_local_file = substr($url, 0, 7) == "file://"; $html = null; if ($is_local_file) { $fp = substr($url, 7); $html = file_exists($fp) ? file_get_contents($fp) : ""; } else { $settings = array( "url" => $url, "settings" => array( "connection_timeout" => 60, "follow_location" => 1, "referer" => $_SERVER["HTTP_REFERER"], "CURLOPT_USERAGENT" => $_SERVER["HTTP_USER_AGENT"] ) ); $MyCurl = new MyCurl(); $MyCurl->initSingle($settings); $MyCurl->get_contents(); $data = $MyCurl->getData(); $html = $data[0]["content"]; $url = $data[0]["info"]["url"] ? $data[0]["info"]["url"] : $url; } if ($html) $html = prepareHtmlRelativeUrls($url, $html); echo "$url\n$html"; } die(); } else { $settings = json_decode($raw_post_data, true); if ($settings["save"] && $settings["template_name"]) { $template_name = $settings["template_name"]; $url = $settings["url"]; $doc_type = $settings["doc_type"]; $html = $settings["html"]; $regions = $settings["regions"]; $params = $settings["params"]; $original_html = $html; if ($regions) foreach ($regions as $region_name => $region_html) { $code = '&lt;? echo $EVC-&gt;getCMSLayer()-&gt;getCMSTemplateLayer()-&gt;renderRegion("' . $region_name . '"); ?&gt;'; $html = str_replace($code, htmlspecialchars_decode($code), $html); $original_html = str_replace($code, $region_html, $original_html); } if ($params) foreach ($params as $param_name => $param_html) { $code = '&lt;? echo $EVC-&gt;getCMSLayer()-&gt;getCMSTemplateLayer()-&gt;getParam("' . $param_name . '"); ?&gt;'; $html = str_replace($code, htmlspecialchars_decode($code), $html); $original_html = str_replace($code, $param_html, $original_html); } $html = $doc_type . $html; $original_html = $doc_type . $original_html; if ($params) { $prev_html = "<?\n"; foreach ($params as $param_name => $param_value) { $prev_html .= '$EVC->getCMSLayer()->getCMSTemplateLayer()->setParam("' . $param_name . '", "' . addcslashes($param_value, '"') . '");' . "\n"; } $prev_html .= "?>\n"; $html = $prev_html . $html; } $status = false; $template_folder_path = $PEVC->getTemplatesPath() . $template_name . "/"; if (!is_dir($template_folder_path)) mkdir($template_folder_path, 0755, true); if (is_dir($template_folder_path)) { $status = true; $webroot_folder_path = $PEVC->getWebrootPath() . "template/$template_name/"; if (!is_dir($webroot_folder_path)) mkdir($webroot_folder_path, 0755, true); if (!is_dir($webroot_folder_path) || !saveHtmlRelativeUrls($template_name, $webroot_folder_path, $url, $html)) $status = false; if ($regions) { $template_regions_folder = $template_folder_path . "region/index/"; if (!is_dir($template_regions_folder)) mkdir($template_regions_folder, 0755, true); if (is_dir($template_regions_folder)) { foreach ($regions as $region_name => $region_html) { $template_region_folder = $template_regions_folder . $region_name . "/"; if (!is_dir($template_region_folder)) mkdir($template_region_folder, 0755, true); if (!saveHtmlRelativeUrls($template_name, $webroot_folder_path, $url, $region_html, 'project_url_prefix')) $status = false; replaceExtraUrlsInHtml($template_name, $url, $region_html); if (!is_dir($template_region_folder) || file_put_contents($template_region_folder . "sample.htm", $region_html) === false) $status = false; } } else $status = false; } if ($params) foreach ($params as $param_name => $param_html) if (!saveHtmlRelativeUrls($template_name, $webroot_folder_path, $url, $param_html)) $status = false; replaceExtraUrlsInHtml($template_name, $url, $html); if (file_put_contents($template_folder_path . "index.php", $html) === false) $status = false; replaceLocalUrlsInHtml($template_name, $url, $original_html); if (file_put_contents($webroot_folder_path . "index.html", $original_html) === false) $status = false; } echo $status; die(); } } } $PHPVariablesFileHandler->endUserGlobalVariables(); } } function replaceLocalUrlsInHtml($pddee0279, $v6f3a2700dd, &$pf8ed4912) { $pbae7526c = getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $v17269bc5bf = $v9a9206776d["path"]; $v17269bc5bf = substr($v17269bc5bf, 0, 1) == "/" ? substr($v17269bc5bf, 1) : $v17269bc5bf; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } function replaceExtraUrlsInHtml($pddee0279, $v6f3a2700dd, &$pf8ed4912) { $pbae7526c = getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $v17269bc5bf = '#'; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } function saveHtmlRelativeUrls($pddee0279, $ped275ca3, $v6f3a2700dd, &$pf8ed4912, $v09067e92ac = 'original_project_url_prefix') { $v5c1c342594 = true; $pbae7526c = getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pa7f15786 = MimeTypeHandler::getAvailableFileExtensions("image"); $v1fcdf76e5d = $pa7f15786; $v1fcdf76e5d[] = "css"; $v1fcdf76e5d[] = "js"; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $pa32be502 = $v9a9206776d["path"]; $v6bfcc44e7b = strtolower(pathinfo($pa32be502, PATHINFO_EXTENSION)); if (in_array($v6bfcc44e7b, $v1fcdf76e5d)) { $v29abce7ca5 = substr($pdeee6a59, 0, 7) == "file://"; $pae77d38c = $v1e71ed36f0 = null; if ($v29abce7ca5) { $v9a84a79e2e = substr($pdeee6a59, 7); if (file_exists($v9a84a79e2e)) { $pae77d38c = file_get_contents($v9a84a79e2e); $v1e71ed36f0 = mime_content_type($v9a84a79e2e); } } else { $v30857f7eca = array( "url" => $pdeee6a59, "settings" => array( "connection_timeout" => 60, "follow_location" => 1, "referer" => $_SERVER["HTTP_REFERER"], "CURLOPT_USERAGENT" => $_SERVER["HTTP_USER_AGENT"] ) ); $v56a64ecb97 = new MyCurl(); $v56a64ecb97->initSingle($v30857f7eca); $v56a64ecb97->get_contents(); $v539082ff30 = $v56a64ecb97->getData(); $pae77d38c = $v539082ff30[0]["content"]; $v1e71ed36f0 = strtolower($v539082ff30[0]["info"]["content_type"]); } $v446afd1219 = true; if (in_array($v6bfcc44e7b, $pa7f15786)) $v446afd1219 = MimeTypeHandler::isImageMimeType($v1e71ed36f0); if ($v446afd1219) { $pb12450da = $pa32be502; $pf3dc0762 = $ped275ca3 . $pb12450da; $v57c9111d47 = dirname($pf3dc0762) . "/"; if (!is_dir($v57c9111d47)) mkdir($v57c9111d47, 0755, true); if (!is_dir($v57c9111d47) || file_put_contents($pf3dc0762, $pae77d38c) === false) $v5c1c342594 = false; else { $v17269bc5bf = '<?php echo $' . $v09067e92ac . '; ?>template/' . $pddee0279 . (substr($pb12450da, 0, 1) == "/" ? "" : "/") . $pb12450da; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } } } return $v5c1c342594; } function prepareHtmlRelativeUrls($v6f3a2700dd, $pf8ed4912) { $pbae7526c = getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $v22aff0eaaf = (!preg_match("/^(http:\/\/|https:\/\/|\/\/)/i", $v6f3a2700dd) ? "http://" : "") . $v6f3a2700dd; $pda386b6b = parse_url($v22aff0eaaf); $pd5349300 = ($pda386b6b["scheme"] ? $pda386b6b["scheme"] . "://" : "//") . ($pda386b6b["user"] ? $pda386b6b["user"] . ($pda386b6b["pass"] ? ":" . $pda386b6b["pass"] : "") . "@" : "") . $pda386b6b["host"] . ($pda386b6b["port"] ? ":" . $pda386b6b["port"] : ""); $v22aff0eaaf = $pd5349300 . ( pathinfo($pda386b6b["path"], PATHINFO_EXTENSION) ? ( dirname($pda386b6b["path"]) != "." ? dirname($pda386b6b["path"]) : "" ) : $pda386b6b["path"] ); $v22aff0eaaf .= substr($v22aff0eaaf, -1) != "/" ? "/" : ""; $pd5349300 .= substr($pd5349300, -1) != "/" ? "/" : ""; foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) if (!preg_match("/^(http:\/\/|https:\/\/|\/\/)/i", trim($pdeee6a59))) { $v17269bc5bf = trim($pdeee6a59); $v17269bc5bf = $v17269bc5bf[0] == "/" ? $pd5349300 . substr($v17269bc5bf, 1) : $v22aff0eaaf . $v17269bc5bf; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } return $pf8ed4912; } function getHtmlUrls($pf8ed4912) { preg_match_all('/\s*(src|href)\s*=\s*"([^"]*)"/iu', $pf8ed4912, $pb7f9502b, PREG_PATTERN_ORDER); preg_match_all("/\s*(src|href)\s*=\s*'([^']*)'/iu", $pf8ed4912, $v01929c58f3, PREG_PATTERN_ORDER); $pbae7526c = $pb7f9502b; if ($v01929c58f3) foreach ($v01929c58f3 as $pd69fb7d0 => $v6107abf109) if (is_array($v6107abf109)) { if (!is_array($pbae7526c[$pd69fb7d0])) $pbae7526c[$pd69fb7d0] = array(); $pbae7526c[$pd69fb7d0] = array_merge($pbae7526c[$pd69fb7d0], $v6107abf109); } return $pbae7526c; } ?>
