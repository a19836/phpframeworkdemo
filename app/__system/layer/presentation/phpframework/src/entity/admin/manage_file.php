<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.layer.presentation.cms.module.CMSModuleUtil"); include_once $EVC->getUtilPath("WorkFlowBeansFileHandler"); include_once $EVC->getUtilPath("LayoutTypeProjectHandler"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "access"); UserAuthenticationHandler::checkUsersMaxNum($UserAuthenticationHandler); $bean_name = $_GET["bean_name"]; $bean_file_name = $_GET["bean_file_name"]; $item_type = $_GET["item_type"]; $path = $_GET["path"]; $action = $_GET["action"]; $extra = trim($_GET["extra"]); $folder_type = $_GET["folder_type"]; $filter_by_layout = $_GET["filter_by_layout"]; $path = str_replace("../", "", $path);$filter_by_layout = str_replace("../", "", $filter_by_layout); $root_path = me0b302d2a1b1($bean_name, $bean_file_name, $item_type, $path, $user_beans_folder_path, $user_global_variables_file_path, $obj); $status = false; if ($root_path) { $orig_path = $path; $path = $root_path . $path; $layer_object_id = $item_type == "dao" ? "vendor/dao/$orig_path" : ($item_type == "vendor" || $item_type == "other" ? "$item_type/$orig_path" : ($item_type == "test_unit" ? "vendor/testunit/$orig_path" : $path)); if ($path && (file_exists($path) || $action == "create_folder" || $action == "create_file" || $action == "remove") ) { $UserAuthenticationHandler->checkInnerFilePermissionAuthentication($layer_object_id, "layer", "access"); $LayoutTypeProjectHandler = new LayoutTypeProjectHandler($UserAuthenticationHandler, $user_global_variables_file_path, $user_beans_folder_path, $bean_file_name, $bean_name); switch($action) { case "create_folder": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); if ($extra) { $UserAuthenticationHandler->checkInnerFilePermissionAuthentication("$layer_object_id/$extra", "layer", "access"); if (!file_exists($path)) mkdir($path, 0755, true); if (file_exists($path)) { $dest = "$path/$extra"; if ($item_type == "presentation" && $folder_type == "project") { if (f2c470a6552($EVC, $user_global_variables_file_path, $user_beans_folder_path)) { $status = CMSModuleUtil::copyFolder($EVC->getPresentationLayer()->getLayerPathSetting() . "empty/", $dest); if ($status) { $orig_path = dirname($orig_path . "/$extra"); $orig_path = str_replace("//", "/", $orig_path); $orig_path = substr($orig_path, 0, 1) == "/" ? substr($orig_path, 1) : $orig_path; $orig_path = substr($orig_path, -1) == "/" ? substr($orig_path, 0, -1) : $orig_path; $parts = explode("/", $orig_path); if ($parts && $orig_path) { $prefix = $suffix = ""; for ($i = 0; $i < count($parts); $i++) { $prefix .= "dirname("; $suffix .= ")"; } $init_path = $path . "$extra/" . $obj->settings["presentation_configs_path"] . "init.php"; $contents = file_get_contents($init_path); $contents = str_replace('include dirname(dirname(dirname(__DIR__))) . "/init.php";', 'include ' . $prefix . 'dirname(dirname(dirname(__DIR__)))' . $suffix . ' . "/init.php";', $contents); $status_1 = file_put_contents($init_path, $contents) !== false; $pre_init_config_path = $path . "$extra/" . $obj->settings["presentation_configs_path"] . "pre_init_config.php"; $contents = file_get_contents($pre_init_config_path); $contents = str_replace('$layer_path = dirname($project_path)', '$layer_path = ' . $prefix . 'dirname($project_path)' . $suffix, $contents); $status_2 = file_put_contents($pre_init_config_path, $contents) !== false; $script_path = $path . "$extra/" . $obj->settings["presentation_webroot_path"] . "script.php"; $contents = file_get_contents($script_path); $contents = str_replace('include dirname(dirname(__DIR__))', 'include ' . $prefix . 'dirname(dirname(__DIR__))' . $suffix, $contents); $status_3 = file_put_contents($script_path, $contents) !== false; $status = $status_1 && $status_2 && $status_3; } if ($status && is_dir($dest)) $status = prepareProjectCreationIfApply($LayoutTypeProjectHandler, $dest); } } else { $enc_msg = "50726f6a65637473206372656174696f6e206e6f7420616c6c6f7765642120596f752065786365656420746865206d6178696d756d206e756d626572206f662070726f6a65637473207468617420796f7572206c6963656e636520616c6c6f772e"; $status = ""; for ($i = 0; $i < strlen($enc_msg) - 1; $i += 2) $status .= chr( hexdec($enc_msg[$i] . $enc_msg[$i+1]) ); } } else if (!file_exists($dest)) { $status = mkdir($dest, 0755, true); if (is_dir($dest) && $filter_by_layout && ($item_type == "businesslogic" || $item_type == "ibatis" || $item_type == "hibernate")) $status = $LayoutTypeProjectHandler->createLayoutTypePermissionsForFilePathAndLayoutTypeName($filter_by_layout, $dest); } } } break; case "create_file": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); if ($extra) { $UserAuthenticationHandler->checkInnerFilePermissionAuthentication("$layer_object_id/$extra", "layer", "access"); $path_info = pathinfo($extra); if (!$path_info["extension"]) { if ($item_type == "ibatis" || $item_type == "hibernate") $extra .= ".xml"; else if ($item_type == "businesslogic" || $item_type == "presentation") $extra .= ".php"; } $allowed = true; if ($filter_by_layout && ($item_type == "businesslogic" || $item_type == "ibatis" || $item_type == "hibernate")) { $UserAuthenticationHandler->loadLayoutPermissions($filter_by_layout, UserAuthenticationHandler::$LAYOUTS_TYPE_FROM_PROJECT_ID); if (!$UserAuthenticationHandler->isLayoutInnerFilePermissionAllowed($path, $filter_by_layout, "layer", UserAuthenticationHandler::$PERMISSION_BELONG_NAME, false, false)) $allowed = false; } if ($allowed) { if (!file_exists($path)) mkdir($path, 0755, true); if (file_exists($path)) $status = file_put_contents("$path/$extra", "") !== false; } else { header($_SERVER["SERVER_PROTOCOL"] . " 405 Not Allowed"); $status = "You are not allowed to create a file inside of this folder, because it does NOT belong to the selected project!"; } } break; case "rename": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); if ($extra) { $UserAuthenticationHandler->checkInnerFilePermissionAuthentication(dirname($layer_object_id) . "/$extra", "layer", "access"); $is_obj_class = $item_type == "businesslogic" || $item_type == "test_unit" || $item_type == "dao" || ($item_type == "presentation" && strpos($path, "/util/") !== false); if ($is_obj_class && !is_dir($path)) $extra = preg_replace("/\s+/", "", $extra); if (basename($path) == $extra) $status = true; else { $dst = dirname($path) . "/$extra"; $is_class_rename = $is_obj_class && !is_dir($path) && basename($path) != basename($dst); $class_data = $is_class_rename ? PHPCodePrintingHandler::getClassOfFile($path) : null; $status = !file_exists($dst) ? rename($path, $dst) : $dst == $path; if ($status) { if ($is_class_rename && $class_data) { $src_class_name = PHPCodePrintingHandler::prepareClassNameWithNameSpace($class_data["name"], $class_data["namespace"]); $dst_class_name = PHPCodePrintingHandler::prepareClassNameWithNameSpace(pathinfo($dst, PATHINFO_FILENAME), $class_data["namespace"]); $status = PHPCodePrintingHandler::renameClassFromFile($dst, $src_class_name, $dst_class_name); } if ($item_type == "presentation") { updateDiagramWorkflowFile($action, $bean_name, $workflow_paths_id, $root_path, $path, $dst); if (is_dir($dst) && $LayoutTypeProjectHandler->isPathAPresentationProjectPath($dst)) $LayoutTypeProjectHandler->renameLayoutFromProjectPath($path, $dst); } if ($item_type == "presentation" || $item_type == "businesslogic" || $item_type == "ibatis" || $item_type == "hibernate") $LayoutTypeProjectHandler->renameLayoutTypePermissionsForFilePath($path, $dst); } } } break; case "remove": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "delete"); if ($path != $root_path) { if (is_dir($path)) { if ($item_type == "presentation") { removeDiagramWorkflowFile($action, $bean_name, $workflow_paths_id, $root_path, $path); if ($LayoutTypeProjectHandler->isPathAPresentationProjectPath($path)) $LayoutTypeProjectHandler->removeLayoutFromProjectPath($path); } if ($item_type == "presentation" || $item_type == "businesslogic" || $item_type == "ibatis" || $item_type == "hibernate") $LayoutTypeProjectHandler->removeLayoutTypePermissionsForFilePath($path); $status = CMSModuleUtil::deleteFolder($path); } else $status = !file_exists($path) || unlink($path); } break; case "zip": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); $dest_folder = $extra ? "$root_path/$extra/" : dirname($path); if ($dest_folder) { if (!is_dir($dest_folder)) mkdir($dest_folder, 0755, true); include_once get_lib("org.phpframework.compression.ZipHandler"); $dest = $dest_folder . "/" . basename($path) . ".zip"; $status = ZipHandler::zip($path, $dest); } break; case "unzip": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); UserAuthenticationHandler::checkActionsMaxNum($UserAuthenticationHandler); $dest = $extra ? "$root_path/$extra/" : dirname($path); if ($dest && strtolower(pathinfo($path, PATHINFO_EXTENSION)) == "zip") { if (!is_dir($dest)) mkdir($dest, 0755, true); include_once get_lib("org.phpframework.compression.ZipHandler"); $status = ZipHandler::unzip($path, $dest); if ($status) { $UserAuthenticationHandler->incrementUsedActionsTotal(); if ($item_type == "presentation" && is_dir($dest)) $status = prepareProjectCreationIfApply($LayoutTypeProjectHandler, $dest); } } break; case "upload": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); UserAuthenticationHandler::checkActionsMaxNum($UserAuthenticationHandler); if (is_dir($path) && $_FILES["file"]) { $status = move_uploaded_file( $_FILES['file']['tmp_name'], $path . "/" . basename($_FILES['file']['name']) ); if (!$status) { header($_SERVER["SERVER_PROTOCOL"] . " 500 Internal Server Error"); $status = "Internal Server Error"; } else $UserAuthenticationHandler->incrementUsedActionsTotal(); } break; case "paste": case "paste_and_remove": $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); if (is_dir($path)) { $extra = explode(",", str_replace(array("[", "]"), "", $extra)); if (count($extra) >= 4) { $bn = $extra[0]; $bfn = $extra[1]; $fp = $extra[2]; $it = $extra[3]; $fp = str_replace("../", "", $fp); $rp = me0b302d2a1b1($bn, $bfn, $it, $fp, $user_beans_folder_path, $user_global_variables_file_path); $src = $rp . $fp; $dst = $path . "/" . basename($src); $path_info = pathinfo($src); $idx = 1; while (file_exists($dst)) { $dst = $path . "/" . $path_info["filename"] . "_" . $idx . ($path_info["extension"] ? "." . $path_info["extension"] : ""); $idx++; } $status = is_dir($src) ? WorkFlowBeansFolderHandler::copyFolder($src . "/", $dst . "/") : copy($src, $dst); if ($status) { $is_obj_class = $item_type == "businesslogic" || $item_type == "test_unit" || $item_type == "dao" || ($item_type == "presentation" && strpos($path, "/util/") !== false); if ($is_obj_class && !is_dir($src) && basename($src) != basename($dst)) { $src_classes = PHPCodePrintingHandler::getPHPClassesFromFile($src); unset($src_classes[0]); if ($src_classes) { $idx--; foreach ($src_classes as $cn => $c) { $src_class_name = PHPCodePrintingHandler::prepareClassNameWithNameSpace($c["name"], $c["namespace"]); $dst_class_name = PHPCodePrintingHandler::prepareClassNameWithNameSpace($c["name"] . "_$idx", $c["namespace"]); if (!PHPCodePrintingHandler::renameClassFromFile($dst, $src_class_name, $dst_class_name)) $status = false; } } } else if ($item_type == "presentation") { updateDiagramWorkflowFile($action, $bean_name, $workflow_paths_id, $root_path, $src, $dst); if (is_dir($dst)) $status = prepareProjectCreationIfApply($LayoutTypeProjectHandler, $dst); } } if ($status && $action == "paste_and_remove") { $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "delete"); if ($src != $root_path) $status = is_dir($src) ? CMSModuleUtil::deleteFolder($src) : !file_exists($src) || unlink($src); } } } break; } } } function me0b302d2a1b1($v8ffce2a791, $pa0462a8e, $v8773b3a63a, $pa32be502, $v5039a77f9d, $v3d55458bcd, &$v972f1a5c2b = false) { $v4ab372da3a = null; if ($v8773b3a63a == "dao") $v4ab372da3a = DAO_PATH; else if ($v8773b3a63a == "vendor") $v4ab372da3a = VENDOR_PATH; else if ($v8773b3a63a == "test_unit") $v4ab372da3a = TEST_UNIT_PATH; else if ($v8773b3a63a == "other") $v4ab372da3a = OTHER_PATH; else { $pb512d021 = new WorkFlowBeansFileHandler($v5039a77f9d . $pa0462a8e, $v3d55458bcd); if ($v8773b3a63a != "presentation") $v972f1a5c2b = $pb512d021->getBeanObject($v8ffce2a791); else { $v188b4f5fa6 = $pb512d021->getEVCBeanObject($v8ffce2a791, $pa32be502); $v972f1a5c2b = $v188b4f5fa6 ? $v188b4f5fa6->getPresentationLayer() : null; } if ($v972f1a5c2b) $v4ab372da3a = $v972f1a5c2b->getLayerPathSetting(); } return $v4ab372da3a; } function f2c470a6552($EVC, $user_global_variables_file_path, $user_beans_folder_path) { $pb9be6168 = substr(LA_REGEX, strpos(LA_REGEX, "]") + 1); if (!is_numeric($pb9be6168)) return false; else if ($pb9be6168 == -1) return true; include_once $EVC->getUtilPath("CMSPresentationLayerHandler"); $v6ee393d9fb = CMSPresentationLayerHandler::getPresentationLayersProjectsFiles($user_global_variables_file_path, $user_beans_folder_path, "webroot", false, 0); $v03f4b4ed53 = 0; if ($v6ee393d9fb) foreach ($v6ee393d9fb as $v7dffdb5a5b) if ($v7dffdb5a5b["projects"]) $v03f4b4ed53 += count($v7dffdb5a5b["projects"]); return $v03f4b4ed53 + 1 <= $pb9be6168; } function updateDiagramWorkflowFile($v1b5ae9c139, $v8ffce2a791, $pdb9e96e6, $pa2bba2ac, $v6b146f3e75, $v1a74c80ef8) { $v5c1c342594 = true; $v6b146f3e75 = trim($v6b146f3e75); $v1a74c80ef8 = trim($v1a74c80ef8); if ($v6b146f3e75 && $v1a74c80ef8 && $v1a74c80ef8 != $v6b146f3e75 && is_dir($v1a74c80ef8)) { $v6b146f3e75 = preg_replace("/[\/]+/", "/", $v6b146f3e75); $v1a74c80ef8 .= substr($v1a74c80ef8, -1) == "/" ? "" : "/"; $v1a74c80ef8 = preg_replace("/[\/]+/", "/", $v1a74c80ef8); if (substr($v6b146f3e75, 0, strlen($pa2bba2ac)) == $pa2bba2ac && strpos($v6b146f3e75, "/src/entity/") !== false) { $v6b146f3e75 .= substr($v6b146f3e75, -1) == "/" ? "" : "/"; $v12babd294b = str_replace($pa2bba2ac, "", $v6b146f3e75); $v7a48d7585a = WorkFlowTasksFileHandler::getTaskFilePathByPath($pdb9e96e6, "presentation_ui", "_{$v8ffce2a791}_" . md5($v12babd294b)); if (file_exists($v7a48d7585a)) { $v74fc3dc928 = str_replace($pa2bba2ac, "", $v1a74c80ef8); $pe56fd0f9 = WorkFlowTasksFileHandler::getTaskFilePathByPath($pdb9e96e6, "presentation_ui", "_{$v8ffce2a791}_" . md5($v74fc3dc928)); if ($pe56fd0f9) { if (($v1b5ae9c139 == "rename" || $v1b5ae9c139 == "paste_and_remove")) { if (file_exists($pe56fd0f9)) unlink($pe56fd0f9); if (!rename($v7a48d7585a, $pe56fd0f9)) $v5c1c342594 = false; } else if ($v1b5ae9c139 == "paste" && !copy($v7a48d7585a, $pe56fd0f9)) $v5c1c342594 = false; } } $v2cd5d67337 = scandir($v1a74c80ef8); if ($v2cd5d67337) foreach ($v2cd5d67337 as $v3a3060fe4b) if ($v3a3060fe4b != "." && $v3a3060fe4b != ".." && is_dir("$v1a74c80ef8$v3a3060fe4b") && !updateDiagramWorkflowFile($v1b5ae9c139, $v8ffce2a791, $pdb9e96e6, $pa2bba2ac, "$v6b146f3e75$v3a3060fe4b/", "$v1a74c80ef8$v3a3060fe4b/")) $v5c1c342594 = false; } } return $v5c1c342594; } function removeDiagramWorkflowFile($v1b5ae9c139, $v8ffce2a791, $pdb9e96e6, $pa2bba2ac, $pdd397f0a) { $v5c1c342594 = true; $pdd397f0a = trim($pdd397f0a); if ($pdd397f0a && is_dir($pdd397f0a)) { $pdd397f0a = preg_replace("/[\/]+/", "/", $pdd397f0a); if (substr($pdd397f0a, 0, strlen($pa2bba2ac)) == $pa2bba2ac && strpos($pdd397f0a, "/src/entity/") !== false) { $pdd397f0a .= substr($pdd397f0a, -1) == "/" ? "" : "/"; $v12babd294b = str_replace($pa2bba2ac, "", $pdd397f0a); $v7a48d7585a = WorkFlowTasksFileHandler::getTaskFilePathByPath($pdb9e96e6, "presentation_ui", "_{$v8ffce2a791}_" . md5($v12babd294b)); if (file_exists($v7a48d7585a) && !unlink($v7a48d7585a)) $v5c1c342594 = false; $v2cd5d67337 = scandir($pdd397f0a); if ($v2cd5d67337) foreach ($v2cd5d67337 as $v3a3060fe4b) if ($v3a3060fe4b != "." && $v3a3060fe4b != ".." && is_dir("$pdd397f0a$v3a3060fe4b") && !removeDiagramWorkflowFile($v1b5ae9c139, $v8ffce2a791, $pdb9e96e6, $pa2bba2ac, "$pdd397f0a$v3a3060fe4b/")) $v5c1c342594 = false; } } return $v5c1c342594; } function prepareProjectCreationIfApply($v1eb9193558, $v7e136b813a, $v830c8335f6 = true) { return $v1eb9193558->isPathAPresentationProjectPath($v7e136b813a) && $v1eb9193558->createNewLayoutFromProjectPath($v7e136b813a, $v830c8335f6); } ?>
