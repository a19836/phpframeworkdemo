<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.layer.presentation.cms.module.CMSModuleInstallationHandler"); include_once $EVC->getUtilPath("CMSPresentationLayerHandler"); include_once $EVC->getUtilPath("LayoutTypeProjectHandler"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "access"); $bean_name = $_GET["bean_name"]; $bean_file_name = $_GET["bean_file_name"]; $filter_by_layout = $_GET["filter_by_layout"]; $filter_by_layout = str_replace("../", "", $filter_by_layout); if ($bean_name && $bean_file_name) { $projects = CMSPresentationLayerHandler::getPresentationLayerProjectsFiles($user_global_variables_file_path, $user_beans_folder_path, $bean_file_name, $bean_name, "config", false, 0); $LayoutTypeProjectHandler = new LayoutTypeProjectHandler($UserAuthenticationHandler, $user_global_variables_file_path, $user_beans_folder_path, $bean_file_name, $bean_name); $LayoutTypeProjectHandler->filterPresentationLayerProjectsByUserAndLayoutPermissions($projects, $filter_by_layout, UserAuthenticationHandler::$PERMISSION_BELONG_NAME, array( "do_not_filter_by_layout" => array( "bean_name" => $bean_name, "bean_file_name" => $bean_file_name ) )); $WorkFlowBeansFileHandler = new WorkFlowBeansFileHandler($user_beans_folder_path . $bean_file_name, $user_global_variables_file_path); $P = $WorkFlowBeansFileHandler->getBeanObject($bean_name, ""); $available_db_drivers = WorkFlowBeansFileHandler::getLayerDBDrivers($user_global_variables_file_path, $user_beans_folder_path, $P, true); $LayoutTypeProjectHandler->filterLayerBrokersDBDriversPropsFromLayoutName($available_db_drivers, $filter_by_layout); if ($_POST && ($_FILES["zip_file"] || $_POST["zip_url"])) { $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); $status = true; $messages = array(); $PresentationLayer = $EVC->getPresentationLayer(); $module_prefix_path = $PresentationLayer->getLayerPathSetting() . $PresentationLayer->getCommonProjectName() . "/"; $system_presentation_settings_path = $module_prefix_path . $PresentationLayer->settings["presentation_modules_path"]; $system_presentation_settings_webroot_path = $module_prefix_path . $PresentationLayer->settings["presentation_webroot_path"] . "module/"; $selected_project = $_POST["project"]; $selected_db_driver = $_POST["db_driver"]; $pre_init_configs = array(); foreach ($projects as $project_name => $project) { if (empty($selected_project) || $project_name == $selected_project) { if ($project["files"]["pre_init_config.php"] || $project["files"]["pre_init_config"]) { $fp = $project["files"]["pre_init_config.php"] ? $project["files"]["pre_init_config.php"] : $project["files"]["pre_init_config"]; $file_path = substr($project["path"], 0, - strlen($project_name)) . $fp["path"]; $pre_init_configs[$project_name] = $file_path; } } } if (!$pre_init_configs) $pre_init_configs[] = false; $files_to_close = array(); $zip_urls_indexes = array(); if ($_POST["zip_url"]) { $index = $_FILES["zip_file"] && $_FILES["zip_file"]["name"] ? max(array_keys($_FILES["zip_file"]["name"])) + 1 : 0; foreach ($_POST["zip_url"] as $zip_url) if (trim($zip_url)) { $fp = tmpfile(); $fp_path = stream_get_meta_data($fp)['uri']; $files_to_close[] = $fp; $settings = array( "url" => str_replace(" ","%20", $zip_url), "settings" => array( "follow_location" => true, "connection_timeout" => 50, "CURLOPT_TIMEOUT" => 50, "CURLOPT_FILE" => $fp, ) ); $MyCurl = new MyCurl(); $MyCurl->initSingle($settings); $MyCurl->get_contents(); $data = $MyCurl->getData(); $data = $data[0]; if ($data["info"] && $data["info"]["http_code"] == 200 && stripos($data["info"]["content_type"], "zip") !== false) { if (!$_FILES["zip_file"]) $_FILES["zip_file"] = array(); $_FILES["zip_file"]["name"][$index] = basename(parse_url($zip_url, PHP_URL_PATH)); $_FILES["zip_file"]["type"][$index] = $data["info"]["content_type"] ? $data["info"]["content_type"] : mime_content_type($fp_path); $_FILES["zip_file"]["tmp_name"][$index] = $fp_path; $_FILES["zip_file"]["error"][$index] = 0; $_FILES["zip_file"]["size"][$index] = $data["info"]["size_download"] ? $data["info"]["size_download"] : filesize($fp_path); $zip_urls_indexes[$index] = true; $index++; } else { $status = false; $error_message = "Error: Could not upload file. Please try again..."; } } } if ($_FILES["zip_file"]) { $exists = false; foreach ($_FILES["zip_file"]["name"] as $i => $name) if (trim($name)) { $exists = true; break; } if (!$exists) { $status = false; $error_message = "Error: File cannot be empty!"; } else { ksort($_FILES["zip_file"]["name"]); ksort($_FILES["zip_file"]["type"]); ksort($_FILES["zip_file"]["tmp_name"]); ksort($_FILES["zip_file"]["error"]); ksort($_FILES["zip_file"]["size"]); $right_order = array("translator", "common", "object", "tag", "attachment", "user", "action", "zip", "comment"); $new_files = array(); foreach ($right_order as $file_name) foreach ($_FILES["zip_file"]["name"] as $i => $name) { if (pathinfo($name, PATHINFO_FILENAME) == $file_name) { $new_files["zip_file"]["name"][] = $name; $new_files["zip_file"]["type"][] = $_FILES["zip_file"]["type"][$i]; $new_files["zip_file"]["tmp_name"][] = $_FILES["zip_file"]["tmp_name"][$i]; $new_files["zip_file"]["error"][] = $_FILES["zip_file"]["error"][$i]; $new_files["zip_file"]["size"][] = $_FILES["zip_file"]["size"][$i]; break; } } foreach ($_FILES["zip_file"]["name"] as $i => $name) { if (!in_array(pathinfo($name, PATHINFO_FILENAME), $right_order)) { $new_files["zip_file"]["name"][] = $name; $new_files["zip_file"]["type"][] = $_FILES["zip_file"]["type"][$i]; $new_files["zip_file"]["tmp_name"][] = $_FILES["zip_file"]["tmp_name"][$i]; $new_files["zip_file"]["error"][] = $_FILES["zip_file"]["error"][$i]; $new_files["zip_file"]["size"][] = $_FILES["zip_file"]["size"][$i]; } } foreach ($new_files["zip_file"]["name"] as $i => $name) if (trim($name)) { $zip_file = array( "name" => $name, "type" => $new_files["zip_file"]["type"][$i], "tmp_name" => $new_files["zip_file"]["tmp_name"][$i], "error" => $new_files["zip_file"]["error"][$i], "size" => $new_files["zip_file"]["size"][$i], ); $zipped_file_path = TMP_PATH . $name; $extension = strtolower( pathinfo($name, PATHINFO_EXTENSION) ); $module_id = pathinfo($zip_file["name"], PATHINFO_FILENAME); if ($extension != "zip") { $status = false; $messages[$module_id][$project_name][] = array("msg" => "STATUS: FALSE: File '$name' must be a zip file!", "type" => "alert"); } else { $is_zip_url = !empty($zip_urls_indexes[$i]); $continue = $is_zip_url ? rename($zip_file["tmp_name"], $zipped_file_path) : move_uploaded_file($zip_file["tmp_name"], $zipped_file_path); if ($continue) { $unzipped_module_path = CMSModuleInstallationHandler::unzipModuleFile($zipped_file_path); $info = CMSModuleInstallationHandler::getUnzippedModuleSettings($unzipped_module_path); if ($info && $info["tag"] && $module_id != $info["tag"]) $module_id = $info["tag"]; $system_presentation_settings_module_path = $system_presentation_settings_path . $module_id; $system_presentation_settings_webroot_module_path = $system_presentation_settings_webroot_path . $module_id; $used_drivers = array(); foreach ($pre_init_configs as $project_name => $pre_init_config) { $user_global_variables_file_paths = $pre_init_config ? array($user_global_variables_file_path, $pre_init_config) : $user_global_variables_file_path; $PHPVariablesFileHandler = new PHPVariablesFileHandler($user_global_variables_file_paths); $PHPVariablesFileHandler->startUserGlobalVariables(); $layers = WorkFlowBeansFileHandler::getLocalBeanLayersFromBrokers($user_global_variables_file_paths, $user_beans_folder_path, $P->getBrokers(), true); $layers[$bean_name] = $P; $CMSModuleInstallationHandler = CMSModuleInstallationHandler::createCMSModuleInstallationHandlerObject($layers, $module_id, $system_presentation_settings_module_path, $system_presentation_settings_webroot_module_path, $unzipped_module_path, $selected_db_driver, $UserAuthenticationHandler); $CMSModuleInstallationHandler->setUsedDBDrivers($used_drivers); $data_access_layer_detected = $CMSModuleInstallationHandler->detectedLayerByClass("DataAccessLayer"); try { $s = $CMSModuleInstallationHandler->install(); if ($s) { if ($CMSModuleInstallationHandler->areAllDBDriversUsed()) $messages[$module_id][$project_name][] = array("msg" => "STATUS: OK, BUT NO DB DRIVERS EXECUTED BC THEY WERE ALREADY EXECUTED BEFORE!", "type" => "alert"); } else { $status = false; $messages[$module_id][$project_name][] = array("msg" => "STATUS: FALSE", "type" => "error"); } if (!$data_access_layer_detected) $messages[$module_id][$project_name][] = array("msg" => "NO DATA ACCESS LAYERS DETECTED, WHICH MEANS THAT IF THIS MODULE CONTAINS ANY XML FILES WITH SQL QUERIES, THEY WEREN'T COPIED!", "type" => "alert"); if ($messages[$module_id][$project_name]) $messages[$module_id][$project_name][] = array("msg" => "GLOBAL SELECTED DB DRIVER: " . $GLOBALS["default_db_driver"], "type" => "info"); } catch(Exception $e) { $status = false; $messages[$module_id][$project_name][] = array("msg" => "STATUS: FALSE", "type" => "error"); if (!$data_access_layer_detected) $messages[$module_id][$project_name][] = array("msg" => "NO DATA ACCESS LAYERS DETECTED, WHICH MEANS THAT IF THIS MODULE CONTAINS ANY XML FILES WITH SQL QUERIES, THEY WEREN'T COPIED!", "type" => "alert"); $messages[$module_id][$project_name][] = array("msg" => "GLOBAL SELECTED DB DRIVER: " . $GLOBALS["default_db_driver"], "type" => "info"); $messages[$module_id][$project_name][] = array("msg" => "ERROR MESSAGE: \n" . trim($e->getMessage()), "type" => "exception"); $messages[$module_id][$project_name][] = array("msg" => "\n" . trim($e->problem), "type" => "exception"); global $GlobalErrorHandler; if (!$GlobalErrorHandler->ok()) $GlobalErrorHandler->start(); } $module_installation_messages = $CMSModuleInstallationHandler->getMessages(); if ($module_installation_messages) $messages[$module_id][$project_name][] = array("msg" => implode("\n", $module_installation_messages), "type" => "info"); $used_drivers = array_merge($used_drivers, $CMSModuleInstallationHandler->getUsedDBDrivers()); if ($CMSModuleInstallationHandler->isModuleInstalled()) { if (!$LayoutTypeProjectHandler->createLayoutTypePermissionsForModuleInLayersFromProjectPath($projects[$project_name]["path"], $layers, $module_id)) $messages[$module_id][$project_name][] = array("msg" => "Could not add the module permission for the selected projects layout types.", "type" => "info"); } $CMSModuleInstallationHandler->freeModuleCache(); $CMSModuleLayer = $EVC->getCMSLayer()->getCMSModuleLayer(); $CMSModuleLayer->freeModuleCache(); $PHPVariablesFileHandler->endUserGlobalVariables(); } CMSModuleUtil::deleteFolder($unzipped_module_path); unlink($zipped_file_path); } else { $status = false; $messages[$module_id][$project_name][] = array("msg" => "STATUS: FALSE: File '$name' not uploaded!", "type" => "error"); } } } } } else $error_message = "Error: Could not upload file. Please try again..."; if ($files_to_close) foreach ($files_to_close as $fp) fclose($fp); } } ?>
