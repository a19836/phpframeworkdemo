<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once $EVC->getUtilPath("CMSPresentationLayerHandler"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "access"); $default_page = $_GET["default_page"]; if (!empty($_GET["bean_name"])) { $bean_name = $_GET["bean_name"]; setcookie("selected_bean_name", $bean_name); } else if (!empty($_COOKIE["selected_bean_name"])) $bean_name = $_COOKIE["selected_bean_name"]; if (!empty($_GET["bean_file_name"])) { $bean_file_name = $_GET["bean_file_name"]; setcookie("selected_bean_file_name", $bean_file_name); } else if (!empty($_COOKIE["selected_bean_file_name"])) $bean_file_name = $_COOKIE["selected_bean_file_name"]; if (!empty($_GET["project"])) { $project = $_GET["project"]; setcookie("selected_project", $project); } else if (!empty($_COOKIE["selected_project"])) $project = $_COOKIE["selected_project"]; if (!$bean_name || !$bean_file_name || !$project) { $url = "{$project_url_prefix}admin/choose_available_project?redirect_path=admin"; header("Location: $url"); die("<script>document.location = '$url';</script>"); } $layers = AdminMenuHandler::getLayers($user_global_variables_file_path); $presentation_bean_name = $layers["presentation_layers"] ? key($layers["presentation_layers"]) : null; $presentation_bean_file_name = $layers["presentation_layers"][$presentation_bean_name]; $layer_object_id_prefix = str_replace(APP_PATH, "", LAYER_PATH); $layer_object_id_prefix = substr($layer_object_id_prefix, -1) == "/" ? substr($layer_object_id_prefix, 0, -1) : $layer_object_id_prefix; $layer_object_id = strtolower("$layer_object_id_prefix/") . WorkFlowBeansFileHandler::getLayerBeanFolderName($user_beans_folder_path . $presentation_bean_file_name, $presentation_bean_name, $user_global_variables_file_path); $is_presentation_layer_allowed = $UserAuthenticationHandler->isFilePermissionAllowed($layer_object_id, "layer", "access"); $is_flush_cache_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("admin/flush_cache"), "delete"); $is_manage_layers_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("setup/layers"), "access"); $is_manage_modules_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("admin/manage_modules"), "access"); $is_manage_projects_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("presentation/manage_projects"), "access"); $is_manage_users_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("user/manage_users"), "access"); $is_deployment_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("deployment/index"), "access"); $is_testunits_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("testunit/index"), "access"); $is_program_installation_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("admin/install_program"), "access"); $is_diff_files_allowed = $UserAuthenticationHandler->isPresentationFilePermissionAllowed($EVC->getEntityPath("diff/index"), "access"); if ($is_presentation_layer_allowed) { $projects = CMSPresentationLayerHandler::getPresentationLayerProjectsFiles($user_global_variables_file_path, $user_beans_folder_path, $bean_file_name, $bean_name); if (!$projects[$project]) { $url = $project_url_prefix . "admin/choose_available_project?redirect_path=admin"; header("Location: $url"); echo "<script>document.location='$url';</script>"; die(); } } ?>
