<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once $EVC->getUtilPath("WorkFlowDBHandler"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "access"); $UserAuthenticationHandler->checkPresentationFileAuthentication($entity_path, "write"); $status = false; if ($_POST) { $layer_bean_folder_name = $_GET["layer_bean_folder_name"]; $bean_name = $_GET["bean_name"]; $bean_file_name = $_GET["bean_file_name"]; $table = $_GET["table"]; if ($bean_name && $table) { $layer_object_id = LAYER_PATH . "$layer_bean_folder_name/$bean_name"; $UserAuthenticationHandler->checkInnerFilePermissionAuthentication($layer_object_id, "layer", "access"); $WorkFlowDBHandler = new WorkFlowDBHandler($user_beans_folder_path, $user_global_variables_file_path); $DBDriver = $WorkFlowDBHandler->getBeanObject($bean_file_name, $bean_name); $existent_tables = $DBDriver->listTables(); $table_exists = $DBDriver->isTableInNamesList($existent_tables, $table); if ($table_exists) { $table_fields = $DBDriver->listTableFields($table); if ($table_fields) { $pks = array(); $auto_increment_pks = array(); $attributes = $_POST["attributes"]; $conditions = $_POST["conditions"]; foreach ($table_fields as $field_name => $field) { if ($field["primary_key"]) $pks[] = $field_name; if ($field["auto_increment"]) $auto_increment_pks[] = $field_name; } if ($attributes) { $numeric_types = $DBDriver->getDBColumnNumericTypes(); foreach ($attributes as $k => $v) { if (!array_key_exists($k, $table_fields)) unset($attributes[$k]); else { $field_props = $table_fields[$k]; if (in_array($field_props["type"], $numeric_types) && !is_numeric($v) && empty($v)) { if (in_array($k, $auto_increment_pks)) { unset($attributes[$k]); continue 1; } else $attributes[$k] = $field_props["null"] ? null : 0; } } } } if ($conditions) foreach ($conditions as $k => $v) if (!in_array($k, $pks)) unset($conditions[$k]); switch($_POST["action"]) { case "insert": $options = array(); foreach ($attributes as $k => $v) if (in_array($k, $auto_increment_pks)) { $options["hard_coded_ai_pk"] = true; break; } if ($attributes && $DBDriver->insertObject($table, $attributes, $options)) { $status = true; if ($auto_increment_pks) { foreach ($auto_increment_pks as $k) if (isset($attributes[$k])) { $status = json_encode(array($k => $attributes[$k])); break; } if ($status == true) { $new_pk = $DBDriver->getInsertedId(); if ($new_pk) $status = json_encode(array($auto_increment_pks[0] => $new_pk)); } } } break; case "update": foreach ($attributes as $k => $v) foreach ($conditions as $ck => $cv) if ($k == $ck) { if ($v == $cv) unset($attributes[$k]); break 1; } $options = array(); foreach ($attributes as $k => $v) if (in_array($k, $auto_increment_pks)) { $options["hard_coded_ai_pk"] = true; break; } if ($attributes && $conditions && $DBDriver->updateObject($table, $attributes, $conditions, $options)) $status = true; break; case "delete": if ($conditions && $DBDriver->deleteObject($table, $conditions)) $status = true; break; case "get": if ($conditions) { $results = $DBDriver->findObjects($table, null, $conditions); $status = json_encode($results[0] ? $results[0] : array()); } break; } } } } } echo $status; die(); ?>
