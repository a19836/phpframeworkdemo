<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.workflow.WorkFlowTaskHandler"); include_once get_lib("org.phpframework.util.HashTagParameter"); include_once get_lib("org.phpframework.phpscript.PHPUICodeExpressionHandler"); include_once $EVC->getModulePath("user/UserUtil", $EVC->getCommonProjectName()); class SequentialLogicalActivitiesCodeConverter { public static function convertActionsSettingsToCode($v08d9602741, $v4bf8d90f04, $pfce4d1b3, $pae434d3a) { if (is_array($pae434d3a)) { $v64e98269be = array("createform", "callbusinesslogic", "callibatisquery", "callhibernatemethod", "getquerydata", "setquerydata", "callfunction", "callobjectmethod", "restconnector", "soapconnector"); $pecad7cca = new WorkFlowTaskHandler($v4bf8d90f04, $pfce4d1b3); $pecad7cca->setCacheRootPath(LAYER_CACHE_PATH); $pecad7cca->setAllowedTaskTags($v64e98269be); $pecad7cca->initWorkFlowTasks(); MyArray::arrKeysToLowerCase($pae434d3a, true); $v8028e240bf = array(); $pae434d3a = self::replaceEscapedVariables($pae434d3a); $v2467181342 = self::getActionsCode($v08d9602741, $pecad7cca, $pae434d3a, '$results', $v8028e240bf); if ($v2467181342) { $v8028e240bf = $v8028e240bf ? '$common_project_name = $EVC->getCommonProjectName();' . "\n" . implode("\n", array_unique($v8028e240bf)) . "\n" : ""; $v115af03abc = "\n" . '$results = array();' . "\n"; $v067674f4e4 = "<?php\n"; $v067674f4e4 .= $v8028e240bf . $v115af03abc . $v2467181342; $v067674f4e4 .= "\n?>"; return $v067674f4e4; } } } public static function getIfCode($pbb2163ef, $v84e76dfbbc, $v05aacc214d) { $v067674f4e4 = ""; if ($pbb2163ef) { $pbb2163ef = strtolower($pbb2163ef); $pfa8465c8 = strpos($pbb2163ef, "_not_") !== false; switch($pbb2163ef) { case "execute_if_var": case "execute_if_not_var": $v847e7d0a83 = trim($v84e76dfbbc); if (!empty($v847e7d0a83)) { $v847e7d0a83 = substr($v847e7d0a83, 0, 1) == '$' ? $v847e7d0a83 : '$' . $v847e7d0a83; $v067674f4e4 = ($pfa8465c8 ? "!" : "") . $v847e7d0a83; } break; case "execute_if_post_button": case "execute_if_not_post_button": case "execute_if_get_button": case "execute_if_not_get_button": $v3ad42a02b0 = trim($v84e76dfbbc); if ($v3ad42a02b0) $v3ad42a02b0 = self::prepareStringValue($v3ad42a02b0); $v067674f4e4 = ($pfa8465c8 ? "!" : "") . (strpos($pbb2163ef, "_get_") !== false ? '$_GET' : '$_POST') . '[' . $v3ad42a02b0 . ']'; break; case "execute_if_previous_action": case "execute_if_not_previous_action": $v067674f4e4 = $v05aacc214d . '[count(' . $v05aacc214d . ') - 1]'; if ($pfa8465c8) $v067674f4e4 = "empty($v067674f4e4)"; break; case "execute_if_condition": case "execute_if_not_condition": case "execute_if_code": case "execute_if_not_code": if (is_numeric($v84e76dfbbc)) $v067674f4e4 = $pfa8465c8 ? "empty($v84e76dfbbc)" : $v84e76dfbbc; else if ($v84e76dfbbc === true) $v067674f4e4 = $pfa8465c8 ? "false" : "true"; else if ($v84e76dfbbc === false) $v067674f4e4 = $pfa8465c8 ? "true" : "false"; else if (is_array($v84e76dfbbc) || is_object($v84e76dfbbc)) $v067674f4e4 = $pfa8465c8 ? (empty($v84e76dfbbc) ? "false" : "true") : (empty($v84e76dfbbc) ? "true" : "false"); else if (!empty($v84e76dfbbc)) $v067674f4e4 = $pfa8465c8 ? "empty($v84e76dfbbc)" : $v84e76dfbbc; break; } $v067674f4e4 = $v067674f4e4 ? "if ($v067674f4e4) {" : ""; } return $v067674f4e4; } public static function getActionsCode($v08d9602741, $pecad7cca, $v55bd236ac1, $v05aacc214d, &$v8028e240bf, $pdcf670f6 = "") { $v067674f4e4 = ""; if (is_array($v55bd236ac1)) foreach ($v55bd236ac1 as $pd69fb7d0 => $peeff7b55) $v067674f4e4 .= self::getActionCode($v08d9602741, $pecad7cca, $peeff7b55, $v05aacc214d, $v8028e240bf, $pdcf670f6); return $v067674f4e4; } public static function getActionCode($v08d9602741, $pecad7cca, $peeff7b55, $v05aacc214d, &$v8028e240bf, $pdcf670f6 = "") { $v067674f4e4 = ""; $v0d39e09d41 = trim($peeff7b55["result_var_name"]); $v256e3a39a7 = strtolower($peeff7b55["action_type"]); $pcf8113cc = $peeff7b55["action_value"]; $pbb2163ef = strtolower($peeff7b55["condition_type"]); $v84e76dfbbc = $peeff7b55["condition_value"]; $pb84fa2b6 = ""; if ($v0d39e09d41) $pb84fa2b6 = $v05aacc214d . "[" . self::prepareStringValue($v0d39e09d41) . "] = "; $v11615effa5 = self::getIfCode($pbb2163ef, $v84e76dfbbc, $v05aacc214d); if ($v11615effa5) $pdcf670f6 .= "\t"; switch ($v256e3a39a7) { case "html": $v7f5911d32d = $pecad7cca->getTasksByTag("createform"); $v7f5911d32d = $v7f5911d32d[0]; $v7f5911d32d["properties"] = array( "form_settings_data_type" => $pcf8113cc["form_settings_data_type"], "form_settings_data" => $pcf8113cc["form_settings_data"], "form_input_data_type" => '', "form_input_data" => '$results', ); $v7f5911d32d["obj"]->data = $v7f5911d32d; $v575c44b71f = trim($v7f5911d32d["obj"]->printCode(null, null)); if ($v575c44b71f) { $v8028e240bf[] = 'include_once get_lib("org.phpframework.util.web.html.HtmlFormHandler");'; $v067674f4e4 .= $pdcf670f6 . ($pb84fa2b6 ? $pb84fa2b6 : "echo ") . str_replace("\n", "\n$pdcf670f6", $v575c44b71f) . "\n"; } break; case "callbusinesslogic": case "callibatisquery": case "callhibernatemethod": case "getquerydata": case "setquerydata": case "callfunction": case "callobjectmethod": case "restconnector": case "soapconnector": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pcf8113cc = self::searchParametersForVariablesWithWrongType($pcf8113cc); $v7f5911d32d = $pecad7cca->getTasksByTag($v256e3a39a7); $v7f5911d32d = $v7f5911d32d[0]; $v7f5911d32d["properties"] = $pcf8113cc; $v7f5911d32d["obj"]->data = $v7f5911d32d; $v575c44b71f = trim($v7f5911d32d["obj"]->printCode(null, null)); if ($v575c44b71f) $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . str_replace("\n", "\n$pdcf670f6", $v575c44b71f) . "\n"; break; case "insert": case "update": case "delete": case "select": case "procedure": case "getinsertedid": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); if ($pcf8113cc["options_type"] == "array") { $v5d3813882f = is_array($pcf8113cc["options"]) ? $pcf8113cc["options"] : array(); if ($pcf8113cc["db_driver"]) $v5d3813882f["db_driver"] = array( "key" => "db_driver", "key_type" => "string", "value" => $pcf8113cc["db_driver"], "value_type" => "string", ); $v067674f4e4 .= $pdcf670f6 . '$options = ' . trim(WorkFlowTask::getArrayString($v5d3813882f, $pdcf670f6)) . ';' . "\n"; } else if ($pcf8113cc["options_type"] == "variable") { $v067674f4e4 .= $pdcf670f6 . '$options = ' . PHPUICodeExpressionHandler::getArgumentCode($pcf8113cc["options"], $pcf8113cc["options_type"]) . ';' . "\n"; if ($pcf8113cc["db_driver"]) $v067674f4e4 .= $pdcf670f6 . '$options["db_driver"] = ' . PHPUICodeExpressionHandler::getArgumentCode($pcf8113cc["db_driver"], "string") . ';' . "\n"; } else if ($pcf8113cc["options"] && $pcf8113cc["db_driver"]) $v067674f4e4 .= $pdcf670f6 . '$options = array("db_driver" => ' . self::prepareStringValue($pcf8113cc["db_driver"]) . ');' . "\n"; else $v067674f4e4 .= $pdcf670f6 . '$options = array();' . "\n"; $pd922c2f7 = '$EVC->getBroker(' . self::prepareStringValue($pcf8113cc["dal_broker"]) . ')'; if ($v256e3a39a7 == "getinsertedid") $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . $pd922c2f7 . '->getInsertedId($options);' . "\n"; else { $v3c76382d93 = $pcf8113cc["sql"]; if ($pcf8113cc["table"] && $v256e3a39a7 != "procedure") { $v539082ff30 = array( "type" => $v256e3a39a7, "main_table" => $pcf8113cc["table"], "attributes" => $pcf8113cc["attributes"], "conditions" => $pcf8113cc["conditions"], ); $v067674f4e4 .= $pdcf670f6 . '$sql_data = ' . trim(var_export($v539082ff30, true)) . ';' . "\n"; $v067674f4e4 .= $pdcf670f6 . '$sql = ' . $pd922c2f7 . '->getFunction("convertObjectToSQL", array($sql_data), $options);' . "\n"; } if ($v256e3a39a7 == "select" || $v256e3a39a7 == "procedure") { $v067674f4e4 .= $pdcf670f6 . 'unset($options["return_type"]); //just in case if it exists' . "\n"; $v067674f4e4 .= $pdcf670f6 . '$result = ' . $pd922c2f7 . '->getData($sql, $options);' . "\n"; $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . '$result["result"];' . "\n"; } else $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . $pd922c2f7 . '->setData($sql, $options);' . "\n"; } break; case "show_ok_msg": case "show_ok_msg_and_stop": case "show_ok_msg_and_die": case "show_ok_msg_and_redirect": case "show_error_msg": case "show_error_msg_and_stop": case "show_error_msg_and_die": case "show_error_msg_and_redirect": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pffa799aa = $pcf8113cc["message"]; $v23dcb71e04 = strpos($v256e3a39a7, "_ok_") ? $pffa799aa : null; $pef612b9d = strpos($v256e3a39a7, "_error_") ? $pffa799aa : null; $v959a588da6 = strpos($v256e3a39a7, "_redirect") ? $pcf8113cc["redirect_url"] : null; $v8028e240bf[] = 'include_once $EVC->getModulePath("common/CommonModuleUI", $common_project_name);'; echo "ok_message:$v23dcb71e04\nerror_message:$pef612b9d\nredirect_url:$v959a588da6\n"; $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . '\CommonModuleUI::getModuleMessagesHtml($EVC, ' . self::prepareStringValue($v23dcb71e04) . ', ' . self::prepareStringValue($pef612b9d) . ', ' . self::prepareStringValue($v959a588da6) . ');' . "\n"; if (strpos($v256e3a39a7, "_die")) $v067674f4e4 .= $pdcf670f6 . "die();\n"; else if (strpos($v256e3a39a7, "_stop")) $v067674f4e4 .= $pdcf670f6 . "return;\n"; break; case "alert_msg": case "alert_msg_and_stop": case "alert_msg_and_redirect": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pffa799aa = $pcf8113cc["message"]; $v959a588da6 = strpos($v256e3a39a7, "_redirect") ? $pcf8113cc["redirect_url"] : null; $v067674f4e4 .= $pdcf670f6 . 'echo \'<script>' . ($pffa799aa ? addcslashes('alert("' . addcslashes($pffa799aa, '"') . '");', "'") : '') . ($v959a588da6 ? addcslashes('document.location="' . addcslashes($v959a588da6, '"') . '";', "'") : '') . '</script>\';' . "\n"; if (strpos($v256e3a39a7, "_stop")) $v067674f4e4 .= "return;\n"; break; case "redirect": $v067674f4e4 .= $pdcf670f6 . ($pb84fa2b6 ? $pb84fa2b6 : "echo ") . '\'<script>document.location="' . addcslashes($pcf8113cc, '"') . '";</script>\';' . "\n"; break; case "return_previous_record": case "return_next_record": case "return_specific_record": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pe27a6344 = trim($pcf8113cc["records_variable_name"]); $pe75dcf6f = trim($pcf8113cc["index_variable_name"]); if (substr($pe27a6344, 0, 1) == '$') $v067674f4e4 .= $pdcf670f6 . '$records = ' . $pe27a6344 . ';' . "\n"; else $v067674f4e4 .= $pdcf670f6 . '$records = $results[' . self::prepareStringValue($pe27a6344) . '];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . 'if (is_array($records)) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$index = ' . self::prepareStringValue($pe75dcf6f) . ";\n"; $v067674f4e4 .= $pdcf670f6 . '	$index = $index && !is_numeric($index) && is_string($index) ? $_GET[$index] : $index;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$index = is_numeric($index) ? $index : 0;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; if ($v256e3a39a7 == "return_previous_record") $v067674f4e4 .= $pdcf670f6 . '	$index--;'. "\n"; else if ($v256e3a39a7 == "return_next_record") $v067674f4e4 .= $pdcf670f6 . '	$index++;'. "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . "\t" . $pb84fa2b6 . '$records[$index];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "}\n"; break; case "check_logged_user_permissions": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pe201cb4b = !empty($pcf8113cc["all_permissions_checked"]); $pa929f3e8 = $pcf8113cc["users_perms"]; $pa11cdd5f = trim($pcf8113cc["entity_path_var_name"]) ? trim($pcf8113cc["entity_path_var_name"]) : '$entity_path'; $pa11cdd5f = (substr($pa11cdd5f, 0, 1) != '$' ? '$' : '') . $pa11cdd5f; $v93dda00907 = $pa11cdd5f; $pe569ae33 = $pcf8113cc["logged_user_id"]; if ($pa929f3e8) { $v90a8c6325d = false; $pabd24755 = array(); foreach ($pa929f3e8 as $v74b37bf978) if ($v74b37bf978["user_type_id"] == \UserUtil::PUBLIC_USER_TYPE_ID) { $v90a8c6325d = true; break; } else $pabd24755[] = $v74b37bf978; if (!$v90a8c6325d || $pe201cb4b) { if ($pe569ae33 && $pabd24755 && $v93dda00907) { $pa929f3e8 = $pabd24755; $v8028e240bf[] = 'include_once $EVC->getModulePath("object/ObjectUtil", $common_project_name);'; $v8028e240bf[] = 'include_once $EVC->getModulePath("user/UserUtil", $common_project_name);'; $v067674f4e4 .= $pdcf670f6 . '$logged_user_id = ' . self::prepareStringValue($pe569ae33) . ';' . "\n"; $v067674f4e4 .= $pdcf670f6 . '$object_id = str_replace(APP_PATH, "", ' . self::prepareStringValue($v93dda00907) . ');' . "\n"; $v067674f4e4 .= $pdcf670f6 . '$user_has_permission = false;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . 'if ($logged_user_id && $object_id) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$user_has_permission = true;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$object_type_id = \ObjectUtil::PAGE_OBJECT_TYPE_ID;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$object_id = \HashCode::getHashCodePositive($object_id);' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$brokers = $EVC->getBrokers();' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$utaos = \UserUtil::getUserTypeActivityObjectsByUserIdAndConditions($brokers, $logged_user_id, array("object_type_id" => $object_type_id, "object_id" => $object_id), null);' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '	if ($utaos) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		$entered = false;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '		$users_perms = ' . trim(WorkFlowTask::getArrayString($pa929f3e8, "$pdcf670f6\t\t")) . ';' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		$all_permissions_checked = ' . ($pe201cb4b ? "true" : "false") . ';' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '		foreach ($users_perms as $user_perm) ' . "\n"; $v067674f4e4 .= $pdcf670f6 . '			if (is_numeric($user_perm["user_type_id"]) && is_numeric($user_perm["activity_id"])) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				if (!$entered && !$all_permissions_checked) //only happens on the first iteration and if $all_permissions_checked is false' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					$user_has_permission = false;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '				$entered = true;' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '				$user_perm_exists = false;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				foreach ($utaos as $utao)' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					if ($utao["user_type_id"] == $user_perm["user_type_id"] && $utao["activity_id"] == $user_perm["activity_id"]) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '						$user_perm_exists = true;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '						break;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					}' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '				if ($all_permissions_checked && !$user_perm_exists) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					$user_has_permission = false;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					break;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				}' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				else if (!$all_permissions_checked && $user_perm_exists) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					$user_has_permission = true;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					break;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				}' . "\n"; $v067674f4e4 .= $pdcf670f6 . '			}' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	}' . "\n"; $v067674f4e4 .= $pdcf670f6 . '}' . "\n"; if ($pb84fa2b6) $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . '$user_has_permission;' . "\n"; } } } break; case "code": $pcf8113cc = trim($pcf8113cc); if ($pcf8113cc) { if ($pb84fa2b6) $v067674f4e4 .= $pdcf670f6 . "ob_start();\n"; $v7e4b517c18 = 0; do { $pbd1bc7b0 = strpos($pcf8113cc, "<?", $v7e4b517c18); if ($pbd1bc7b0 !== false) { $pf8ed4912 = substr($pcf8113cc, $v7e4b517c18, $pbd1bc7b0 - $v7e4b517c18); if ($pf8ed4912) $pf8ed4912 = $pdcf670f6 . 'echo ' . PHPUICodeExpressionHandler::getArgumentCode($pf8ed4912, "string") . ";\n"; $pbd1bc7b0 += substr($pcf8113cc, $pbd1bc7b0, 5) == "<?php" ? 5 : 2; $v27e200bd34 = strpos($pcf8113cc, "?>", $pbd1bc7b0); $v27e200bd34 = $v27e200bd34 !== false ? $v27e200bd34 : strlen($pcf8113cc); $v765b0fcf87 = substr($pcf8113cc, $pbd1bc7b0, $v27e200bd34 - $pbd1bc7b0); $v765b0fcf87 = $v765b0fcf87 ? $pdcf670f6 . str_replace("\n", "\n$pdcf670f6", trim($v765b0fcf87)) . "\n" : ""; $v067674f4e4 .= $pf8ed4912 . $v765b0fcf87; $v7e4b517c18 = $v27e200bd34 + 2; } } while ($pbd1bc7b0 !== false); $v87bae535e2 = substr($pcf8113cc, $v7e4b517c18); if ($v87bae535e2) $v067674f4e4 .= $pdcf670f6 . 'echo ' . PHPUICodeExpressionHandler::getArgumentCode($v87bae535e2, "string") . ";\n"; if ($pb84fa2b6) { $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . "ob_get_contents();\n"; $v067674f4e4 .= $pdcf670f6 . "ob_end_clean();\n"; } } break; case "string": if ($pb84fa2b6) { $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $pcf8113cc = self::prepareStringValue($pcf8113cc); $v067674f4e4 .= "$pdcf670f6$pb84fa2b6$pcf8113cc;\n"; } break; case "array": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $v7f5911d32d = $pecad7cca->getTasksByTag("createform"); $v7f5911d32d = $v7f5911d32d[0]; $v7f5911d32d["properties"] = array("form_input_data_type" => "array", "form_input_data" => $pcf8113cc); $v7f5911d32d["obj"]->data = $v7f5911d32d; $v575c44b71f = trim($v7f5911d32d["obj"]->printCode(null, null)); $v575c44b71f = substr($v575c44b71f, strlen("HtmlFormHandler::createHtmlForm(null, "), strlen(");") * -1); if ($v575c44b71f) $v067674f4e4 .= "$pdcf670f6$pb84fa2b6" . str_replace("\n", "\n$pdcf670f6", $v575c44b71f) . ";\n"; break; case "variable": case "sanitize_variable": $pcf8113cc = self::replaceActionValuesHashTagWithVariables($pcf8113cc); $v847e7d0a83 = trim($pcf8113cc); if ($v847e7d0a83) { $pff5830e4 = substr($v847e7d0a83, 0, 1); $pf548ad60 = substr($v847e7d0a83, -1); if (($pff5830e4 == '"' && $pf548ad60 == '"') || ($pff5830e4 == "'" && $pf548ad60 == "'")) $v847e7d0a83 = self::prepareStringValue($v847e7d0a83); else if ($pff5830e4 != '$') { $v3fb9f41470 = PHPUICodeExpressionHandler::getValueType($v847e7d0a83, array("non_set_type" => "string", "empty_string_type" => "string")); if ($v3fb9f41470 == "string") $v847e7d0a83 = '$'. $v847e7d0a83; } if ($pb84fa2b6) $v067674f4e4 .= "$pdcf670f6$pb84fa2b6$v847e7d0a83;\n"; } break; case "list_report": $v847e7d0a83 = $pcf8113cc["variable"]; $v847e7d0a83 = self::replaceActionValuesHashTagWithVariables($v847e7d0a83); $v847e7d0a83 = trim($v847e7d0a83); if ($v847e7d0a83) { $pff5830e4 = substr($v847e7d0a83, 0, 1); $pf548ad60 = substr($v847e7d0a83, -1); if (($pff5830e4 == '"' && $pf548ad60 == '"') || ($pff5830e4 == "'" && $pf548ad60 == "'")) $v847e7d0a83 = self::prepareStringValue($v847e7d0a83); else if ($pff5830e4 != '$') { $v3fb9f41470 = PHPUICodeExpressionHandler::getValueType($v847e7d0a83, array("non_set_type" => "string", "empty_string_type" => "string")); if ($v3fb9f41470 == "string") $v847e7d0a83 = '$'. $v847e7d0a83; } $v3fb9f41470 = $pcf8113cc["type"]; $pe86cbe92 = $pcf8113cc["doc_name"]; $v28c1cd997a = $pcf8113cc["continue"]; $v1e71ed36f0 = $v3fb9f41470 == "xls" ? "application/vnd.ms-excel" : "text/plain"; $v067674f4e4 .= $pdcf670f6 . 'header("Content-Type: ' . $v1e71ed36f0 . '");' . "\n"; $v067674f4e4 .= $pdcf670f6 . 'header("Content-Disposition: attachment; filename=\'' . $pe86cbe92 . '.' . $v3fb9f41470 . '\'");' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '$list = ' . $v847e7d0a83 . ';' . "\n"; $v067674f4e4 .= $pdcf670f6 . '$str = "";' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . 'if ($list && is_array($list)) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$first_row = $list[ array_keys($list)[0] ];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "	\n"; $v067674f4e4 .= $pdcf670f6 . '	if (is_array($first_row)) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		$columns = array_keys($first_row);' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		$columns_length = count($columns);' . "\n"; $v067674f4e4 .= $pdcf670f6 . "		\n"; $v067674f4e4 .= $pdcf670f6 . '		//prepare columns' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		for ($i = 0; $i < $columns_length; $i++)' . "\n"; $v067674f4e4 .= $pdcf670f6 . '			$str .= ($i > 0 ? "\t" : "") . $columns[$i];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "		\n"; $v067674f4e4 .= $pdcf670f6 . '		//prepare rows' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		if ($str) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '			$str .= "\n";' . "\n"; $v067674f4e4 .= $pdcf670f6 . "			\n"; $v067674f4e4 .= $pdcf670f6 . '			foreach ($list as $row)' . "\n"; $v067674f4e4 .= $pdcf670f6 . '				if (is_array($row)) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '					for ($i = 0; $i < $columns_length; $i++)' . "\n"; $v067674f4e4 .= $pdcf670f6 . '						$str .= ($i > 0 ? "\t" : "") . $row[ $columns[$i] ];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "					\n"; $v067674f4e4 .= $pdcf670f6 . '					$str .= "\n";' . "\n"; $v067674f4e4 .= $pdcf670f6 . "				}\n"; $v067674f4e4 .= $pdcf670f6 . "		}\n"; $v067674f4e4 .= $pdcf670f6 . "	}\n"; $v067674f4e4 .= $pdcf670f6 . "}\n"; if ($pb84fa2b6) $v067674f4e4 .= "$pdcf670f6$pb84fa2b6" . "\$str;\n"; else $v067674f4e4 .= $pdcf670f6 . "echo \$str;\n"; if ($v28c1cd997a == "die") $v067674f4e4 .= $pdcf670f6 . "die();\n"; else if ($v28c1cd997a == "stop") $v067674f4e4 .= $pdcf670f6 . "return;\n"; } break; case "call_block": $peebaaf55 = trim($pcf8113cc["block"]); $peebaaf55 = self::replaceActionValuesHashTagWithVariables($peebaaf55); if ($peebaaf55) { $v93756c94b3 = trim($pcf8113cc["project"]); $v93756c94b3 = self::replaceActionValuesHashTagWithVariables($v93756c94b3); $v067674f4e4 .= $pdcf670f6 . '$block_local_variables = array();' . "\n"; $v067674f4e4 .= $pdcf670f6 . 'include $EVC->getBlockPath(' . self::prepareStringValue($peebaaf55) . ($v93756c94b3 ? ', ' . self::prepareStringValue($v93756c94b3) : '') . ');' . "\n"; if ($pb84fa2b6) $v067674f4e4 .= "$pdcf670f6$pb84fa2b6" . "\$EVC->getCMSLayer()->getCMSBlockLayer()->getCurrentBlock();\n"; else $v067674f4e4 .= $pdcf670f6 . "echo \$EVC->getCMSLayer()->getCMSBlockLayer()->getCurrentBlock();\n"; } break; case "include_file": $pa32be502 = trim($pcf8113cc["path"]); $pa32be502 = self::replaceActionValuesHashTagWithVariables($pa32be502); if ($pa32be502) { $pa32be502 = self::prepareStringValue($pa32be502); $v4616a9abfd = !empty($pcf8113cc["once"]); $v067674f4e4 .= $pdcf670f6 . ($pb84fa2b6 ? $pb84fa2b6 : "") . 'include' . ($v4616a9abfd ? '_once' : '') . ' ' . $pa32be502 . ";\n"; } break; case "draw_graph": if (is_array($pcf8113cc)) { if (array_key_exists("code", $pcf8113cc)) $v067674f4e4 .= "?>\n" . self::replaceActionValuesHashTagWithVariables($pcf8113cc["code"]) . "\n<?php\n"; else { $v01cdaad323 = self::replaceActionValuesHashTagWithVariables($pcf8113cc["include_graph_library"]); $v607a49cf36 = self::replaceActionValuesHashTagWithVariables($pcf8113cc["width"]); $v3a0455afd7 = self::replaceActionValuesHashTagWithVariables($pcf8113cc["height"]); $v0cbc5d48c8 = self::replaceActionValuesHashTagWithVariables($pcf8113cc["labels_and_values_type"]); $pdfb8dd62 = self::replaceActionValuesHashTagWithVariables($pcf8113cc["labels_variable"]); $peee3e18f = self::prepareStringValue($pdfb8dd62); $pafed3df8 = ''; $v260dc30551 = null; if ($pcf8113cc["data_sets"]) { $pb2a355f5 = $pcf8113cc["data_sets"]; if (isset($pb2a355f5["values_variable"])) $pb2a355f5 = array($pb2a355f5); $v15f3268002 = 1; $pef157974 = array( "values_variable" => "data", "item_label" => "label", "background_colors" => "backgroundColor", "border_colors" => "borderColor", "border_width" => "borderWidth" ); foreach ($pb2a355f5 as $pa5d1f26e) { if ($pa5d1f26e) { $v7d0e1423bc = ''; if (!isset($pa5d1f26e["order"])) $pa5d1f26e["order"] = $v15f3268002; foreach ($pa5d1f26e as $pbfa01ed1 => $v67db1bd535) { $v67db1bd535 = self::replaceActionValuesHashTagWithVariables($v67db1bd535); if ($pbfa01ed1) { $pe1d32923 = $pef157974[$pbfa01ed1] ? $pef157974[$pbfa01ed1] : $pbfa01ed1; $v0ff021f094 = !empty($v67db1bd535) || is_numeric($v67db1bd535) || !isset($pef157974[$pbfa01ed1]); if ($pbfa01ed1 == "type") { if (!$v260dc30551) $v260dc30551 = $v67db1bd535; $v0ff021f094 = $v0ff021f094 && $v67db1bd535 != $v260dc30551; } else if ($pbfa01ed1 == "border_width") $v0ff021f094 = $v0ff021f094 || is_numeric($v67db1bd535); else if ($pbfa01ed1 == "values_variable" && $v0cbc5d48c8 == "associative") { $peee3e18f = self::prepareStringValue($v67db1bd535); $peee3e18f = $v0cbc5d48c8 == "associative" ? 'is_array(' . $peee3e18f . ') ? array_keys(' . $peee3e18f . ') : null' : $peee3e18f; $v0cbc5d48c8 = null; } if ($v0ff021f094) $v7d0e1423bc .= ($v7d0e1423bc ? ",\n              " : "") . $pe1d32923 . ': \' . json_encode(' . self::prepareStringValue($v67db1bd535) . ') . \''; } } $pafed3df8 .= '
		     {
		         ' . $v7d0e1423bc . '
		     },'; $v15f3268002++; } } } $v93ff269092 = rand(0, 1000); $v067674f4e4 .= $pdcf670f6 . 'echo \''; if ($v01cdaad323 == "cdn_even_if_exists") $v067674f4e4 .= '<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>' . "\n\n"; else if ($v01cdaad323 == "cdn_if_not_exists") $v067674f4e4 .= '<script>
	if (typeof Chart != "function")
		document.write("<scr" + "ipt src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js\"></scr" + "ipt>");
	</script>' . "\n\n"; $v067674f4e4 .= '
	<canvas id="my_chart_' . $v93ff269092 . '"' . ($v607a49cf36 || is_numeric($v607a49cf36) ? ' width="\' . ' . self::prepareStringValue($v607a49cf36) . ' . \'"' : '') . ($v3a0455afd7 || is_numeric($v3a0455afd7) ? ' height="\' . ' . self::prepareStringValue($v3a0455afd7) . ' . \'"' : '') . '></canvas>

	<script>
	var ctx = document.getElementById("my_chart_' . $v93ff269092 . '").getContext("2d");
	var myChart = new Chart(ctx, {
	    type: "\' . ' . self::prepareStringValue($v260dc30551) . ' . \'",
	    data: {
		   ' . ($peee3e18f || is_numeric($peee3e18f) ? 'labels: \' . json_encode(' . $peee3e18f . ') . \',' : '') . '
		   datasets: [' . $pafed3df8 . '
		   ]
	    },
	    options: {
		   scales: {
		       yAxes: [{
		           ticks: {
		               beginAtZero: true
		           }
		       }]
		   }
	    }
	});
	</script>\';'; } } break; case "loop": if ($pcf8113cc["actions"]) { if ($pb84fa2b6) $v067674f4e4 .= $pdcf670f6 . "ob_start();\n\n"; $pe27a6344 = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["records_variable_name"])); $v83cf462ef8 = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["records_start_index"])); $pf5ee153c = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["records_end_index"])); $pe0489235 = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["array_item_key_variable_name"])); $v3f883a2957 = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["array_item_value_variable_name"])); if (substr($pe27a6344, 0, 1) == '$') $v067674f4e4 .= $pdcf670f6 . '$records = ' . $pe27a6344 . ';' . "\n"; else $v067674f4e4 .= $pdcf670f6 . '$records = $results[' . self::prepareStringValue($pe27a6344) . '];' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . 'if (is_array($records)) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$records_start_index = ' . self::prepareStringValue($v83cf462ef8) . ";\n"; $v067674f4e4 .= $pdcf670f6 . '	$records_start_index = is_numeric($records_start_index) ? $records_start_index : 0;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$records_end_index = ' . self::prepareStringValue($pf5ee153c) . ";\n"; $v067674f4e4 .= $pdcf670f6 . '	$records_end_index = is_numeric($records_end_index) ? $records_end_index : count($records);' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '	$i = 0;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	foreach ($records as $k => $v) {' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		if ($i >= $records_end_index)' . "\n"; $v067674f4e4 .= $pdcf670f6 . '			break;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '		else if ($i >= $records_start_index) {' . "\n"; if ($pe0489235) $v067674f4e4 .= $pdcf670f6 . '		$' . $pe0489235 . ' = $k;' . "\n"; if ($v3f883a2957) $v067674f4e4 .= $pdcf670f6 . '		$' . $v3f883a2957 . ' = $v;' . "\n"; $v067674f4e4 .= self::getActionsCode($v08d9602741, $pecad7cca, $pcf8113cc["actions"], $v05aacc214d, $v8028e240bf, "$pdcf670f6\t\t"); $v067674f4e4 .= $pdcf670f6 . '		}' . "\n"; $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . '		++$i;' . "\n"; $v067674f4e4 .= $pdcf670f6 . '	}' . "\n"; $v067674f4e4 .= $pdcf670f6 . "}\n"; if ($pb84fa2b6) { $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . "ob_get_contents();\n"; $v067674f4e4 .= $pdcf670f6 . "ob_end_clean();\n"; } } break; case "group": if ($pcf8113cc["actions"]) { if ($pb84fa2b6) $v067674f4e4 .= $pdcf670f6 . "ob_start();\n\n"; $pfc00b2ed = self::replaceActionValuesHashTagWithVariables(trim($pcf8113cc["group_name"])); if ($pfc00b2ed) { $pfc00b2ed = $v05aacc214d . "[" . self::prepareStringValue($pfc00b2ed) . "] = "; $v067674f4e4 .= self::getActionsCode($v08d9602741, $pecad7cca, $pcf8113cc["actions"], $pfc00b2ed, $v8028e240bf, $pdcf670f6); } else $v067674f4e4 .= self::getActionsCode($v08d9602741, $pecad7cca, $pcf8113cc["actions"], $v05aacc214d, $v8028e240bf, $pdcf670f6); if ($pb84fa2b6) { $v067674f4e4 .= $pdcf670f6 . "\n"; $v067674f4e4 .= $pdcf670f6 . $pb84fa2b6 . "ob_get_contents();\n"; $v067674f4e4 .= $pdcf670f6 . "ob_end_clean();\n"; } } break; } if ($v067674f4e4) { $v020036c951 = "/*** ACTION: " . strtoupper($v256e3a39a7) . "***/\n"; $v257df20bcf = $pb84fa2b6 ? "$pdcf670f6" . '$' . $v0d39e09d41 . " = &" . trim(str_replace(" = ", "", $pb84fa2b6)) . ";\n" : ""; $v8ede8ebec6 = $v067674f4e4; $v067674f4e4 = ""; if ($v11615effa5) { $pdcf670f6 = substr($pdcf670f6, 0, -1); $v067674f4e4 .= "\n$pdcf670f6$v020036c951"; $v067674f4e4 .= $pdcf670f6 . $v11615effa5 . "\n"; $v067674f4e4 .= $v8ede8ebec6; $v067674f4e4 .= $v257df20bcf; $v067674f4e4 .= $pdcf670f6 . "}\n"; } else $v067674f4e4 .= "\n$pdcf670f6$v020036c951$v8ede8ebec6$v257df20bcf"; } return $v067674f4e4; } public static function replaceEscapedVariables($v67db1bd535) { if (is_array($v67db1bd535)) foreach ($v67db1bd535 as $pbfa01ed1 => $v342a134247) $v67db1bd535[$pbfa01ed1] = self::replaceEscapedVariables($v342a134247); else if ($v67db1bd535 && is_string($v67db1bd535) && strpos($v67db1bd535, '$') !== false) { $v79b7cb19d1 = $v66327139f0 = false; $padb9778d = true; $pc37695cb = strlen($v67db1bd535); $pa456327a = ""; for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pc288256e = $v67db1bd535[$v43dd7d0051]; if ($pc288256e == "<" && $v67db1bd535[$v43dd7d0051 + 1] == "?" && !$v79b7cb19d1 && !$v66327139f0) $padb9778d = true; else if ($pc288256e == "?" && $v67db1bd535[$v43dd7d0051 + 1] == ">" && !$v79b7cb19d1 && !$v66327139f0) $padb9778d = false; else if ($pc288256e == '"' && $padb9778d && !$v66327139f0 && !TextSanitizer::isCharEscaped($v67db1bd535, $v43dd7d0051)) $v79b7cb19d1 = !$v79b7cb19d1; else if ($pc288256e == "'" && $padb9778d && !$v79b7cb19d1 && !TextSanitizer::isCharEscaped($v67db1bd535, $v43dd7d0051)) $v66327139f0 = !$v66327139f0; else if ($pc288256e == '$' && ($v67db1bd535[$v43dd7d0051 + 1] == "{" || preg_match("/\w/u", $v67db1bd535[$v43dd7d0051 + 1])) && $padb9778d && TextSanitizer::isCharEscaped($v67db1bd535, $v43dd7d0051)) $pa456327a = substr($pa456327a, 0, -1); $pa456327a .= $pc288256e; } $v67db1bd535 = $pa456327a; } return $v67db1bd535; } public static function replaceActionValuesHashTagWithVariables($v67db1bd535) { if (is_array($v67db1bd535)) foreach ($v67db1bd535 as $pbfa01ed1 => $v342a134247) $v67db1bd535[$pbfa01ed1] = self::replaceActionValuesHashTagWithVariables($v342a134247); else if ($v67db1bd535 && is_string($v67db1bd535) && strpos($v67db1bd535, "#") !== false) { $v5f7147fb39 = HashTagParameter::HTML_HASH_TAG_PARAMETER_FULL_REGEX; preg_match_all($v5f7147fb39, $v67db1bd535, $pbae7526c, PREG_OFFSET_CAPTURE); if ($pbae7526c[1]) { $v8625b218a4 = array("_POST", "_GET", "_GLOBALS", "_ENV"); $pc37695cb = count($pbae7526c[1]); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v6107abf109 = $pbae7526c[1][$v43dd7d0051][0]; $v91a962d917 = ""; $v75914b9861 = false; foreach ($v8625b218a4 as $pf4cc2238) if (stripos($v6107abf109, $pf4cc2238) === 0) { $v75914b9861 = true; break; } if (strpos($v6107abf109, "[") !== false) { preg_match_all("/([^\[\]]+)/u", trim($v6107abf109), $pcd395670, PREG_PATTERN_ORDER); $pcd395670 = $pcd395670[1]; if ($pcd395670) { if ($v75914b9861) $pf4cc2238 = array_shift($pcd395670); $pd28479e5 = count($pcd395670); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) $pcd395670[$v9d27441e80] = self::prepareStringValue($pcd395670[$v9d27441e80]); $v91a962d917 = ($v75914b9861 ? '$' . strtoupper($pf4cc2238) : '$results') . '[' . implode('][', $pcd395670) . ']'; } } else if ($v75914b9861) $v91a962d917 = '$' . $v6107abf109; else $v91a962d917 = '$results["' . $v6107abf109 . '"]'; if ($v91a962d917) $v67db1bd535 = str_replace("#$v6107abf109#", $v91a962d917, $v67db1bd535); } } } return $v67db1bd535; } public static function searchParametersForVariablesWithWrongType($v67db1bd535) { if (is_array($v67db1bd535)) foreach ($v67db1bd535 as $pbfa01ed1 => $v342a134247) if (is_string($v342a134247) && array_key_exists($pbfa01ed1 . "_type", $v67db1bd535) && $v67db1bd535[$pbfa01ed1 . "_type"] == "string" && PHPUICodeExpressionHandler::isSimpleVariable($v342a134247)) $v67db1bd535[$pbfa01ed1 . "_type"] = ""; else if (is_array($v342a134247)) $v67db1bd535[$pbfa01ed1] = self::searchParametersForVariablesWithWrongType($v342a134247); return $v67db1bd535; } public static function prepareStringValue($v67db1bd535) { if ($v67db1bd535 && substr($v67db1bd535, 0, 2) == '\\$' && PHPUICodeExpressionHandler::isSimpleVariable(substr($v67db1bd535, 1))) return substr($v67db1bd535, 1); $v3fb9f41470 = PHPUICodeExpressionHandler::getValueType($v67db1bd535, array("non_set_type" => "string", "empty_string_type" => "string")); return PHPUICodeExpressionHandler::getArgumentCode($v67db1bd535, $v3fb9f41470); } } ?>
