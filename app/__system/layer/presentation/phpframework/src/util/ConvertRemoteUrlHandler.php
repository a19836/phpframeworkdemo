<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
include_once get_lib("org.phpframework.util.MimeTypeHandler"); include_once get_lib("org.phpframework.util.PathHandler"); class ConvertRemoteUrlHandler { public static function saveHtmlRelativeUrls($ped275ca3, $v6f3a2700dd, &$pf8ed4912, $v00e61544cd) { $v5c1c342594 = true; $pbae7526c = self::getHtmlUrls($pf8ed4912); $v00e61544cd = preg_replace("|/+$|", "", $v00e61544cd); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pa7f15786 = MimeTypeHandler::getAvailableFileExtensions("image"); $v1fcdf76e5d = $pa7f15786; $v1fcdf76e5d[] = "css"; $v1fcdf76e5d[] = "js"; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $pa32be502 = $v9a9206776d["path"]; $v6bfcc44e7b = strtolower(pathinfo($pa32be502, PATHINFO_EXTENSION)); if (in_array($v6bfcc44e7b, $v1fcdf76e5d)) { $v29abce7ca5 = substr($pdeee6a59, 0, 7) == "file://"; $pae77d38c = $v1e71ed36f0 = null; if ($v29abce7ca5) { $v9a84a79e2e = substr($pdeee6a59, 7); if (file_exists($v9a84a79e2e)) { $pae77d38c = file_get_contents($v9a84a79e2e); $v1e71ed36f0 = mime_content_type($v9a84a79e2e); } } else { $v30857f7eca = array( "url" => $pdeee6a59, "settings" => array( "connection_timeout" => 60, "follow_location" => 1, "referer" => $_SERVER["HTTP_REFERER"], "CURLOPT_USERAGENT" => $_SERVER["HTTP_USER_AGENT"] ) ); $v56a64ecb97 = new MyCurl(); $v56a64ecb97->initSingle($v30857f7eca); $v56a64ecb97->get_contents(); $v539082ff30 = $v56a64ecb97->getData(); $pae77d38c = $v539082ff30[0]["content"]; $v1e71ed36f0 = strtolower($v539082ff30[0]["info"]["content_type"]); } $v446afd1219 = true; if (in_array($v6bfcc44e7b, $pa7f15786)) $v446afd1219 = MimeTypeHandler::isImageMimeType($v1e71ed36f0); if ($v446afd1219) { $pb12450da = $pa32be502; $pf3dc0762 = PathHandler::getAbsolutePath($ped275ca3 . $pb12450da); $v57c9111d47 = dirname($pf3dc0762) . "/"; if (!is_dir($v57c9111d47)) mkdir($v57c9111d47, 0755, true); if (!is_dir($v57c9111d47) || file_put_contents($pf3dc0762, $pae77d38c) === false) $v5c1c342594 = false; else { $v17269bc5bf = $v00e61544cd . (substr($pb12450da, 0, 1) == "/" ? "" : "/") . $pb12450da; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } } } return $v5c1c342594; } public static function getUrlHtml($v6f3a2700dd, &$pb3127e21 = null) { $v29abce7ca5 = substr($v6f3a2700dd, 0, 7) == "file://"; $pf8ed4912 = null; if ($v29abce7ca5) { $v9a84a79e2e = substr($v6f3a2700dd, 7); $pf8ed4912 = file_exists($v9a84a79e2e) ? file_get_contents($v9a84a79e2e) : ""; } else { $v30857f7eca = array( "url" => $v6f3a2700dd, "settings" => array( "connection_timeout" => 60, "follow_location" => 1, "referer" => $_SERVER["HTTP_REFERER"], "CURLOPT_USERAGENT" => $_SERVER["HTTP_USER_AGENT"] ) ); $v56a64ecb97 = new MyCurl(); $v56a64ecb97->initSingle($v30857f7eca); $v56a64ecb97->get_contents(); $v539082ff30 = $v56a64ecb97->getData(); $pf8ed4912 = $v539082ff30[0]["content"]; $v6f3a2700dd = $v539082ff30[0]["info"]["url"] ? $v539082ff30[0]["info"]["url"] : $v6f3a2700dd; } if ($pf8ed4912) $pf8ed4912 = self::prepareHtmlRelativeUrls($v6f3a2700dd, $pf8ed4912); $pb3127e21 = $v6f3a2700dd; return $pf8ed4912; } public static function replaceLocalUrlsInHtml($v6f3a2700dd, &$pf8ed4912) { $pbae7526c = self::getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $v17269bc5bf = $v9a9206776d["path"]; $v17269bc5bf = substr($v17269bc5bf, 0, 1) == "/" ? substr($v17269bc5bf, 1) : $v17269bc5bf; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } public static function replaceExtraUrlsInHtml($v6f3a2700dd, &$pf8ed4912) { $pbae7526c = self::getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $pda386b6b = parse_url($v6f3a2700dd); foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) { $v9a9206776d = parse_url($pdeee6a59); if ($v9a9206776d["host"] == $pda386b6b["host"]) { $v17269bc5bf = '#'; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } } } public static function prepareHtmlRelativeUrls($v6f3a2700dd, $pf8ed4912) { $pbae7526c = self::getHtmlUrls($pf8ed4912); if ($pbae7526c) { $v5ed3bcae90 = $pbae7526c[2]; if ($v5ed3bcae90) { $pfc92c039 = $pbae7526c[0]; $v22aff0eaaf = (!preg_match("/^(http:\/\/|https:\/\/|\/\/)/i", $v6f3a2700dd) ? "http://" : "") . $v6f3a2700dd; $pda386b6b = parse_url($v22aff0eaaf); $pd5349300 = ($pda386b6b["scheme"] ? $pda386b6b["scheme"] . "://" : "//") . ($pda386b6b["user"] ? $pda386b6b["user"] . ($pda386b6b["pass"] ? ":" . $pda386b6b["pass"] : "") . "@" : "") . $pda386b6b["host"] . ($pda386b6b["port"] ? ":" . $pda386b6b["port"] : ""); $v22aff0eaaf = $pd5349300 . ( pathinfo($pda386b6b["path"], PATHINFO_EXTENSION) ? ( dirname($pda386b6b["path"]) != "." ? dirname($pda386b6b["path"]) : "" ) : $pda386b6b["path"] ); $v22aff0eaaf .= substr($v22aff0eaaf, -1) != "/" ? "/" : ""; $pd5349300 .= substr($pd5349300, -1) != "/" ? "/" : ""; foreach ($v5ed3bcae90 as $pd69fb7d0 => $pdeee6a59) if (!preg_match("/^(http:\/\/|https:\/\/|\/\/)/i", trim($pdeee6a59))) { $v17269bc5bf = trim($pdeee6a59); $v17269bc5bf = $v17269bc5bf[0] == "/" ? $pd5349300 . substr($v17269bc5bf, 1) : $v22aff0eaaf . $v17269bc5bf; $v91a962d917 = str_replace($pdeee6a59, $v17269bc5bf, $pfc92c039[$pd69fb7d0]); $pf8ed4912 = str_replace($pfc92c039[$pd69fb7d0], $v91a962d917, $pf8ed4912); } } } return $pf8ed4912; } public static function getHtmlUrls($pf8ed4912) { preg_match_all('/\s*(href|src|srcset)\s*=\s*"([^"]*)"/iu', $pf8ed4912, $pb7f9502b, PREG_PATTERN_ORDER); preg_match_all("/\s*(href|src|srcset)\s*=\s*'([^']*)'/iu", $pf8ed4912, $v01929c58f3, PREG_PATTERN_ORDER); $pbae7526c = $pb7f9502b; if ($v01929c58f3) foreach ($v01929c58f3 as $pd69fb7d0 => $v6107abf109) if (is_array($v6107abf109)) { if (!is_array($pbae7526c[$pd69fb7d0])) $pbae7526c[$pd69fb7d0] = array(); $pbae7526c[$pd69fb7d0] = array_merge($pbae7526c[$pd69fb7d0], $v6107abf109); } return $pbae7526c; } } ?>
