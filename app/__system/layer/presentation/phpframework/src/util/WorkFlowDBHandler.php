<?php
/*
 * Copyright (c) 2024 Bloxtor - http://bloxtor.com
 * 
 * Please note that this code belongs to the Bloxtor framework and must comply with the Bloxtor license.
 * If you do not accept these provisions, or if the Bloxtor License is not present or cannot be found, you are not entitled to use this code and must stop and delete it immediately.
 */
include_once $EVC->getUtilPath("WorkFlowTasksFileHandler"); include_once $EVC->getUtilPath("WorkFlowBeansConverter"); include_once $EVC->getUtilPath("PHPVariablesFileHandler"); include_once $EVC->getUtilPath("WorkFlowBeansFileHandler"); include_once get_lib("org.phpframework.db.DB"); class WorkFlowDBHandler { private $v3d55458bcd; private $v5039a77f9d; private $v0f9512fda4; const TASK_TABLE_TYPE = "02466a6d"; const TASK_TABLE_TAG = "table"; public function __construct($v5039a77f9d, $v3d55458bcd) { $this->v5039a77f9d = $v5039a77f9d; $this->v3d55458bcd = $v3d55458bcd; } public function getError() { return $this->v0f9512fda4; } public static function getTablesConnectionTypes() { return array( "One To One" => "1-1", "One To Many" => "1-*", "Many To One" => "*-1", "Many To Many" => "*-*", ); } public function areTasksDBDriverSettingsValid($v5e053dece2, $v99ccd215e5, $v08be7fc6fe = true, &$pb5834e2b = null) { $v5c1c342594 = true; $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getTasksByLayerTag("dbdriver"); foreach ($v1d696dbd12 as $v7f5911d32d) if (!$v08be7fc6fe || $v7f5911d32d["properties"]["active"]) { if (!$this->isTaskDBDriverSettingsValid($v7f5911d32d, $v99ccd215e5, $v08be7fc6fe)) { $v5c1c342594 = false; $pb5834e2b = $v7f5911d32d["label"]; break; } } return $v5c1c342594; } public function isTaskDBDriverSettingsValid($v7f5911d32d, $v99ccd215e5, $v08be7fc6fe = true) { $v5c1c342594 = false; $pfc8be585 = WorkFlowTasksFileHandler::getTaskLayerTags(); if ($v7f5911d32d && $v7f5911d32d["tag"] == $pfc8be585["dbdriver"] && (!$v08be7fc6fe || $v7f5911d32d["properties"]["active"])) return $this->isDBDriverSettingsValid($v7f5911d32d["properties"], $v99ccd215e5); return $v5c1c342594; } public function isDBDriverSettingsValid($v30857f7eca, $v99ccd215e5) { $v5c1c342594 = false; if ($v30857f7eca && $v30857f7eca["type"]) { $pc40b8a19 = $GLOBALS["GlobalErrorHandler"]->ok(); $v44a3bea0b6 = false; try { $pfaf08f23 = new PHPVariablesFileHandler($this->v3d55458bcd); $pfaf08f23->startUserGlobalVariables(); $v87e4fe1181 = DB::createDriverByType($v30857f7eca["type"]); if ($v87e4fe1181) { foreach($v30857f7eca as $v70bf7fcfbb => $pea464301) { if (substr(trim($pea464301), 0, 1) == '$') { $pe6d3dab4 = substr(trim($pea464301), 1); if ($pe6d3dab4) $v30857f7eca[$v70bf7fcfbb] = $GLOBALS[$pe6d3dab4]; } } $v87e4fe1181->setOptions($v30857f7eca); try { $v5c1c342594 = @$v87e4fe1181->connect(); } catch (Exception $paec2c009) { $v44a3bea0b6 = true; } if (!$v5c1c342594 && $v99ccd215e5) { try { $v5d3813882f = $v87e4fe1181->getOptions(); $v5c1c342594 = @$v87e4fe1181->createDB($v5d3813882f["db_name"]) && @$v87e4fe1181->connect(); } catch (Exception $paec2c009) { $v44a3bea0b6 = true; } } } $pfaf08f23->endUserGlobalVariables(); } catch (Exception $paec2c009) { $v44a3bea0b6 = true; } if ($v44a3bea0b6 && $paec2c009) { debug_log($paec2c009, "exception"); $this->v0f9512fda4 = $paec2c009->getMessage(); } if ($v44a3bea0b6 && $pc40b8a19 && !$GLOBALS["GlobalErrorHandler"]->ok()) $GLOBALS["GlobalErrorHandler"]->start(); } return $v5c1c342594; } public function areTasksDBDriverBeanValid($v5e053dece2, $v99ccd215e5, $v08be7fc6fe = true, &$pb5834e2b = null) { $v5c1c342594 = true; $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getTasksByLayerTag("dbdriver"); foreach ($v1d696dbd12 as $v7f5911d32d) if (!$v08be7fc6fe || $v7f5911d32d["properties"]["active"]) { if (!$this->isTaskDBDriverBeanValid($v7f5911d32d, $v99ccd215e5, $v08be7fc6fe)) { $v5c1c342594 = false; $pb5834e2b = $v7f5911d32d["label"]; break; } } return $v5c1c342594; } public function isTaskDBDriverBeanValid($v7f5911d32d, $v99ccd215e5, $v08be7fc6fe = true) { $v5c1c342594 = false; $pfc8be585 = WorkFlowTasksFileHandler::getTaskLayerTags(); if ($v7f5911d32d && $v7f5911d32d["tag"] == $pfc8be585["dbdriver"] && (!$v08be7fc6fe || $v7f5911d32d["properties"]["active"])) { $v6491a7e70b = WorkFlowBeansConverter::getFileNameFromRawLabel($v7f5911d32d["label"]) . "_dbdriver.xml"; $v4948cc5869 = $this->getBeanObject($v6491a7e70b, $v7f5911d32d["label"]); if ($v4948cc5869) { $pc40b8a19 = $GLOBALS["GlobalErrorHandler"]->ok(); $v44a3bea0b6 = false; try { $v5c1c342594 = @$v4948cc5869->connect(); } catch (Exception $paec2c009) { $v44a3bea0b6 = true; } if (!$v5c1c342594 && $v99ccd215e5) { try { $v5d3813882f = $v4948cc5869->getOptions(); $v5c1c342594 = @$v4948cc5869->createDB($v5d3813882f["db_name"]) && @$v4948cc5869->connect(); } catch (Exception $paec2c009) { $v44a3bea0b6 = true; } } if ($v44a3bea0b6 && $paec2c009) { debug_log($paec2c009, "exception"); $this->v0f9512fda4 = $paec2c009->getMessage(); } if ($v44a3bea0b6 && $pc40b8a19 && !$GLOBALS["GlobalErrorHandler"]->ok()) $GLOBALS["GlobalErrorHandler"]->start(); } } return $v5c1c342594; } public function getFirstTaskDBDriverCredentials($v5e053dece2, $pd7b11284 = "") { $pef349725 = array(); $v7f5911d32d = $this->getFirstTaskDBDriver($v5e053dece2); if ($v7f5911d32d) if (is_array($v7f5911d32d["properties"])) foreach ($v7f5911d32d["properties"] as $pe5c5e2fe => $v956913c90f) if ($pe5c5e2fe != "exits") $pef349725[$pd7b11284 . $pe5c5e2fe] = $v956913c90f; return $pef349725; } public function getFirstTaskDBDriver($v5e053dece2) { $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getTasksByLayerTag("dbdriver", 1); return $v1d696dbd12[0]; } public function getBeanObject($v6491a7e70b, $v8ffce2a791) { $pb512d021 = new WorkFlowBeansFileHandler($this->v5039a77f9d . $v6491a7e70b, $this->v3d55458bcd); $v8ffce2a791 = WorkFlowBeansConverter::getObjectNameFromRawLabel($v8ffce2a791); $v972f1a5c2b = $pb512d021->getBeanObject($v8ffce2a791); $this->v0f9512fda4 = $pb512d021->getError(); return $v972f1a5c2b; } public function getDBTables($pa0462a8e, $v8ffce2a791) { $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); if ($v87e4fe1181) { return $v87e4fe1181->listTables(); } return false; } public function getDBTableAttributes($pa0462a8e, $v8ffce2a791, $pc661dc6b) { $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); if ($v87e4fe1181) { return $v87e4fe1181->listTableFields($pc661dc6b); } return false; } public function getTaskDBDiagramSql($pa0462a8e, $v8ffce2a791, $v5e053dece2) { $v3c76382d93 = ""; $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); if ($v87e4fe1181) { $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getWorkflowData(); $v1d696dbd12 = $v1d696dbd12["tasks"]; if (is_array($v1d696dbd12)) { foreach ($v1d696dbd12 as $v8282c7dd58 => $v7f5911d32d) { $pef349725 = $v7f5911d32d["properties"]; $v87a92bb1ad = array( "table_name" => $v7f5911d32d["label"], "charset" => $pef349725["table_charset"], "collation" => $pef349725["table_collation"], "table_storage_engine" => $pef349725["table_storage_engine"], "attributes" =>array(), ); $ped0a6251 = $pef349725["table_attr_names"]; if ($ped0a6251) { if (is_array($ped0a6251)) { $pc37695cb = count($ped0a6251); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v87a92bb1ad["attributes"][] = array( "name" => $ped0a6251[$v43dd7d0051], "primary_key" => strtolower($pef349725["table_attr_primary_keys"][$v43dd7d0051]) == "true" || $pef349725["table_attr_primary_keys"][$v43dd7d0051] == "1", "type" => $pef349725["table_attr_types"][$v43dd7d0051], "length" => $pef349725["table_attr_lengths"][$v43dd7d0051], "null" => strtolower($pef349725["table_attr_nulls"][$v43dd7d0051]) == "true" || $pef349725["table_attr_nulls"][$v43dd7d0051] == "1", "unsigned" => strtolower($pef349725["table_attr_unsigneds"][$v43dd7d0051]) == "true" || $pef349725["table_attr_unsigneds"][$v43dd7d0051] == "1", "unique" => strtolower($pef349725["table_attr_uniques"][$v43dd7d0051]) == "true" || $pef349725["table_attr_uniques"][$v43dd7d0051] == "1", "auto_increment" => strtolower($pef349725["table_attr_auto_increments"][$v43dd7d0051]) == "true" || $pef349725["table_attr_auto_increments"][$v43dd7d0051] == "1", "default" => strtolower($pef349725["table_attr_has_defaults"][$v43dd7d0051]) == "true" || $pef349725["table_attr_has_defaults"][$v43dd7d0051] == "1" ? $pef349725["table_attr_defaults"][$v43dd7d0051] : null, "extra" => $pef349725["table_attr_extras"][$v43dd7d0051], "charset" => $pef349725["table_attr_charsets"][$v43dd7d0051], "collation" => $pef349725["table_attr_collations"][$v43dd7d0051], "comment" => $pef349725["table_attr_comments"][$v43dd7d0051], ); } } else { $v87a92bb1ad["attributes"][] = array( "name" => $ped0a6251, "primary_key" => strtolower($pef349725["table_attr_primary_keys"]) == "true" || $pef349725["table_attr_primary_keys"] == "1", "type" => $pef349725["table_attr_types"], "length" => $pef349725["table_attr_lengths"], "null" => strtolower($pef349725["table_attr_nulls"]) == "true" || $pef349725["table_attr_nulls"] == "1", "unsigned" => strtolower($pef349725["table_attr_unsigneds"]) == "true" || $pef349725["table_attr_unsigneds"] == "1", "unique" => strtolower($pef349725["table_attr_uniques"]) == "true" || $pef349725["table_attr_uniques"] == "1", "auto_increment" => strtolower($pef349725["table_attr_auto_increments"]) == "true" || $pef349725["table_attr_auto_increments"] == "1", "default" => strtolower($pef349725["table_attr_has_defaults"]) == "true" || $pef349725["table_attr_has_defaults"] == "1" ? $pef349725["table_attr_defaults"] : null, "extra" => $pef349725["table_attr_extras"], "charset" => $pef349725["table_attr_charsets"], "collation" => $pef349725["table_attr_collations"], "comment" => $pef349725["table_attr_comments"], ); } } $v3c76382d93 .= ($v3c76382d93 ? "\n\n" : "") . $v87e4fe1181->getDropTableStatement($v87a92bb1ad["table_name"], $v87e4fe1181->getOptions()) . ";\n" . $v87e4fe1181->getCreateTableStatement($v87a92bb1ad, $v87e4fe1181->getOptions()) . ";"; } } } return $v3c76382d93; } public function getTaskDBDiagramSettings($v5e053dece2, $v07934f67a4 = null) { $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v539082ff30 = $v8cd3e3837d->getWorkflowData(); if ($v539082ff30["settings"] && $v07934f67a4) return $v539082ff30["settings"][$v07934f67a4]; return $v539082ff30["settings"]; } public function getUpdateTaskDBDiagram($pa0462a8e, $v8ffce2a791, $v5e053dece2 = false) { $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getWorkflowData(); $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); $pac4bc40a = $v87e4fe1181 ? $v87e4fe1181->listTables() : array(); $pd7dcf6a3 = array(); $v16ac35fd79 = count($pac4bc40a); for ($v43dd7d0051 = 0; $v43dd7d0051 < $v16ac35fd79; $v43dd7d0051++) { $pc661dc6b = $pac4bc40a[$v43dd7d0051]; if (!empty($pc661dc6b)) { $ped0a6251 = $v87e4fe1181 ? $v87e4fe1181->listTableFields($pc661dc6b["name"]) : array(); $v571a648e93 = $v87e4fe1181 ? $v87e4fe1181->listForeignKeys($pc661dc6b["name"]) : array(); $pd7dcf6a3[ $pc661dc6b["name"] ] = array($ped0a6251, $v571a648e93, $pc661dc6b); } } return self::getUpdateTaskDBDiagramFromTablesData($pd7dcf6a3, $v1d696dbd12); } public function updateFileTasksDBDiagramTablesFromServer($pa0462a8e, $v8ffce2a791, $v5e053dece2, $pe0192448 = null) { $pd76531b6 = $this->getUpdateTaskDBDiagram($pa0462a8e, $v8ffce2a791, $v5e053dece2); $v3165774ec7 = $pd76531b6["tasks"]; if ($v3165774ec7 && $pe0192448) { $pe65fff24 = array(); foreach ($v3165774ec7 as $v8282c7dd58 => $v7f5911d32d) if ($v7f5911d32d["label"]) $pe65fff24[ $v7f5911d32d["label"] ] = $v8282c7dd58; $pb632401e = array(); $pe0192448 = is_array($pe0192448) ? $pe0192448 : array($pe0192448); foreach ($pe0192448 as $v8c5df8072b) { $v08ba0e224b = self::getTableTaskRealNameFromTasks($pe65fff24, $v8c5df8072b); $v8282c7dd58 = $pe65fff24[$v08ba0e224b]; if ($v8282c7dd58) $pb632401e[] = $v8282c7dd58; } $v9fabac90df = array(); foreach ($pb632401e as $v8282c7dd58) $v9fabac90df[$v8282c7dd58] = $v3165774ec7[$v8282c7dd58]; $v3165774ec7 = $v9fabac90df; $pd76531b6["tasks"] = $v3165774ec7; } if (!file_exists($v5e053dece2)) return WorkFlowTasksFileHandler::createTasksFile($v5e053dece2, $pd76531b6); else if ($v3165774ec7) { $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getWorkflowData(); $v4e01a34d79 = false; foreach ($v3165774ec7 as $v7f5911d32d) { $v8282c7dd58 = $v7f5911d32d["id"]; $v7959970a41 = false; foreach ($v1d696dbd12["tasks"] as $pacd80e2b) if ($pacd80e2b["id"] == $v8282c7dd58) { $v4e01a34d79 = true; $v7959970a41 = true; if (empty($v7f5911d32d["exits"])) $v7f5911d32d["exits"] = $pacd80e2b["exits"]; $v1d696dbd12["tasks"][$v8282c7dd58] = $v7f5911d32d; if ($v1d696dbd12["settings"]) { if (is_array($v1d696dbd12["settings"]["old_tables_names"]) && $v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58]) $v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58] = $v7f5911d32d["label"]; if (is_array($v1d696dbd12["settings"]["old_tables_attributes_names"]) && $v1d696dbd12["settings"]["old_tables_attributes_names"][$v8282c7dd58]) $v1d696dbd12["settings"]["old_tables_attributes_names"][$v8282c7dd58] = $v7f5911d32d["properties"]["table_attr_names"]; } } if (!$v7959970a41) { $v1d696dbd12["tasks"][] = $v7f5911d32d; $v4e01a34d79 = true; } } return $v4e01a34d79 ? WorkFlowTasksFileHandler::createTasksFile($v5e053dece2, $v1d696dbd12) : true; } return false; } public function renameFileTasksDBDiagramTables($v5e053dece2, $v772c594209) { if ($v772c594209 && file_exists($v5e053dece2)) { $v772c594209 = is_array($v772c594209) ? $v772c594209 : array($v772c594209); $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getWorkflowData(); $pe65fff24 = array(); foreach ($v1d696dbd12["tasks"] as $pd69fb7d0 => $v7f5911d32d) if ($v7f5911d32d["label"]) $pe65fff24[ $v7f5911d32d["label"] ] = $pd69fb7d0; $pdca4e5a9 = false; foreach ($v772c594209 as $v6447463421 => $v92619b9207) { $v08ba0e224b = self::getTableTaskRealNameFromTasks($pe65fff24, $v6447463421); $pd69fb7d0 = $pe65fff24[$v08ba0e224b]; if (array_key_exists($pd69fb7d0, $v1d696dbd12["tasks"])) { $pdca4e5a9 = true; $v1d696dbd12["tasks"][$pd69fb7d0]["label"] = $v92619b9207; if ($v1d696dbd12["settings"]) { $v8282c7dd58 = $v1d696dbd12["tasks"][$pd69fb7d0]["id"]; if (is_array($v1d696dbd12["settings"]["old_tables_names"]) && $v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58]) $v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58] = $v92619b9207; } } } return $pdca4e5a9 ? WorkFlowTasksFileHandler::createTasksFile($v5e053dece2, $v1d696dbd12) : true; } return true; } public function removeFileTasksDBDiagramTables($v5e053dece2, $v001906121f) { if ($v001906121f && file_exists($v5e053dece2)) { $v001906121f = is_array($v001906121f) ? $v001906121f : array($v001906121f); $v8cd3e3837d = new WorkFlowTasksFileHandler($v5e053dece2); $v8cd3e3837d->init(); $v1d696dbd12 = $v8cd3e3837d->getWorkflowData(); $pe65fff24 = array(); foreach ($v1d696dbd12["tasks"] as $pd69fb7d0 => $v7f5911d32d) if ($v7f5911d32d["label"]) $pe65fff24[ $v7f5911d32d["label"] ] = $pd69fb7d0; $paed2cdb5 = false; foreach ($v001906121f as $v8c5df8072b) { $v08ba0e224b = self::getTableTaskRealNameFromTasks($pe65fff24, $v8c5df8072b); $pd69fb7d0 = $pe65fff24[$v08ba0e224b]; if (array_key_exists($pd69fb7d0, $v1d696dbd12["tasks"])) { $paed2cdb5 = true; if ($v1d696dbd12["settings"]) { $v8282c7dd58 = $v1d696dbd12["tasks"][$pd69fb7d0]["id"]; if (is_array($v1d696dbd12["settings"]["old_tables_names"]) && $v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58]) unset($v1d696dbd12["settings"]["old_tables_names"][$v8282c7dd58]); if (is_array($v1d696dbd12["settings"]["old_tables_attributes_names"]) && $v1d696dbd12["settings"]["old_tables_attributes_names"][$v8282c7dd58]) unset($v1d696dbd12["settings"]["old_tables_attributes_names"][$v8282c7dd58]); } unset($v1d696dbd12["tasks"][$pd69fb7d0]); } } return $paed2cdb5 ? WorkFlowTasksFileHandler::createTasksFile($v5e053dece2, $v1d696dbd12) : true; } return true; } public function executeSyncTaskDBDiagramWithDBServerSQLStatements($pa0462a8e, $v8ffce2a791, $pa73cacfe, &$v8a29987473 = null) { $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); $v8a29987473 = array(); if ($pa73cacfe) foreach ($pa73cacfe as $v8c5df8072b => $v53569904b2) { $v9ff2446d14 = $v53569904b2["sql_statements"]; if ($v9ff2446d14) foreach ($v9ff2446d14 as $v3c76382d93) if ($v3c76382d93) { $v5c1c342594 = true; try { $v5c1c342594 = $v87e4fe1181->setData($v3c76382d93); if (!$v5c1c342594) $v8a29987473[] = $v3c76382d93; } catch(Exception $paec2c009) { $v8a29987473[] = (is_a($paec2c009, "Exception") ? $paec2c009->getMessage() . "\n\n" : "") . $v3c76382d93; } if (!$v5c1c342594) break; } } return empty($v8a29987473); } public function syncTaskDBDiagramWithDBServer($pa0462a8e, $v8ffce2a791, $v1d696dbd12, &$v808a08b1f9 = array(), &$v8a29987473 = null) { $pa73cacfe = $this->getSyncTaskDBDiagramWithDBServerSQLStatements($pa0462a8e, $v8ffce2a791, $v1d696dbd12, $v808a08b1f9); $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); $v8a29987473 = array(); if ($pa73cacfe) foreach ($pa73cacfe as $v8c5df8072b => $v53569904b2) { $v9ff2446d14 = $v53569904b2["sql_statements"]; $v808a08b1f9[$v8c5df8072b]["sql_statements"] = $v9ff2446d14; $v808a08b1f9[$v8c5df8072b]["sql_statements_labels"] = $v53569904b2["sql_statements_labels"]; if ($v9ff2446d14) foreach ($v9ff2446d14 as $v3c76382d93) if ($v3c76382d93) { $v5c1c342594 = true; try { $v5c1c342594 = $v87e4fe1181->setData($v3c76382d93); if (!$v5c1c342594) $v8a29987473[] = $v3c76382d93; } catch(Exception $paec2c009) { $v8a29987473[] = (is_a($paec2c009, "Exception") ? $paec2c009->getMessage() . "\n\n" : "") . $v3c76382d93; } if (!$v5c1c342594) break; } } return empty($v8a29987473); } public function getSyncTaskDBDiagramWithDBServerSQLStatements($pa0462a8e, $v8ffce2a791, $v1d696dbd12, &$v808a08b1f9 = array()) { $v87e4fe1181 = $this->getBeanObject($pa0462a8e, $v8ffce2a791); if ($v87e4fe1181 && $v1d696dbd12) { $pe65fff24 = array(); $v7f3dbd6f92 = array(); if ($v1d696dbd12 && $v1d696dbd12["tasks"]) foreach ($v1d696dbd12["tasks"] as $v8282c7dd58 => $v7f5911d32d) { $v8c5df8072b = $v7f5911d32d["old_label"] ? $v7f5911d32d["old_label"] : $v7f5911d32d["label"]; $pe65fff24[$v8c5df8072b] = $v7f5911d32d; if ($v8c5df8072b != $v7f5911d32d["label"]) $v7f3dbd6f92[$v8c5df8072b] = $v7f5911d32d["label"]; } $v5ff7954bf3 = self::getTasksAsTables($pe65fff24); foreach ($v5ff7954bf3 as $v8c5df8072b => $ped0a6251) { $v7f5911d32d = $pe65fff24[$v8c5df8072b]; $v141a1052c0 = $v7f5911d32d["properties"]["table_attr_names"]; $v07af2baf06 = $v7f5911d32d["properties"]["table_attr_old_names"]; foreach ($ped0a6251 as $v5e45ec9bb9 => $v1b0cfa478b) { $v8a4df75785 = array_search($v5e45ec9bb9, $v141a1052c0); if (is_numeric($v8a4df75785)) { $v50e78f7709 = $v07af2baf06[$v8a4df75785]; if ($v50e78f7709) $v5ff7954bf3[$v8c5df8072b][$v5e45ec9bb9]["old_name"] = $v50e78f7709; } } } $pac4bc40a = $v87e4fe1181->listTables(); $v16ac35fd79 = count($pac4bc40a); $v601478716f = array(); for ($v43dd7d0051 = 0; $v43dd7d0051 < $v16ac35fd79; $v43dd7d0051++) { $pc661dc6b = $pac4bc40a[$v43dd7d0051]; if (!empty($pc661dc6b)) { $v8c5df8072b = $pc661dc6b["name"]; $v49a5abc20c = self::getTableFromTables($v5ff7954bf3, $v8c5df8072b); if ($v49a5abc20c) { $ped0a6251 = $v87e4fe1181->listTableFields($v8c5df8072b); $v571a648e93 = $v87e4fe1181->listForeignKeys($v8c5df8072b); if (is_array($v571a648e93)) foreach ($v571a648e93 as $pa7c14731) if (!empty($pa7c14731)) { $v8822d98b2e = $pa7c14731["child_column"]; if ($v8822d98b2e && $ped0a6251[$v8822d98b2e]) { if (!$ped0a6251[$v8822d98b2e]["fk"]) $ped0a6251[$v8822d98b2e]["fk"] = array(); $ped0a6251[$v8822d98b2e]["fk"][] = array( "attribute" => $pa7c14731["parent_column"], "table" => $pa7c14731["parent_table"] ); } } $v601478716f[$v8c5df8072b] = $ped0a6251; } } } return self::getTablesUpdateSQLStatements($v87e4fe1181, $v601478716f, $v5ff7954bf3, $v7f3dbd6f92, $v808a08b1f9); } return false; } public static function getTablesUpdateSQLStatements($v87e4fe1181, $v64563ffb30, $pbc320202, $v7f3dbd6f92 = null, &$v808a08b1f9 = array()) { $pa73cacfe = array(); if (!is_array($v808a08b1f9)) $v808a08b1f9 = array(); foreach ($v64563ffb30 as $v8c5df8072b => $v94a426ccfa) { $v9a1fa54047 = self::getTableTaskRealNameFromTasks($pbc320202, $v8c5df8072b); $v92619b9207 = $v7f3dbd6f92[$v9a1fa54047]; $paad1f67a = $pbc320202[$v9a1fa54047]; $pa73cacfe[$v8c5df8072b] = self::getTableUpdateSQLStatements($v87e4fe1181, $v8c5df8072b, $v94a426ccfa, $paad1f67a, $v92619b9207, $v775c64530e); $v808a08b1f9[$v8c5df8072b] = $v775c64530e; } foreach ($pbc320202 as $v8c5df8072b => $paad1f67a) { $v9a1fa54047 = self::getTableTaskRealNameFromTasks($v64563ffb30, $v8c5df8072b); $v92619b9207 = $v7f3dbd6f92[$v8c5df8072b]; $pb23f27a4 = array_key_exists($v9a1fa54047, $v64563ffb30); if (!$pb23f27a4) { $v632afc8a82 = false; if ($v92619b9207 && $v92619b9207 != $v8c5df8072b) { $v38b803468a = self::getTableTaskRealNameFromTasks($v64563ffb30, $v92619b9207); $v632afc8a82 = array_key_exists($v38b803468a, $v64563ffb30); if ($v632afc8a82) { $v94a426ccfa = $v64563ffb30[$v38b803468a]; $pa73cacfe[$v38b803468a] = self::getTableUpdateSQLStatements($v87e4fe1181, $v38b803468a, $v94a426ccfa, $paad1f67a, null, $v775c64530e); $v808a08b1f9[$v38b803468a] = $v775c64530e; continue; } else $v8c5df8072b = $v92619b9207; } if (!$v632afc8a82) { $pa73cacfe[$v8c5df8072b] = self::getTableAddSQLStatements($v87e4fe1181, $v8c5df8072b, $paad1f67a, $v775c64530e); $v808a08b1f9[$v8c5df8072b] = $v775c64530e; } } } return $pa73cacfe; } public static function getTableAddSQLStatements($v87e4fe1181, $v8c5df8072b, $paad1f67a, &$v808a08b1f9 = array()) { $v9ff2446d14 = array(); $pca838fcd = array(); $v08ab593fba = $v87e4fe1181->getOptions(); $paad1f67a = is_array($paad1f67a) ? $paad1f67a : array(); foreach ($paad1f67a as $pd69fb7d0 => $v9b44d363cc) if (!trim($v9b44d363cc["name"])) unset($paad1f67a[$pd69fb7d0]); $paad1f67a = array_values($paad1f67a); $v539082ff30 = array( "table_name" => $v8c5df8072b, "attributes" => $paad1f67a ); $v9ff2446d14[] = $v87e4fe1181->getCreateTableStatement($v539082ff30, $v08ab593fba); $pca838fcd[] = "Create table " . $v8c5df8072b; $v808a08b1f9 = array( "sql_options" => $v08ab593fba, "table_name" => $v8c5df8072b, "new_attrs" => $paad1f67a, ); return array( "sql_statements" => $v9ff2446d14, "sql_statements_labels" => $pca838fcd, ); } public static function getTableUpdateSQLStatements($v87e4fe1181, $v8c5df8072b, $v94a426ccfa, $paad1f67a, $v92619b9207 = null, &$v808a08b1f9 = array()) { $v9ff2446d14 = array(); $pca838fcd = array(); $v08ab593fba = $v87e4fe1181->getOptions(); $v1bfabf5d11 = $v87e4fe1181->allowTableAttributeSorting(); $v8b7819f513 = $v87e4fe1181->getDBColumnTypesIgnoredProps(); $v94a426ccfa = is_array($v94a426ccfa) ? $v94a426ccfa : array(); $paad1f67a = is_array($paad1f67a) ? $paad1f67a : array(); foreach ($v94a426ccfa as $pd69fb7d0 => $pd7f4851c) if (!trim($pd7f4851c["name"])) unset($v94a426ccfa[$pd69fb7d0]); foreach ($paad1f67a as $pd69fb7d0 => $v9b44d363cc) if (!trim($v9b44d363cc["name"])) unset($paad1f67a[$pd69fb7d0]); $v94a426ccfa = array_values($v94a426ccfa); $paad1f67a = array_values($paad1f67a); $v14e1bb140a = array(); $pfb3e55a2 = array(); $pce2204bb = array(); $v6fd775fccb = array(); $v756770ff74 = array(); $v5768ca6d9f = $v1a9d91caea = $v69648c9e18 = $pa04a2fa5 = array(); $pf9458c4d = 0; foreach ($paad1f67a as $v067453c009 => $v9b44d363cc) { $v7959970a41 = false; $peaadc48e = false; $v0503523dbe = -1; if ($v94a426ccfa) { $pc790a5a3 = strtolower($v9b44d363cc["name"]); $v2c407bf9f6 = strtolower($v9b44d363cc["old_name"]); $v17f0a6ef4f = -1; $pfe9cc8f9 = -1; foreach ($v94a426ccfa as $v8ad5107f9a => $pd7f4851c) { if ($v2c407bf9f6 == strtolower($pd7f4851c["name"])) { $v17f0a6ef4f = $v8ad5107f9a; break; } else if ($pc790a5a3 == strtolower($pd7f4851c["name"])) $pfe9cc8f9 = $v8ad5107f9a; } $pd7f4851c = $v17f0a6ef4f != -1 ? $v94a426ccfa[$v17f0a6ef4f] : ($pfe9cc8f9 != -1 ? $v94a426ccfa[$pfe9cc8f9] : null); if ($pd7f4851c) { $v7959970a41 = true; $v0503523dbe = $v17f0a6ef4f != -1 ? $v17f0a6ef4f : $pfe9cc8f9; if ($v9b44d363cc["name"] != $pd7f4851c["name"]) { $pce2204bb[ $pd7f4851c["name"] ] = $v9b44d363cc["name"]; $v6fd775fccb[ $pd7f4851c["name"] ] = $pd7f4851c; } $v9b44d363cc["name"] = $pd7f4851c["name"]; if (is_array($v8b7819f513[ $pd7f4851c["type"] ])) foreach ($v8b7819f513[ $pd7f4851c["type"] ] as $pf2866543) { if ($v9b44d363cc["type"] == $pd7f4851c["type"] || $pf2866543 != "length") $v9b44d363cc[$pf2866543] = $pd7f4851c[$pf2866543]; } $pba6ac7fc = $pd7f4851c["primary_key"] && ($pd7f4851c["auto_increment"] || stripos($pd7f4851c["extra"], "auto_increment") !== false); if ($v9b44d363cc["extra"] && stripos($v9b44d363cc["extra"], "auto_increment") !== false) $v9b44d363cc["extra"] = trim(preg_replace("/\s+/i", " ", preg_replace("/(^|\s)auto_increment(\s|$)/i", " ", $v9b44d363cc["extra"]))); if ($pd7f4851c["extra"] && stripos($pd7f4851c["extra"], "auto_increment") !== false) $pd7f4851c["extra"] = trim(preg_replace("/\s+/i", " ", preg_replace("/(^|\s)auto_increment(\s|$)/i", " ", $pd7f4851c["extra"]))); if ($pba6ac7fc) $pa04a2fa5[ $pd7f4851c["name"] ] = $pd7f4851c; if ( $v9b44d363cc["primary_key"] != $pd7f4851c["primary_key"] || $v9b44d363cc["type"] != $pd7f4851c["type"] || $v9b44d363cc["length"] != $pd7f4851c["length"] || $v9b44d363cc["null"] != $pd7f4851c["null"] || $v9b44d363cc["unsigned"] != $pd7f4851c["unsigned"] || $v9b44d363cc["unique"] != $pd7f4851c["unique"] || $v9b44d363cc["auto_increment"] != $pd7f4851c["auto_increment"] || $v9b44d363cc["default"] != $pd7f4851c["default"] || $v9b44d363cc["extra"] != $pd7f4851c["extra"] || ($v9b44d363cc["charset"] && $v9b44d363cc["charset"] != $pd7f4851c["charset"]) || ($v9b44d363cc["collation"] && $v9b44d363cc["collation"] != $pd7f4851c["collation"]) || $v9b44d363cc["comment"] != $pd7f4851c["comment"] ) $peaadc48e = true; } } if ($v067453c009 != $v0503523dbe) { $v2f0d8cd62f = $v067453c009 - 1; if ($v2f0d8cd62f < 0) { $v9b44d363cc["first"] = true; $pf9458c4d++; if ($v7959970a41) $peaadc48e = true; } else if ($v067453c009 - $pf9458c4d != $v0503523dbe) { $v9b44d363cc["after"] = $paad1f67a[$v2f0d8cd62f]["name"]; $pf9458c4d++; if ($v7959970a41) $peaadc48e = true; } } if (!$v7959970a41) $v14e1bb140a[] = $v9b44d363cc; else if ($peaadc48e) $pfb3e55a2[] = $v9b44d363cc; if ($v9b44d363cc["primary_key"]) { $v5768ca6d9f[] = $v9b44d363cc["name"]; $v1a9d91caea[] = $v9b44d363cc; } if ($v7959970a41 && $pd7f4851c["primary_key"]) $v69648c9e18[] = $pd7f4851c["name"]; } foreach ($v94a426ccfa as $pd69fb7d0 => $pd7f4851c) { $v7959970a41 = false; $pc790a5a3 = strtolower($pd7f4851c["name"]); if ($paad1f67a) foreach ($paad1f67a as $v8ad5107f9a => $v9b44d363cc) if (strtolower($v9b44d363cc["old_name"]) == $pc790a5a3 || strtolower($v9b44d363cc["name"]) == $pc790a5a3) { $v7959970a41 = true; break; } if (!$v7959970a41) $v756770ff74[] = $pd7f4851c; } if ($v14e1bb140a || $pfb3e55a2 || $pce2204bb || $v756770ff74) { $pfa756934 = array(); $v8734a74375 = false; if (count($v69648c9e18) && ( count($v5768ca6d9f) != count($v69648c9e18) || array_diff($v5768ca6d9f, $v69648c9e18) )) { if ($pa04a2fa5) foreach ($pa04a2fa5 as $v5e45ec9bb9 => $v1b0cfa478b) { $v1b0cfa478b["auto_increment"] = false; $v1b0cfa478b["extra"] = preg_replace("/(^|\s)auto_increment($|\s)/i", "", $v1b0cfa478b["extra"]); $v9ff2446d14[] = $v87e4fe1181->getModifyTableAttributeStatement($pc661dc6b, $v1b0cfa478b); $pca838fcd[] = "Remove auto_increment prop from primary key in table $v8c5df8072b"; } $v9ff2446d14[] = $v87e4fe1181->getDropTablePrimaryKeysStatement($v8c5df8072b, $v08ab593fba); $pca838fcd[] = "Drop primary keys in table $v8c5df8072b"; $v8734a74375 = true; } foreach ($v14e1bb140a as $v1b0cfa478b) { if ($v1b0cfa478b["auto_increment"] || stripos($v1b0cfa478b["extra"], "auto_increment") !== false) { $pfa756934[] = $v1b0cfa478b; $v1b0cfa478b["extra"] = preg_replace("/(^|\s)auto_increment(\s|$)/i", " ", $v1b0cfa478b["extra"]); $v1b0cfa478b["auto_increment"] = false; } $v9ff2446d14[] = $v87e4fe1181->getAddTableAttributeStatement($v8c5df8072b, $v1b0cfa478b, $v08ab593fba); $pca838fcd[] = "Add attribute " . $v1b0cfa478b["name"] . " to table $v8c5df8072b"; } foreach ($pfb3e55a2 as $v1b0cfa478b) { if ($v8734a74375 && ($v1b0cfa478b["auto_increment"] || stripos($v1b0cfa478b["extra"], "auto_increment") !== false)) { $pfa756934[] = $v1b0cfa478b; $v1b0cfa478b["extra"] = preg_replace("/(^|\s)auto_increment(\s|$)/i", " ", $v1b0cfa478b["extra"]); $v1b0cfa478b["auto_increment"] = false; } $v9ff2446d14[] = $v87e4fe1181->getModifyTableAttributeStatement($v8c5df8072b, $v1b0cfa478b, $v08ab593fba); $pca838fcd[] = "Modify attribute " . $v1b0cfa478b["name"] . " in table $v8c5df8072b"; } if ($v5768ca6d9f &&(count($v5768ca6d9f) != count($v69648c9e18) || array_diff($v5768ca6d9f, $v69648c9e18))) { $v9ff2446d14[] = $v87e4fe1181->getAddTablePrimaryKeysStatement($v8c5df8072b, $v1a9d91caea, $v08ab593fba); $pca838fcd[] = "Add primary key in table $v8c5df8072b"; } if ($pfa756934) foreach ($pfa756934 as $v1b0cfa478b) { $v9ff2446d14[] = $v87e4fe1181->getModifyTableAttributeStatement($v8c5df8072b, $v1b0cfa478b, $v08ab593fba); $pca838fcd[] = "Modify attribute " . $v1b0cfa478b["name"] . " in table $v8c5df8072b with auto_increment property"; } foreach ($v756770ff74 as $v1b0cfa478b) { $v812af0e33c = array(); $v498643c9d0 = array(); if ($v1b0cfa478b["fk"]) { $v571a648e93 = $v571a648e93 ? $v571a648e93 : $v87e4fe1181->listForeignKeys($v8c5df8072b); if ($v571a648e93) { for ($v43dd7d0051 = 0, $pc37695cb = count($v571a648e93); $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pa7c14731 = $v571a648e93[$v43dd7d0051]; if ($pa7c14731["child_column"] == $v1b0cfa478b["name"]) if ($pa7c14731["constraint_name"] && !in_array($pa7c14731["constraint_name"], $v498643c9d0)) { $v498643c9d0[] = $pa7c14731["constraint_name"]; $v9ff2446d14[] = $v87e4fe1181->getDropTableForeignConstraintStatement($v8c5df8072b, $pa7c14731["constraint_name"]); $pca838fcd[] = "Drop foreign key for " . $v1b0cfa478b["name"] . " in table $v8c5df8072b"; for ($v9d27441e80 = 0; $v9d27441e80 < $pc37695cb; $v9d27441e80++) if ($v9d27441e80 != $v43dd7d0051) { $pcc63f744 = $v571a648e93[$v9d27441e80]; if ($pcc63f744["parent_table"] == $pa7c14731["parent_table"] && $pcc63f744["child_column"] != $v1b0cfa478b["name"]) { $v812af0e33c[ $pa7c14731["parent_table"] ][ $pcc63f744["child_column"] ] = $pcc63f744["parent_column"]; } } } } } } $v9ff2446d14[] = $v87e4fe1181->getDropTableAttributeStatement($v8c5df8072b, $v1b0cfa478b["name"], $v08ab593fba); $pca838fcd[] = "Drop attribute " . $v1b0cfa478b["name"] . " in table $v8c5df8072b"; if ($v812af0e33c) foreach ($v812af0e33c as $pf71bb87b => $v2f454b0d38) { if (!empty($v2f454b0d38)) { $pa28639ac = $v498643c9d0[0]; $pa7c14731 = array( "child_column" => array_keys($v2f454b0d38), "parent_column" => array_values($v2f454b0d38), "parent_table" => $pf71bb87b, "constraint_name" => $pa28639ac ? $pa28639ac : "fk_{$v8c5df8072b}_{$pf71bb87b}_" . implode("_", array_keys($v2f454b0d38)), ); $v9ff2446d14[] = $v87e4fe1181->getAddTableForeignKeyStatement($v8c5df8072b, $pa7c14731); $pca838fcd[] = "Re-Add foregin key " . $pa7c14731["name"] . " with other attributes in table $v8c5df8072b"; } } } foreach ($pce2204bb as $v50e78f7709 => $pe6871e84) { $v1b0cfa478b = $v6fd775fccb[$v50e78f7709]; $v9ff2446d14[] = $v87e4fe1181->getRenameTableAttributeStatement($v8c5df8072b, $v50e78f7709, $pe6871e84, $v1b0cfa478b, $v08ab593fba); $pca838fcd[] = "Rename attribute $v50e78f7709 in table $v8c5df8072b"; } } if ($v92619b9207 && $v8c5df8072b != $v92619b9207) { $v9ff2446d14[] = $v87e4fe1181->getRenameTableStatement($v8c5df8072b, $v92619b9207, $v08ab593fba); $pca838fcd[] = "Rename table " . $v8c5df8072b . " to " . $v92619b9207; } $v808a08b1f9 = array( "sql_options" => $v08ab593fba, "allow_sort" => $v1bfabf5d11, "table_name" => $v8c5df8072b, "new_table_name" => $v92619b9207, "old_attrs" => $v94a426ccfa, "new_attrs" => $paad1f67a, "attributes_to_add" => $v14e1bb140a, "attributes_to_modify" => $pfb3e55a2, "attributes_to_rename" => $pce2204bb, "attributes_data_to_rename" => $v6fd775fccb, "attributes_to_delete" => $v756770ff74, "new_pks" => $v5768ca6d9f, "new_pks_attrs" => $v1a9d91caea, "old_pks" => $v69648c9e18 ); return array( "sql_statements" => $v9ff2446d14, "sql_statements_labels" => $pca838fcd, ); } public static function getTableTaskRealNameFromTasks($v1d696dbd12, $v8c5df8072b) { if (!array_key_exists($v8c5df8072b, $v1d696dbd12)) foreach ($v1d696dbd12 as $v08ba0e224b => $v7f5911d32d) if (DB::isTheSameStaticTableName($v8c5df8072b, $v08ba0e224b, array("simple_comparison" => true))) return $v08ba0e224b; return $v8c5df8072b; } public static function getTableFromTables($pac4bc40a, $v8c5df8072b) { $v9a1fa54047 = self::getTableTaskRealNameFromTasks($pac4bc40a, $v8c5df8072b); return $pac4bc40a[$v9a1fa54047]; } public static function getTableAttributes($v1d696dbd12, $v8c5df8072b) { $pc661dc6b = self::getTableFromTables($v1d696dbd12, $v8c5df8072b); return $pc661dc6b["properties"]["table_attr_names"]; } public static function getTablePrimaryKeys($v1d696dbd12, $v8c5df8072b) { $pc661dc6b = self::getTableFromTables($v1d696dbd12, $v8c5df8072b); $pc9dfdb06 = $pc661dc6b["properties"]["table_attr_primary_keys"]; $pe2f18119 = array(); if ($pc9dfdb06) { $pc37695cb = count($pc9dfdb06); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pb65331d8 = $pc9dfdb06[$v43dd7d0051]; if ($pb65331d8 == "1" || strtolower($pb65331d8) == "true") $pe2f18119[] = $pc661dc6b["properties"]["table_attr_names"][$v43dd7d0051]; } } return $pe2f18119; } public static function getUpdateTaskDBDiagramFromTablesData($pd7dcf6a3, $v1d696dbd12 = false) { $pa8a98224 = 10; $v9ee95f7393 = 10; $v29dfbeade3 = array(); $pe65fff24 = array(); if ($v1d696dbd12 && $v1d696dbd12["tasks"]) foreach ($v1d696dbd12["tasks"] as $v8282c7dd58 => $v7f5911d32d) if ($v7f5911d32d["label"]) $pe65fff24[ $v7f5911d32d["label"] ] = $v8282c7dd58; if (isset($v1d696dbd12["containers"])) { $v29dfbeade3["containers"] = $v1d696dbd12["containers"]; } foreach ($pd7dcf6a3 as $pc661dc6b => $v87a92bb1ad) { $ped0a6251 = $v87a92bb1ad[0]; $v571a648e93 = $v87a92bb1ad[1]; $v94c2944e8d = is_array($v87a92bb1ad[2]) ? $v87a92bb1ad[2] : array(); $v08ba0e224b = self::getTableTaskRealNameFromTasks($pe65fff24, $pc661dc6b); $v8282c7dd58 = $pe65fff24[$v08ba0e224b]; if (!empty($v8282c7dd58)) { $pa3858a3f = $v1d696dbd12["tasks"][$v8282c7dd58]["offset_left"]; $pacea7686 = $v1d696dbd12["tasks"][$v8282c7dd58]["offset_top"]; } else { $v9ee95f7393 += 250; if ($v9ee95f7393 > 1200) { $pa8a98224 += 300; $v9ee95f7393 = 10; } $pa3858a3f = $v9ee95f7393; $pacea7686 = $pa8a98224; } $pbb3f6f30 = !empty($v8282c7dd58) ? $v8282c7dd58 : $pc661dc6b; $v29dfbeade3["tasks"][$pbb3f6f30] = array( "label" => $pc661dc6b, "id" => $pbb3f6f30, "type" => self::TASK_TABLE_TYPE, "tag" => self::TASK_TABLE_TAG, "offset_left" => $pa3858a3f, "offset_top" => $pacea7686, "properties" => array( "exits" => array( "layer_exit" => array( "color" => "#31498f", "type" => "Flowchart", "overlay" => "No Arrows", ) ), "table_charset" => $v94c2944e8d["charset"], "table_collation" => $v94c2944e8d["collation"], "table_storage_engine" => $v94c2944e8d["engine"], "table_attr_primary_keys" => array(), "table_attr_names" => array(), "table_attr_types" => array(), "table_attr_lengths" => array(), "table_attr_nulls" => array(), "table_attr_unsigneds" => array(), "table_attr_uniques" => array(), "table_attr_auto_increments" => array(), "table_attr_has_defaults" => array(), "table_attr_defaults" => array(), "table_attr_extras" => array(), "table_attr_charsets" => array(), "table_attr_comments" => array(), ) ); if (is_array($ped0a6251)) { foreach ($ped0a6251 as $v5e45ec9bb9 => $v1b0cfa478b) { if (!empty($v5e45ec9bb9)) { $pd69fb7d0 = $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_names"] ? count($v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_names"]) : 0; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_primary_keys"][$pd69fb7d0] = !empty($v1b0cfa478b["primary_key"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_names"][$pd69fb7d0] = $v5e45ec9bb9; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_types"][$pd69fb7d0] = $v1b0cfa478b["type"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_lengths"][$pd69fb7d0] = $v1b0cfa478b["length"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_nulls"][$pd69fb7d0] = !empty($v1b0cfa478b["null"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_unsigneds"][$pd69fb7d0] = !empty($v1b0cfa478b["unsigned"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_uniques"][$pd69fb7d0] = !empty($v1b0cfa478b["unique"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_auto_increments"][$pd69fb7d0] = !empty($v1b0cfa478b["auto_increment"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_has_defaults"][$pd69fb7d0] = isset($v1b0cfa478b["default"]) && empty($v1b0cfa478b["primary_key"]) ? "1" : ""; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_defaults"][$pd69fb7d0] = $v1b0cfa478b["default"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_extras"][$pd69fb7d0] = $v1b0cfa478b["extra"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_charsets"][$pd69fb7d0] = $v1b0cfa478b["charset"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_collations"][$pd69fb7d0] = $v1b0cfa478b["collation"]; $v29dfbeade3["tasks"][$pbb3f6f30]["properties"]["table_attr_comments"][$pd69fb7d0] = $v1b0cfa478b["comment"]; } } } if (is_array($v571a648e93)) { $peb3c0114 = array(); foreach ($v571a648e93 as $pa7c14731) if (!empty($pa7c14731)) $peb3c0114[ $pa7c14731["parent_table"] ][] = $pa7c14731; foreach ($peb3c0114 as $pfcfb6727 => $v4203214533) { $pef349725 = array(); $v76b16266c9 = "Many To One"; if ($v4203214533) { $v8dc2e79009 = $pd7dcf6a3[$pfcfb6727][0]; $pebfdf883 = 0; $pc37695cb = count($v4203214533); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pb62b9fbc = $v4203214533[$v43dd7d0051]; $pef349725["source_columns"][] = $pb62b9fbc["child_column"]; $pef349725["target_columns"][] = $pb62b9fbc["parent_column"]; $pb692bad2 = $ped0a6251[ $pb62b9fbc["child_column"] ]; if ($pb692bad2 && !empty($pb692bad2["primary_key"])) $pebfdf883++; } if ($pc37695cb == $pebfdf883) $v76b16266c9 = "One To One"; } $v29dfbeade3["tasks"][$pbb3f6f30]["exits"]["layer_exit"][] = array( "task_id" => !empty($pe65fff24[$pfcfb6727]) ? $pe65fff24[$pfcfb6727] : $pfcfb6727, "label" => null, "type" => $pfcfb6727 == $pc661dc6b ? "StateMachine" : "Flowchart", "overlay" => $v76b16266c9, "properties" => $pef349725 ); } } } return $v29dfbeade3; } public static function getTasksAsTables($v1d696dbd12) { $pac4bc40a = array(); if ($v1d696dbd12) { $v71819a3338 = self::getTablesForeignKeys($v1d696dbd12); foreach ($v1d696dbd12 as $v8c5df8072b => $v7f5911d32d) { $pef349725 = $v7f5911d32d["properties"]; $pc9dfdb06 = $pef349725["table_attr_primary_keys"]; $v141a1052c0 = $pef349725["table_attr_names"]; $v64603d66e4 = $pef349725["table_attr_types"]; $pc338736d = $pef349725["table_attr_lengths"]; $pf950db1c = $pef349725["table_attr_nulls"]; $v6f7ca5e45f = $pef349725["table_attr_unsigneds"]; $pe23543a0 = $pef349725["table_attr_uniques"]; $v0277df0f74 = $pef349725["table_attr_auto_increments"]; $pa3301f67 = $pef349725["table_attr_has_defaults"]; $v559ea8b5aa = $pef349725["table_attr_defaults"]; $v342ece8a62 = $pef349725["table_attr_extras"]; $pc1c13991 = $pef349725["table_attr_charsets"]; $v4389940cae = $pef349725["table_attr_comments"]; if ($v141a1052c0) { if (is_array($v141a1052c0)) { $pc37695cb = count($v141a1052c0); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pb65331d8 = strtolower($pc9dfdb06[$v43dd7d0051]) == "true" || $pc9dfdb06[$v43dd7d0051] == "1"; $v5e45ec9bb9 = $v141a1052c0[$v43dd7d0051]; $v670a5790dd = strtolower($v64603d66e4[$v43dd7d0051]); $v2526c465bc = $pc338736d[$v43dd7d0051]; $pd8c9353b = strtolower($pf950db1c[$v43dd7d0051]) == "true" || $pf950db1c[$v43dd7d0051] == "1"; $v3c261bfc96 = strtolower($v6f7ca5e45f[$v43dd7d0051]) == "true" || $v6f7ca5e45f[$v43dd7d0051] == "1"; $v9707fb73e0 = strtolower($pe23543a0[$v43dd7d0051]) == "true" || $pe23543a0[$v43dd7d0051] == "1"; $pefe8fef4 = strtolower($v0277df0f74[$v43dd7d0051]) == "true" || $v0277df0f74[$v43dd7d0051] == "1"; $v24d6d98703 = strtolower($pa3301f67[$v43dd7d0051]) == "true" || $pa3301f67[$v43dd7d0051] == "1"; $v487af869a3 = $v559ea8b5aa[$v43dd7d0051]; $v86d8b50e05 = $v342ece8a62[$v43dd7d0051]; $v91b2b11f81 = $pc1c13991[$v43dd7d0051]; $pc3c16071 = $v4389940cae[$v43dd7d0051]; $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9] = array( "name" => $v5e45ec9bb9, "type" => $v670a5790dd, "length" => $v2526c465bc, "null" => $pd8c9353b, "primary_key" => $pb65331d8, "unsigned" => $v3c261bfc96, "unique" => $v9707fb73e0, "auto_increment" => $pefe8fef4, "default" => $v24d6d98703 ? $v487af869a3 : null, "extra" => $v86d8b50e05, "charset" => $v91b2b11f81, "comment" => $pc3c16071, ); } } else { $pb65331d8 = strtolower($pc9dfdb06) == "true" || $pc9dfdb06 == "1"; $v5e45ec9bb9 = $v141a1052c0; $v670a5790dd = strtolower($v64603d66e4); $v2526c465bc = $pc338736d; $pd8c9353b = strtolower($pf950db1c) == "true" || $pf950db1c == "1"; $v3c261bfc96 = strtolower($v6f7ca5e45f) == "true" || $v6f7ca5e45f == "1"; $v9707fb73e0 = strtolower($pe23543a0) == "true" || $pe23543a0 == "1"; $pefe8fef4 = strtolower($v0277df0f74) == "true" || $v0277df0f74 == "1"; $v24d6d98703 = strtolower($pa3301f67) == "true" || $pa3301f67 == "1"; $v487af869a3 = $v559ea8b5aa; $v86d8b50e05 = $v342ece8a62; $v91b2b11f81 = $pc1c13991; $pc3c16071 = $v4389940cae; $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9] = array( "name" => $v5e45ec9bb9, "type" => $v670a5790dd, "length" => $v2526c465bc, "null" => $pd8c9353b, "primary_key" => $pb65331d8, "unsigned" => $v3c261bfc96, "unique" => $v9707fb73e0, "auto_increment" => $pefe8fef4, "default" => $v24d6d98703 ? $v487af869a3 : null, "extra" => $v86d8b50e05, "charset" => $v91b2b11f81, "comment" => $pc3c16071, ); } } $pba9184cd = self::getTableFromTables($v71819a3338, $v8c5df8072b); if ($pba9184cd) { $pd28479e5 = count($pba9184cd); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) { $pa7c14731 = $pba9184cd[$v9d27441e80]; $v3fb9f41470 = $pa7c14731["type"]; $v9994512d98 = $pa7c14731["keys"]; $paf3a3908 = $v9994512d98 ? count($v9994512d98) : 0; switch($v3fb9f41470) { case "1-1": case "*-*": for ($pc5166886 = 0; $pc5166886 < $paf3a3908; $pc5166886++) { $pbfa01ed1 = $v9994512d98[$pc5166886]; $v5e45ec9bb9 = $pa7c14731["child_table"] == $v8c5df8072b ? $pbfa01ed1["child"] : $pbfa01ed1["parent"]; $v39cc6cbe9a = array( "table" => $pa7c14731["child_table"] == $v8c5df8072b ? $pa7c14731["parent_table"] : $pa7c14731["child_table"], "attribute" => $pa7c14731["child_table"] == $v8c5df8072b ? $pbfa01ed1["parent"] : $pbfa01ed1["child"], ); if ($pa7c14731["source"]) $v39cc6cbe9a["source"] = $pa7c14731["source"]; if ($pa7c14731["target"]) $v39cc6cbe9a["target"] = $pa7c14731["target"]; $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"][] = $v39cc6cbe9a; } break; case "*-1": if ($pa7c14731["child_table"] == $v8c5df8072b) for ($pc5166886 = 0; $pc5166886 < $paf3a3908; $pc5166886++) { $pbfa01ed1 = $v9994512d98[$pc5166886]; $v5e45ec9bb9 = $pbfa01ed1["child"]; $v39cc6cbe9a = array( "table" => $pa7c14731["parent_table"], "attribute" => $pbfa01ed1["parent"], ); if ($pa7c14731["parent_table"] == $v8c5df8072b) { $v7959970a41 = false; if ($pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"]) foreach ($pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"] as $v39cc6cbe9a) if ($v39cc6cbe9a["table"] == $v8c5df8072b && $v39cc6cbe9a["attribute"] == $pbfa01ed1["parent"]) { $v7959970a41 = true; break; } if (!$v7959970a41) $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"][] = $v39cc6cbe9a; } else $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"][] = $v39cc6cbe9a; } break; case "1-*": if ($pa7c14731["child_table"] == $v8c5df8072b && $pa7c14731["parent_table"] == $v8c5df8072b) for ($pc5166886 = 0; $pc5166886 < $paf3a3908; $pc5166886++) { $pbfa01ed1 = $v9994512d98[$pc5166886]; $v5e45ec9bb9 = $pbfa01ed1["child"]; $v7959970a41 = false; if ($pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"]) foreach ($pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"] as $v39cc6cbe9a) if ($v39cc6cbe9a["table"] == $v8c5df8072b && $v39cc6cbe9a["attribute"] == $pbfa01ed1["parent"]) { $v7959970a41 = true; break; } if (!$v7959970a41) $pac4bc40a[$v8c5df8072b][$v5e45ec9bb9]["fk"][] = array( "table" => $v8c5df8072b, "attribute" => $pbfa01ed1["parent"], ); } break; } } } } } return $pac4bc40a; } public static function getTablesForeignKeys($v1d696dbd12) { $pba9184cd = array(); if (is_array($v1d696dbd12)) { foreach ($v1d696dbd12 as $v8c5df8072b => $pc661dc6b) { $v6939304e91 = $pc661dc6b["exits"]["layer_exit"]; $pef349725 = self::ma6cf47514905($v1d696dbd12, $v8c5df8072b, $v6939304e91, $pba9184cd); $pc37695cb = count($pef349725); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v9073377656 = $pef349725[$v43dd7d0051]; $pba9184cd[$v8c5df8072b][] = $v9073377656; $v78108fb2bd = $v9073377656["child_table"] == $v8c5df8072b ? $v9073377656["parent_table"] : $v9073377656["child_table"]; if ($v78108fb2bd) { if ($v78108fb2bd != $v8c5df8072b || $v9073377656["type"] == "1-*") { $v9073377656["type"] = $v9073377656["type"] == "*-1" ? "1-*" : ($v9073377656["type"] == "1-*" ? "*-1" : $v9073377656["type"]); $v9073377656["target"] = true; unset($v9073377656["source"]); $pba9184cd[$v78108fb2bd][] = $v9073377656; } } } } } return $pba9184cd; } private static function ma6cf47514905($v1d696dbd12, $v8c5df8072b, $v6939304e91, &$pba9184cd) { $pb88d9a1d = array(); if ($v6939304e91) { $v6939304e91 = isset($v6939304e91["task_id"]) ? array($v6939304e91) : $v6939304e91; $v0a1dac07d9 = self::getTablesConnectionTypes(); $pc37695cb = count($v6939304e91); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $pdcbd5e39 = $v6939304e91[$v43dd7d0051]; $pef349725 = $pdcbd5e39["properties"]; $v3fb9f41470 = $v0a1dac07d9[ $pdcbd5e39["overlay"] ]; $v3fb9f41470 = $v3fb9f41470 ? $v3fb9f41470 : "1-1"; $v78108fb2bd = self::ma994ee0975fa($v1d696dbd12, $pdcbd5e39["task_id"]); if ($v78108fb2bd) { $v9994512d98 = array(); if (!$pef349725 || !$pef349725["source_columns"]) { $pef349725 = array(); $pc3502754 = self::getTableAttributes($v1d696dbd12, $v8c5df8072b); $pe8584f8a = self::getTableAttributes($v1d696dbd12, $v78108fb2bd); $v58b4c471a1 = self::getTablePrimaryKeys($v1d696dbd12, $v8c5df8072b); $v506430ad75 = self::getTablePrimaryKeys($v1d696dbd12, $v78108fb2bd); $pf9145084 = array_intersect($pc3502754, $v506430ad75); $pe3023dac = array_intersect($pe8584f8a, $v58b4c471a1); if ($v3fb9f41470 == "*-*" || $v3fb9f41470 == "1-1") $v571a648e93 = array_merge($pf9145084, $pe3023dac); else if ($v3fb9f41470 == "*-1") $v571a648e93 = $pe3023dac; else if ($v3fb9f41470 == "1-*") $v571a648e93 = $pf9145084; if ($v571a648e93) { $pd28479e5 = count($v571a648e93); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) $v9994512d98[] = array("child" => $v571a648e93[$v9d27441e80], "parent" => $v571a648e93[$v9d27441e80]); } else if ($v3fb9f41470 == "*-1") { $pd28479e5 = count($v58b4c471a1); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) if ($v506430ad75[$v9d27441e80]) $v9994512d98[] = array("child" => $v58b4c471a1[$v9d27441e80], "parent" => $v506430ad75[$v9d27441e80]); } else { $pd28479e5 = count($v58b4c471a1); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) if ($v506430ad75[$v9d27441e80]) $v9994512d98[] = array("child" => $v506430ad75[$v9d27441e80], "parent" => $v58b4c471a1[$v9d27441e80]); } } else { $pd9cb6fd1 = $pef349725["source_columns"]; $v7884a11c4c = $pef349725["target_columns"]; if ($pd9cb6fd1) { if (!is_array($pd9cb6fd1)) { $pd9cb6fd1 = array($pd9cb6fd1); $v7884a11c4c = array($v7884a11c4c); } if ($v3fb9f41470 == "*-1") { $pd28479e5 = count($pd9cb6fd1); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) $v9994512d98[] = array("child" => $pd9cb6fd1[$v9d27441e80], "parent" => $v7884a11c4c[$v9d27441e80]); } else { $pd28479e5 = count($pd9cb6fd1); for ($v9d27441e80 = 0; $v9d27441e80 < $pd28479e5; $v9d27441e80++) $v9994512d98[] = array("child" => $v7884a11c4c[$v9d27441e80], "parent" => $pd9cb6fd1[$v9d27441e80]); } } } if ($v9994512d98) { if ($v3fb9f41470 == "1-*") $pb88d9a1d[] = array( "type" => $v3fb9f41470, "child_table" => $v78108fb2bd, "parent_table" => $v8c5df8072b, "keys" => $v9994512d98, "source" => true, ); else $pb88d9a1d[] = array( "type" => $v3fb9f41470, "child_table" => $v8c5df8072b, "parent_table" => $v78108fb2bd, "keys" => $v9994512d98, "source" => true, ); } } } } return $pb88d9a1d; } private static function ma994ee0975fa($v1d696dbd12, $v8282c7dd58) { foreach ($v1d696dbd12 as $v8c5df8072b => $v7f5911d32d) { if ($v8282c7dd58 == $v8c5df8072b) return $v8c5df8072b; else if ($v7f5911d32d["id"] == $v8282c7dd58) return $v7f5911d32d["label"]; } return null; } } ?>
