<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.phpscript.PHPScriptHandler"); include_once get_lib("org.phpframework.cms.wordpress.WordPressCMSBlockHandler"); include_once get_lib("org.phpframework.cms.wordpress.WordPressCMSBlockSettings"); class CMSExternalTemplateLayer { const CACHE_DIR_NAME = "cms/external_template_layer/"; public static function getParsedTemplateCode($v08d9602741, $v9e3513bc0e, $pc5a892eb) { $v067674f4e4 = self::getTemplateCode($v08d9602741, $v9e3513bc0e, $pc5a892eb); if ($v067674f4e4) { if (!empty($v9e3513bc0e["external_vars"]) && is_array($v9e3513bc0e["external_vars"])) $pc5a892eb = array_merge($pc5a892eb, $v9e3513bc0e["external_vars"]); return PHPScriptHandler::parseContent($v067674f4e4, $pc5a892eb); } } public static function getTemplateCode($v08d9602741, $v9e3513bc0e, $pc5a892eb) { if (is_array($v9e3513bc0e)) { $v492fce9a5d = isset($v9e3513bc0e["cache_ttl"]) ? $v9e3513bc0e["cache_ttl"] : null; if ($v492fce9a5d) { $pbc96d822 = $v08d9602741->getPresentationLayer()->getPHPFrameWork()->getObject("UserCacheHandler"); if ($pbc96d822) { $v84bd6a89cd = self::CACHE_DIR_NAME . md5(serialize($v9e3513bc0e)); $v492fce9a5d = $v492fce9a5d * 60; $pbc96d822->config($v492fce9a5d, false); if ($pbc96d822->isValid($v84bd6a89cd)) return $pbc96d822->read($v84bd6a89cd); } } $pc34fdd94 = isset($v9e3513bc0e["type"]) ? $v9e3513bc0e["type"] : null; switch($pc34fdd94) { case "project": $v067674f4e4 = self::f0fe404b6ae($v08d9602741, $v9e3513bc0e, $pc5a892eb); break; case "block": $v067674f4e4 = self::f7ee94a3561($v08d9602741, $v9e3513bc0e, $pc5a892eb); break; case "wordpress_template": $v067674f4e4 = self::f9eab0875b1($v08d9602741, $v9e3513bc0e, $pc5a892eb); break; case "url": $v067674f4e4 = self::f97b339109c($v08d9602741, $v9e3513bc0e, $pc5a892eb); break; default: launch_exception(new Exception("No template code to parse! Invalid template params: " . var_export($v9e3513bc0e, true))); } if ($v492fce9a5d && $pbc96d822) $pbc96d822->write($v84bd6a89cd, $v067674f4e4); return $v067674f4e4; } } private static function f0fe404b6ae($v08d9602741, $v9e3513bc0e, $pc5a892eb) { $v1495c93fca = isset($v9e3513bc0e["template_id"]) ? $v9e3513bc0e["template_id"] : null; if ($v1495c93fca) { $pea21d788 = isset($v9e3513bc0e["external_project_id"]) ? $v9e3513bc0e["external_project_id"] : null; $v8ea5ee2b30 = $v08d9602741->getTemplatePath($v1495c93fca, $pea21d788); if ($v8ea5ee2b30 && file_exists($v8ea5ee2b30)) { $pae77d38c = file_get_contents($v8ea5ee2b30); if (!empty($v9e3513bc0e["add_template_xml_regions_and_params"])) $pae77d38c = WordPressCMSBlockHandler::addTemplateXMLRegionsAndParamsToPHPTemplate($pae77d38c); if (!empty($v9e3513bc0e["keep_original_project_url_prefix"])) $pc5a892eb = self::mca017f6eac9f($v08d9602741, $v9e3513bc0e, $pc5a892eb); $v067674f4e4 = PHPScriptHandler::parseContent($pae77d38c, $pc5a892eb); $v067674f4e4 = WordPressCMSBlockHandler::convertContentsHtmlToPHPTemplate($v067674f4e4); return $v067674f4e4; } else { header("HTTP/1.0 404 Not Found"); launch_exception(new Exception("No template path for template id '$v1495c93fca' in template code 'parse_php_code.php'.")); } } else launch_exception(new Exception("No template id '$v1495c93fca' in template code 'parse_php_code.php'.")); } private static function mca017f6eac9f($EVC, $v9e3513bc0e, $pc5a892eb) { $pc5a892eb = $pc5a892eb ? $pc5a892eb : array(); $current_project_id = $EVC->getPresentationLayer()->getSelectedPresentationId(); $pea21d788 = isset($v9e3513bc0e["external_project_id"]) ? $v9e3513bc0e["external_project_id"] : null; $EVC->getPresentationLayer()->setSelectedPresentationId($pea21d788); $GLOBALS["presentation_id"] = $pea21d788; include $EVC->getConfigPath("config"); $pc5a892eb["original_project_url_prefix"] = $peb014cfd; $GLOBALS["presentation_id"] = $current_project_id; $EVC->getPresentationLayer()->setSelectedPresentationId($current_project_id); return $pc5a892eb; } private static function f7ee94a3561($EVC, $v9e3513bc0e, $pc5a892eb) { $v29fec2ceaa = isset($v9e3513bc0e["block_id"]) ? $v9e3513bc0e["block_id"] : null; if ($v29fec2ceaa) { $pea21d788 = isset($v9e3513bc0e["external_project_id"]) ? $v9e3513bc0e["external_project_id"] : null; $v303bc2287d = $EVC->getBlockPath($v29fec2ceaa, $pea21d788); if (file_exists($v303bc2287d)) { $block_local_variables = !empty($v9e3513bc0e["block_local_variables"]) ? $v9e3513bc0e["block_local_variables"] : array(); $pc5a892eb["block_local_variables"] = $block_local_variables; $pae77d38c = file_get_contents($v303bc2287d); $pae77d38c .= '<?php echo $EVC->getCMSLayer()->getCMSBlockLayer()->getBlock($block_id); ?>'; $v067674f4e4 = PHPScriptHandler::parseContent($pae77d38c, $pc5a892eb); $v067674f4e4 = WordPressCMSBlockHandler::convertContentsHtmlToPHPTemplate($v067674f4e4); return $v067674f4e4; } else { header("HTTP/1.0 404 Not Found"); launch_exception(new Exception("No block path for block id '$v29fec2ceaa' in template code 'parse_php_code.php'.")); } } else launch_exception(new Exception("No block id '$v29fec2ceaa' in template code 'parse_php_code.php'.")); } private static function f9eab0875b1($v08d9602741, $v9e3513bc0e, $pc5a892eb) { $pca670fe1 = isset($v9e3513bc0e["url_query"]) ? $v9e3513bc0e["url_query"] : null; $v872f5b4dbb = !empty($v9e3513bc0e["wordpress_installation_name"]) ? $v9e3513bc0e["wordpress_installation_name"] : (isset($GLOBALS["default_db_driver"]) ? $GLOBALS["default_db_driver"] : null); $peb014cfd = isset($pc5a892eb["project_url_prefix"]) ? $pc5a892eb["project_url_prefix"] : null; $v59560756be = array( "wordpress_folder" => $v872f5b4dbb, "wordpress_request_content_url" => $peb014cfd . "module/wordpress/get_html_contens/get_wordpress_content", "wordpress_request_content_connection_timeout" => WordPressCMSBlockSettings::getSetting("WORDPRESS_REQUEST_CONTENT_CONNECTION_TIMEOUT"), "wordpress_request_content_encryption_key" => WordPressCMSBlockSettings::getSetting("WORDPRESS_REQUEST_CONTENT_ENCRYPTION_KEY_HEX"), "cookies_prefix" => $v872f5b4dbb, ); $pc3b64b78 = array( "allowed_wordpress_urls" => isset($v9e3513bc0e["allowed_wordpress_urls"]) ? $v9e3513bc0e["allowed_wordpress_urls"] : null, "parse_wordpress_urls" => array_key_exists("parse_wordpress_urls", $v9e3513bc0e) ? $v9e3513bc0e["parse_wordpress_urls"] : true, "parse_wordpress_relative_urls" => array_key_exists("parse_wordpress_relative_urls", $v9e3513bc0e) ? $v9e3513bc0e["parse_wordpress_relative_urls"] : true, ); $v3ec20f02a8 = new WordPressCMSBlockHandler($v08d9602741, $v59560756be); $pae77d38c = $v3ec20f02a8->getBlockContent(null, $pca670fe1, $pc3b64b78); $v067674f4e4 = $pae77d38c && isset($pae77d38c["results"]["full_page_html"]) ? $pae77d38c["results"]["full_page_html"] : ""; $v067674f4e4 = WordPressCMSBlockHandler::convertContentsHtmlToPHPTemplate($v067674f4e4); return $v067674f4e4; } private static function f97b339109c($v08d9602741, $v9e3513bc0e, $pc5a892eb) { $v6f3a2700dd = isset($v9e3513bc0e["url"]) ? $v9e3513bc0e["url"] : null; if ($v6f3a2700dd) { $v1fc19b96e1 = parse_url($v6f3a2700dd, PHP_URL_HOST); $v7c0d95d431 = explode(":", $_SERVER["HTTP_HOST"]); $v7c0d95d431 = isset($v7c0d95d431[0]) ? $v7c0d95d431[0] : null; $v30857f7eca = array( "url" => $v6f3a2700dd, "cookie" => $v7c0d95d431 == $v1fc19b96e1 ? $_COOKIE : null, "settings" => array( "referer" => isset($_SERVER["HTTP_REFERER"]) ? $_SERVER["HTTP_REFERER"] : null, "follow_location" => 1, "connection_timeout" => isset($v9e3513bc0e["connection_timeout"]) ? $v9e3513bc0e["connection_timeout"] : null, ) ); $v56a64ecb97 = new MyCurl(); $v56a64ecb97->initSingle($v30857f7eca); $v56a64ecb97->get_contents(); $v539082ff30 = $v56a64ecb97->getData(); $pae77d38c = isset($v539082ff30[0]["content"]) ? $v539082ff30[0]["content"] : null; $v067674f4e4 = WordPressCMSBlockHandler::convertContentsHtmlToPHPTemplate($pae77d38c); } return $v067674f4e4; } } ?>
