<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.xmlfile.XMLFileParser"); include_once get_lib("org.phpframework.layer.presentation.cms.CMSLayer"); include_once get_lib("org.phpframework.layer.presentation.cms.exception.CMSModuleLayerException"); include_once get_lib("org.phpframework.layer.presentation.cms.module.CMSModuleHandler"); include_once get_lib("org.phpframework.layer.presentation.cms.module.CMSModuleSimulatorHandler"); include_once get_lib("org.phpframework.layer.presentation.cms.module.CMSModuleEnableHandler"); include_once get_lib("org.phpframework.layer.presentation.cms.cache.CMSModuleSettingsCacheHandler"); include_once get_lib("org.phpframework.layer.presentation.cms.CMSFileHandler"); class CMSModuleLayer { private $v874d5d2d79; private $pfcfd33a9; private $pc6325a70; private $v78e763b3b3; private $pfe208468; private $pc7ee1015 = false; private $v2d8437fe28 = false; public function __construct(CMSLayer $v874d5d2d79) { $this->v874d5d2d79 = $v874d5d2d79; $this->pfcfd33a9 = new CMSModuleSettingsCacheHandler(); $this->pc6325a70 = array(); $this->v78e763b3b3 = ""; $this->pfe208468 = ""; $this->mcdfff12f30fd(); } private function mcdfff12f30fd() { if ($this->v874d5d2d79->isCacheActive()) { $pbc7e2f66 = $this->v874d5d2d79->getCacheLayer()->getCMSModuleCacheLayer(); $pd8192d9d = $pbc7e2f66->getCachedDirPath(); if ($pd8192d9d) $this->pfcfd33a9->initCacheDirPath($pd8192d9d); } } public function setModulesFolderPath($v78e763b3b3) { $this->pc7ee1015 = true; $this->v78e763b3b3 = $v78e763b3b3 . (substr($v78e763b3b3, -1) == "/" ? "" : "/"); } public function getModulesFolderPath() { if (!$this->pc7ee1015) $this->setModulesFolderPath( $this->v874d5d2d79->getEVC()->getModulesPath( $this->v874d5d2d79->getEVC()->getCommonProjectName() ) ); return $this->v78e763b3b3; } public function setModulesWebrootFolderPath($pfe208468) { $this->v2d8437fe28 = true; $this->pfe208468 = $pfe208468 . (substr($pfe208468, -1) == "/" ? "" : "/"); } public function getModulesWebrootFolderPath() { if (!$this->v2d8437fe28) $this->setModulesWebrootFolderPath( $this->v874d5d2d79->getEVC()->getWebrootPath( $this->v874d5d2d79->getEVC()->getCommonProjectName() ) . "module/" ); return $this->pfe208468; } public function executeModule($pcd8c70bc, &$v30857f7eca = false, $pfd76dfba = false) { $v18521bca9a = $this->v874d5d2d79->isCacheActive(); if($v18521bca9a) { $pbc7e2f66 = $this->v874d5d2d79->getCacheLayer()->getCMSModuleCacheLayer(); if($pbc7e2f66->isValid($pcd8c70bc, $v30857f7eca)) { $v9ad1385268 = $pbc7e2f66->get($pcd8c70bc, $v30857f7eca); $v11486cddab = $v9ad1385268 ? true : false; } } if(!$v11486cddab) { $v7bc2e7898b = $this->getModuleObj($pcd8c70bc); $v9ad1385268 = null; if ($v7bc2e7898b) { $v7bc2e7898b->setCMSSettings($pfd76dfba); $v9ad1385268 = $v7bc2e7898b->execute($v30857f7eca); } if($v18521bca9a) $pbc7e2f66->check($pcd8c70bc, $v30857f7eca, $v9ad1385268); } return $v9ad1385268; } public function existsModule($pcd8c70bc, $pfe65ea32 = true) { try { $v7bc2e7898b = $this->getModuleObj($pcd8c70bc, $pfe65ea32); if ($v7bc2e7898b) return true; } catch (Exception $paec2c009) {} return false; } public function getModuleObj($pcd8c70bc, $pfe65ea32 = true) { $pf161ce74 = substr($pf161ce74, strlen($pf161ce74) - 1, 1) == "/" ? substr($pf161ce74, 0, strlen($pf161ce74) - 1) : $pf161ce74; $pdd397f0a = $this->getModulesFolderPath() . $pcd8c70bc . "/"; $pf3dc0762 = CMSModuleHandler::getCMSModuleHandlerImplFilePath($pdd397f0a); $v3ae55a9a2e = "CMSModule\\" . str_replace("/", "\\", str_replace(" ", "_", trim($pcd8c70bc))) . "\\CMSModuleHandlerImpl"; try { if (!class_exists($v3ae55a9a2e)) { if (file_exists($pf3dc0762)) include_once $pf3dc0762; else launch_exception(new CMSModuleLayerException(5, array($pcd8c70bc, $pf3dc0762) )); } eval('$CMSModuleHandler = new ' . $v3ae55a9a2e . '();'); if ($CMSModuleHandler) { if (is_a($CMSModuleHandler, "CMSModuleHandler")) { $v35654e4ed2 = CMSModuleEnableHandler::getModuleEnabledFilePath($pdd397f0a); if (@include($v35654e4ed2)) { if ($CMSModuleHandler->isEnabled()) { $CMSModuleHandler->setEVC( $this->v874d5d2d79->getEVC() ); $CMSModuleHandler->setModuleId($pcd8c70bc); return $CMSModuleHandler; } } launch_exception(new CMSModuleLayerException(5, array($pcd8c70bc, $pf3dc0762))); } else launch_exception(new CMSModuleLayerException(2, $pf3dc0762)); } else launch_exception(new CMSModuleLayerException(3, $pf3dc0762)); } catch (Exception $paec2c009) { launch_exception($paec2c009); } return null; } public function getModuleSimulatorObj($pcd8c70bc, $pfe65ea32 = true) { $pf161ce74 = substr($pf161ce74, strlen($pf161ce74) - 1, 1) == "/" ? substr($pf161ce74, 0, strlen($pf161ce74) - 1) : $pf161ce74; $pdd397f0a = $this->getModulesFolderPath() . $pcd8c70bc . "/"; $pf3dc0762 = CMSModuleSimulatorHandler::getCMSModuleSimulatorHandlerImplFilePath($pdd397f0a); $v3ae55a9a2e = "CMSModule\\" . str_replace("/", "\\", str_replace(" ", "_", trim($pcd8c70bc))) . "\\CMSModuleSimulatorHandlerImpl"; try { if (!class_exists($v3ae55a9a2e) && file_exists($pf3dc0762)) include_once $pf3dc0762; if (class_exists($v3ae55a9a2e)) { eval('$CMSModuleSimulatorHandler = new ' . $v3ae55a9a2e . '();'); if ($CMSModuleSimulatorHandler) { if (is_a($CMSModuleSimulatorHandler, "CMSModuleSimulatorHandler")) return $CMSModuleSimulatorHandler; else launch_exception(new CMSModuleLayerException(7, $pf3dc0762)); } else launch_exception(new CMSModuleLayerException(8, $pf3dc0762)); } } catch (Exception $paec2c009) { launch_exception($paec2c009); } return null; } public function loadModules($v22e4f0dcff) { $v78e763b3b3 = $this->getModulesFolderPath(); if ($v78e763b3b3 && is_dir($v78e763b3b3)) { $v78e763b3b3 .= substr($v78e763b3b3, strlen($v78e763b3b3) - 1, 1) == "/" ? "" : "/"; $pfe208468 = $this->getModulesWebrootFolderPath(); $pfe208468 .= substr($pfe208468, strlen($pfe208468) - 1, 1) == "/" ? "" : "/"; $v1527ad546e = $this->pfcfd33a9->getCachedId( array($v22e4f0dcff, $v78e763b3b3) ); if ($this->pfcfd33a9->isActive() && $this->pfcfd33a9->cachedLoadedModulesExists($v1527ad546e)) $pc6325a70 = $this->pfcfd33a9->getCachedLoadedModules($v1527ad546e); if (empty($pc6325a70)) { $pc6325a70 = $this->f5c13394ef0($v22e4f0dcff, $v78e763b3b3, $v78e763b3b3, $pfe208468); if ($this->pfcfd33a9->isActive()) $this->pfcfd33a9->setCachedLoadedModules($v1527ad546e, $pc6325a70); } $this->pc6325a70 = $pc6325a70; return true; } launch_exception(new CMSModuleLayerException(1, $v78e763b3b3)); return false; } private function f5c13394ef0($v22e4f0dcff, $pdd397f0a, $pe61ee068, $pfe208468) { $pc6325a70 = array(); if (($v89d33f4133 = opendir($pdd397f0a)) ) { while( ($v7dffdb5a5b = readdir($v89d33f4133)) !== false) { if (substr($v7dffdb5a5b, 0, 1) != ".") { $v9a84a79e2e = $pdd397f0a . $v7dffdb5a5b; if (is_dir($v9a84a79e2e)) { $pd66dbcd0 = CMSModuleHandler::getCMSModuleHandlerImplFilePath($v9a84a79e2e); $pa68661d5 = $v9a84a79e2e . "/module.xml"; if (file_exists($pd66dbcd0) || file_exists($pa68661d5)) { $pcd8c70bc = str_replace($pe61ee068, "", $v9a84a79e2e); if (file_exists($pa68661d5)) { $pfb662071 = XMLFileParser::parseXMLFileToArray($pa68661d5); $pfb662071 = MyXML::complexArrayToBasicArray($pfb662071, array("lower_case_keys" => true, "trim" => true)); $pfb662071 = $pfb662071["module"]; } else $pfb662071 = array(); $v9acc88059e = is_array($pfb662071["label"]) ? $pfb662071["label"][0] : $pfb662071["label"]; $v9acc88059e = $v9acc88059e ? $v9acc88059e : $pcd8c70bc; $pd2c744e8 = is_array($pfb662071["description"]) ? $pfb662071["description"][0] : $pfb662071["description"]; $pbb5dfe21 = is_array($pfb662071["load_module_settings_js_function"]) ? $pfb662071["load_module_settings_js_function"][0] : $pfb662071["load_module_settings_js_function"]; $v4c1437c981 = $pfb662071["is_reserved_module"] == "true" || $pfb662071["is_reserved_module"] == "1"; $v063d82ad43 = $pfb662071["is_hidden_module"] == "true" || $pfb662071["is_hidden_module"] == "1"; $pbd1bc7b0 = strpos($pcd8c70bc, "/"); $v919c63182d = $pbd1bc7b0 > 0 ? substr($pcd8c70bc, 0, $pbd1bc7b0) : $pcd8c70bc; $v68d7ee2dbe = $pe61ee068 . $v919c63182d . "/admin/"; $pe5e6f5c5 = $v9a84a79e2e . "/CMSModuleSettingsHtml.php"; $pf4c3dc70 = CMSFileHandler::getFileIncludeJoinPoints($pd66dbcd0); $pc8b88eb4 = array( "id" => $pcd8c70bc, "is_reserved_module" => $v4c1437c981, "is_hidden_module" => $v063d82ad43, "path" => $v9a84a79e2e . "/", "module_handler_impl_file_path" => file_exists($pd66dbcd0) ? $pd66dbcd0 : null, "module_handler_html_file_path" => file_exists($pe5e6f5c5) ? $pe5e6f5c5 : null, "webroot_path" => $pfe208468 . $pcd8c70bc . "/", "webroot_url" => $v22e4f0dcff . $pcd8c70bc . "/", "label" => $v9acc88059e, "description" => $pd2c744e8, "images" => array(), "load_module_settings_js_function" => $pbb5dfe21, "group_id" => $v919c63182d, "admin_path" => file_exists($v68d7ee2dbe . "index.php") ? $v68d7ee2dbe : null, "join_points" => $pf4c3dc70, ); $pbf4c5114 = !$pfb662071["image"] || is_array($pfb662071["image"]) ? $pfb662071["image"] : array($pfb662071["image"]); $pc37695cb = $pbf4c5114 ? count($pbf4c5114) : 0; for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v2753904f48 = $pbf4c5114[$v43dd7d0051]; if (file_exists($pc8b88eb4["webroot_path"] . $v2753904f48)) { $pc8b88eb4["images"][] = array( "path" => $pc8b88eb4["webroot_path"] . $v2753904f48, "url" => $pc8b88eb4["webroot_url"] . $v2753904f48, ); } } $pc6325a70[ $pcd8c70bc ] = $pc8b88eb4; } else { $pfa37f3ba = $this->f5c13394ef0($v22e4f0dcff, $v9a84a79e2e . "/", $pe61ee068, $pfe208468); $pc6325a70 = array_merge($pc6325a70, $pfa37f3ba); } } } } closedir($v89d33f4133); } return $pc6325a70; } public function getModuleHtml($pc8b88eb4) { if ($pc8b88eb4 && $pc8b88eb4["module_handler_html_file_path"] && file_exists($pc8b88eb4["module_handler_html_file_path"])) { $pae77d38c = file_get_contents($pc8b88eb4["module_handler_html_file_path"]); $v91158153da = pathinfo($pc8b88eb4["module_handler_html_file_path"], PATHINFO_EXTENSION); if (strtolower($v91158153da) == "php") { $pc5a892eb = array("module" => $pc8b88eb4, "EVC" => $this->v874d5d2d79->getEVC()); $pae77d38c = PHPScriptHandler::parseContent($pae77d38c, $pc5a892eb); } return $pae77d38c; } } public function getLoadedModules() { return $this->pc6325a70; } public function getLoadedModule($pcd8c70bc) { return $this->pc6325a70[$pcd8c70bc]; } public function freeModuleCache() { if ($this->pfcfd33a9->isActive()) { $pd8192d9d = $this->pfcfd33a9->getCacheRootPath(); if ($pd8192d9d) return CacheHandlerUtil::deleteFolder($pd8192d9d, false); } } } ?>
