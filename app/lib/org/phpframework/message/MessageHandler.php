<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include get_lib("org.phpframework.message.Message"); include_once get_lib("org.phpframework.cache.service.filesystem.FileSystemServiceCacheHandler"); include_once get_lib("org.phpframework.module.ModuleCacheLayer"); include_once get_lib("org.phpframework.module.ModulePathHandler"); include_once get_lib("org.phpframework.xmlfile.XMLFileParser"); class MessageHandler { private $pdbfb6662 = array(); private $pca1bd72b = array(); private $pdba2ecf9 = array(); private $v4ab372da3a; private $v30857f7eca = array(); private $pe61ee068 = array(); private $pba90b1c3; private $pad21ece4; private $v25fa527067 = "__system/modules_messages_cache/"; public function __construct($v30857f7eca = array()) { $this->v30857f7eca = $v30857f7eca; if (!empty($this->v30857f7eca["no_cache"])) $this->pba90b1c3 = false; else { $v58e068762a = isset($this->v30857f7eca["messages_module_cache_maximum_size"]) ? $this->v30857f7eca["messages_module_cache_maximum_size"] : null; $pc5f82be2 = isset($this->v30857f7eca["messages_cache_path"]) ? $this->v30857f7eca["messages_cache_path"] : null; $v9b01b90927 = isset($this->v30857f7eca["messages_default_cache_ttl"]) ? $this->v30857f7eca["messages_default_cache_ttl"] : null; $v2d969168c8 = isset($this->v30857f7eca["messages_default_cache_type"]) ? $this->v30857f7eca["messages_default_cache_type"] : null; $this->pba90b1c3 = new FileSystemServiceCacheHandler($v58e068762a); $this->pba90b1c3->setRootPath($pc5f82be2); $this->pba90b1c3->setDefaultTTL($v9b01b90927); $this->pba90b1c3->setDefaultType($v2d969168c8); } $this->pad21ece4 = new ModuleCacheLayer($this); } public function getModuleCachedLayerDirPath() { return $this->pba90b1c3 ? $this->pba90b1c3->getRootPath() : false; } public function setRootPath($v4ab372da3a) {$this->v4ab372da3a = $v4ab372da3a;} public function getRootPath() {return $this->v4ab372da3a;} public function addMessage($pcd8c70bc, $v6c180ea7d9, $pffa799aa, $pfdbbc383 = false) { $v31b87330b6 = new Message(); $v31b87330b6->setModule($pcd8c70bc); $v31b87330b6->setId($v6c180ea7d9); $v31b87330b6->setMessage($pffa799aa); $v31b87330b6->setAttributes($pfdbbc383); $this->pdbfb6662[$pcd8c70bc][strtolower($v6c180ea7d9)] = $v31b87330b6; } public function getMessages($pcd8c70bc, $pfdbbc383 = false) { if (!isset($this->pdbfb6662[$pcd8c70bc])) $this->f6ed2a57e39($pcd8c70bc); $v0684c7a812 = isset($this->pdbfb6662[$pcd8c70bc]) ? $this->pdbfb6662[$pcd8c70bc] : null; if (is_array($pfdbbc383) && count($pfdbbc383)) { $v8c51326d17 = array(); foreach ($v0684c7a812 as $v6c180ea7d9 => $v31b87330b6) { if ($v31b87330b6->checkAttributes($pfdbbc383)) $v8c51326d17[$v6c180ea7d9] = $v31b87330b6; } return $v8c51326d17; } return $v0684c7a812 ? $v0684c7a812 : array(); } public function getMessage($pcd8c70bc, $v6c180ea7d9) { $v0684c7a812 = $this->getMessages($pcd8c70bc); $v6c180ea7d9 = strtolower($v6c180ea7d9); return isset($v0684c7a812[$v6c180ea7d9]) ? $v0684c7a812[$v6c180ea7d9] : false; } public function reportMessage($pcd8c70bc, $v6c180ea7d9) { $v31b87330b6 = $this->getMessage($pcd8c70bc, $v6c180ea7d9); if ($v31b87330b6) { $pbfa01ed1 = md5("{$pcd8c70bc}_{$v6c180ea7d9}"); if (!in_array($pbfa01ed1, $this->pdba2ecf9)) { $this->pca1bd72b[] = $v31b87330b6; $this->pdba2ecf9[] = $pbfa01ed1; } } return true; } public function getReportedMessages($pfdbbc383 = false) { if ($pfdbbc383) { $v4ba6a5e8d7 = array(); $pc37695cb = count($this->pca1bd72b); for ($v43dd7d0051 = 0; $v43dd7d0051 < $pc37695cb; $v43dd7d0051++) { $v31b87330b6 = $this->pca1bd72b[$v43dd7d0051]; if ($v31b87330b6->checkAttributes($pfdbbc383)) $v4ba6a5e8d7[] = $v31b87330b6; } return $v4ba6a5e8d7; } return $this->pca1bd72b; } public function emptyReportedMessages() { $this->pca1bd72b = array(); } private function f6ed2a57e39($pcd8c70bc) { $pf3dc0762 = $this->f394921c199($pcd8c70bc); if ($pf3dc0762) { if ($this->pba90b1c3 && $this->pba90b1c3->isValid($this->v25fa527067, $pcd8c70bc)) $v0684c7a812 = $this->pba90b1c3->get($this->v25fa527067, $pcd8c70bc); else { $v538cb1a1f7 = ""; $v50d32a6fc4 = XMLFileParser::parseXMLFileToArray($pf3dc0762, array("vars" => $this->v30857f7eca), $v538cb1a1f7); $pa266c7f5 = is_array($v50d32a6fc4) ? array_keys($v50d32a6fc4) : array(); $pa266c7f5 = isset($pa266c7f5[0]) ? $pa266c7f5[0] : null; $pc4222023 = $pa266c7f5 && isset($v50d32a6fc4[$pa266c7f5][0]["childs"]) ? $v50d32a6fc4[$pa266c7f5][0]["childs"] : null; $v0684c7a812 = self::mfab024e40ddf($pc4222023); if ($this->pba90b1c3) $this->pba90b1c3->create($this->v25fa527067, $pcd8c70bc, $v0684c7a812); } $this->pdbfb6662[$pcd8c70bc] = $v0684c7a812; } } private static function mfab024e40ddf($v50d32a6fc4, $pa78fb38d = "") { $v0684c7a812 = array(); foreach ($v50d32a6fc4 as $pbfa01ed1 => $v29680e12e6) { $v16ac35fd79 = $v29680e12e6 ? count($v29680e12e6) : 0; if ($pbfa01ed1 == "message") { for ($v43dd7d0051 = 0; $v43dd7d0051 < $v16ac35fd79; $v43dd7d0051++) { $pffa799aa = $v29680e12e6[$v43dd7d0051]; $v1cbfbb49c5 = $pa78fb38d . XMLFileParser::getAttribute($pffa799aa, "id"); $v67db1bd535 = XMLFileParser::getValue($pffa799aa); $v31b87330b6 = new Message(); $v31b87330b6->setModule($pcd8c70bc); $v31b87330b6->setId($v1cbfbb49c5); $v31b87330b6->setMessage($v67db1bd535); $v31b87330b6->setAttributes(isset($pffa799aa["@"]) ? $pffa799aa["@"] : null); $v0684c7a812[ strtolower($v1cbfbb49c5) ] = $v31b87330b6; } } else { for ($v43dd7d0051 = 0; $v43dd7d0051 < $v16ac35fd79; $v43dd7d0051++) { $v90dc948ed7 = isset($v29680e12e6[$v43dd7d0051]["name"]) ? $v29680e12e6[$v43dd7d0051]["name"] : null; $v450a6f842f = isset($v29680e12e6[$v43dd7d0051]["childs"]) ? $v29680e12e6[$v43dd7d0051]["childs"] : null; $v3e4268a635 = self::mfab024e40ddf($v450a6f842f, $v90dc948ed7 . "/"); $v0684c7a812 = array_merge($v0684c7a812, $v3e4268a635); } } } return $v0684c7a812; } private function f394921c199($pcd8c70bc) { if (empty($this->v30857f7eca["messages_modules_file_path"])) launch_exception(new Exception("MessageHandler->settings[messages_modules_file_path]")); if (empty($this->v30857f7eca["messages_path"])) launch_exception(new Exception("MessageHandler->settings[messages_path]")); return ModulePathHandler::getModuleFilePath($pcd8c70bc, $this->v30857f7eca["messages_modules_file_path"], $this->v30857f7eca["messages_path"], $this->pe61ee068, $this->v30857f7eca, $this->pad21ece4); } } ?>
