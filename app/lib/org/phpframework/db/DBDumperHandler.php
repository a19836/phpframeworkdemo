<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

include_once get_lib("org.phpframework.compression.FileCompressionFactory"); include_once get_lib("org.phpframework.db.IDB"); include_once get_lib("org.phpframework.db.dump.DBDumper"); class DBDumperHandler { const MAX_LINE_SIZE = 1000000; const GZIP = 'Gzip'; const BZIP2 = 'Bzip2'; const NONE = 'None'; const GZIPSTREAM = 'Gzipstream'; const ZIP = 'Zip'; const UTF8 = 'utf8'; const UTF8MB4 = 'utf8mb4'; public $output_file_path = 'php://stdout'; private $pac4bc40a = array(); private $pfef454b4 = array(); private $v921e35db25 = array(); private $v2872dea9ed = array(); private $v83be22c76f = array(); private $v07cbca7136 = array(); private $v739116b5b3 = array(); private $pad5cfe31 = array(); private $v1496ce0491 = array(); private $v3d168242ec = array(); private $v12efdd30d7 = array(); private $pff4a669e = array(); private $pafc99f2d; private $pf676831f; private $peb764c64; private $pb10cc6a4; private $v87e4fe1181 = null; private $pb6f5aa83 = null; private $v7c2fe1aa6f = null; private $pc5a23cfc = array(); private $pf70a37a5 = array(); private $pd9c00b9b = false; private $pdca59010 = null; private $v720f8b85d5 = array( 'include-tables' => array(), 'exclude-tables' => array(), 'include-views' => array(), 'compress' => self::NONE, 'init_commands' => array(), 'no-data' => array(), 'reset-auto-increment' => false, 'add-drop-database' => false, 'add-drop-table' => true, 'add-drop-trigger' => false, 'add-drop-routine' => false, 'add-drop-event' => false, 'add-locks' => true, 'complete-insert' => false, 'databases' => false, 'default-character-set' => self::UTF8, 'disable-keys' => true, 'extended-insert' => true, 'events' => false, 'hex-blob' => false, 'insert-ignore' => false, 'net_buffer_length' => self::MAX_LINE_SIZE, 'no-autocommit' => true, 'no-create-info' => false, 'lock-tables' => true, 'routines' => false, 'single-transaction' => false, 'skip-triggers' => false, 'skip-tz-utc' => false, 'skip-comments' => false, 'skip-dump-date' => false, 'skip-definer' => false, 'where' => '', ); private $pd46f232b = array( PDO::ATTR_PERSISTENT => true, PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION, PDO::ATTR_ORACLE_NULLS => PDO::NULL_NATURAL, ); public function __construct(IDB $v87e4fe1181, $pc5a23cfc = array(), $pf70a37a5 = array()) { if (!$v87e4fe1181) throw new Exception("DBDriver cannot be null!"); $this->v87e4fe1181 = $v87e4fe1181; $this->pdca59010 = $this->v87e4fe1181->getOptions(); $this->init($pc5a23cfc, $pf70a37a5); } public function __destruct() { $this->disconnect(); } public function reset() { $this->pac4bc40a = array(); $this->pfef454b4 = array(); $this->v921e35db25 = array(); $this->v2872dea9ed = array(); $this->v83be22c76f = array(); $this->v07cbca7136 = array(); $this->v739116b5b3 = array(); $this->pad5cfe31 = array(); $this->v1496ce0491 = array(); $this->v3d168242ec = array(); $this->v12efdd30d7 = array(); $this->pff4a669e = array(); } public function init($pc5a23cfc, $pf70a37a5) { $this->initDBDumperSettings($pc5a23cfc); $this->initPdoDBConnectionSettings($pf70a37a5); $this->initFileCompressionHandler(); } public function initDBDumperSettings($pc5a23cfc) { $this->pc5a23cfc = $pc5a23cfc ? array_replace_recursive($this->v720f8b85d5, $pc5a23cfc) : $this->v720f8b85d5; if ($this->getDBDriverType() === "mysql") { if (!is_array($this->pc5a23cfc['init_commands'])) $this->pc5a23cfc['init_commands'] = $this->pc5a23cfc['init_commands'] ? array($this->pc5a23cfc['init_commands']) : array(); if ($this->pc5a23cfc['skip-tz-utc'] === false) array_unshift($this->pc5a23cfc['init_commands'], "SET TIME_ZONE='+00:00'"); array_unshift($this->pc5a23cfc['init_commands'], "SET NAMES " . $this->pc5a23cfc['default-character-set']); } $v3b94444af0 = array_diff(array_keys($this->pc5a23cfc), array_keys($this->v720f8b85d5)); if (count($v3b94444af0) > 0) throw new Exception("Unexpected value in db_dumper_settings: (" . implode(",", $v3b94444af0) . ")"); if (!is_array($this->pc5a23cfc['include-tables']) || !is_array($this->pc5a23cfc['exclude-tables'])) throw new Exception("Include-tables and exclude-tables must be array variables"); if (!isset($pc5a23cfc['include-views'])) $this->pc5a23cfc['include-views'] = $this->pc5a23cfc['include-tables']; } public function initPdoDBConnectionSettings($pf70a37a5) { if ($this->getDBDriverType() === "mysql") $this->pd46f232b[PDO::MYSQL_ATTR_USE_BUFFERED_QUERY] = false; else unset($this->pd46f232b[PDO::MYSQL_ATTR_USE_BUFFERED_QUERY]); $this->pf70a37a5 = $pf70a37a5 ? array_replace_recursive($this->pd46f232b, $pf70a37a5) : $this->pd46f232b; } public function initFileCompressionHandler() { $this->pb6f5aa83 = FileCompressionFactory::create($this->pc5a23cfc['compress']); } public function setDBDumperSettings($pc5a23cfc) { if (!$pc5a23cfc) $pc5a23cfc = array(); $this->reset(); $v3b94444af0 = array_diff(array_keys($pc5a23cfc), array_keys($this->v720f8b85d5)); if (count($v3b94444af0) > 0) throw new Exception("Unexpected value in \$db_dumper_settings: (" . implode(",", $v3b94444af0) . ")"); if ((array_key_exists('include-tables', $pc5a23cfc) && !is_array($pc5a23cfc['include-tables'])) || (array_key_exists('exclude-tables', $pc5a23cfc) && !is_array($pc5a23cfc['exclude-tables']))) throw new Exception("Include-tables and exclude-tables must be array variables"); if (array_key_exists('init_commands', $pc5a23cfc)) { if (!is_array($pc5a23cfc['init_commands'])) $pc5a23cfc['init_commands'] = $pc5a23cfc['init_commands'] ? array($pc5a23cfc['init_commands']) : array(); if ($this->isConnected()) throw new Exception("'init_commands' cannot be executed because the " . $this->getDBDriverType() . " connection was already initialized! To proceed, please disconnect this driver connection and then call the DBDumperHandler->initDBDumperSettings(db_dumper_settings) method"); else if ($this->getDBDriverType() === "mysql") { if ($pc5a23cfc['skip-tz-utc'] === false) array_unshift($pc5a23cfc['init_commands'], "SET TIME_ZONE='+00:00'"); array_unshift($pc5a23cfc['init_commands'], "SET NAMES " . $this->pc5a23cfc['default-character-set']); } } if (!isset($pc5a23cfc['include-views']) && isset($pc5a23cfc['include-tables'])) $pc5a23cfc['include-views'] = $pc5a23cfc['include-tables']; $v111626f12d = $pc5a23cfc['compress'] != $this->pc5a23cfc['compress']; $this->pc5a23cfc = array_replace_recursive($this->pc5a23cfc, $pc5a23cfc); if ($v111626f12d) $this->initFileCompressionHandler(); } public function setPdoDBConnectionSettings($pf70a37a5) { $this->pf70a37a5 = $pf70a37a5 ? array_replace_recursive($this->pd46f232b, $pf70a37a5) : $this->pd46f232b; } public function setTableExtraSql($v8c5df8072b, $v3c76382d93) { $this->v2872dea9ed[$v8c5df8072b] .= $v3c76382d93; } public function setTableLimits($v07cbca7136) { if (!is_array($v07cbca7136)) return false; $this->v07cbca7136 = $v07cbca7136; return true; } public function getTableLimit($v8c5df8072b) { if (!$this->v07cbca7136 || !array_key_exists($v8c5df8072b, $this->v07cbca7136)) return false; $v552b831ecd = $this->v07cbca7136[$v8c5df8072b]; if (is_numeric($v552b831ecd)) return $v552b831ecd; return false; } public function setTableSQLConditions($v739116b5b3) { if (!is_array($v739116b5b3)) return false; $this->v739116b5b3 = $v739116b5b3; return true; } public function getTableSQLCondition($v8c5df8072b) { if ($this->v739116b5b3[$v8c5df8072b]) return $this->v739116b5b3[$v8c5df8072b]; else if ($this->pc5a23cfc['where']) return $this->pc5a23cfc['where']; return false; } public function isConnected() { return $this->v87e4fe1181->isConnected(); } public function getDBDumperSettings() { return $this->pc5a23cfc; } public function getDBDriver() { return $this->v87e4fe1181; } public function getFileCompressionHandler() { return $this->pb6f5aa83; } public function getDBDriverType() { return $this->v87e4fe1181->getType(); } public function getConnectionSelectedDBName() { return $this->v87e4fe1181->getOption("db_name"); } public function connect() { try { $v5d3813882f = $this->v87e4fe1181->getOptions(); if (!$this->v87e4fe1181->isConnected()) { $v5d3813882f["pdo_settings"] = $v5d3813882f["pdo_settings"] ? array_merge($v5d3813882f["pdo_settings"], $this->pf70a37a5) : $this->pf70a37a5; $this->v87e4fe1181->setOptions($v5d3813882f); $this->v87e4fe1181->connect(); $this->pd9c00b9b = true; } else if ($this->pf70a37a5 && $this->v87e4fe1181->getConnectionPHPExtensionType() == "pdo") { foreach ($this->pf70a37a5 as $pe5c5e2fe => $v956913c90f) if (!$v5d3813882f["pdo_settings"] || !isset($v5d3813882f["pdo_settings"][$pe5c5e2fe]) || $v5d3813882f["pdo_settings"][$pe5c5e2fe] != $v956913c90f) $this->v87e4fe1181->getConnectionLink()->setAttribute($pe5c5e2fe, $v956913c90f); $v5d3813882f["pdo_settings"] = $v5d3813882f["pdo_settings"] ? array_merge($v5d3813882f["pdo_settings"], $this->pf70a37a5) : $this->pf70a37a5; $this->v87e4fe1181->setOptions($v5d3813882f); } if ($this->pc5a23cfc['init_commands']) foreach ($this->pc5a23cfc['init_commands'] as $v5faa4b8a01) $this->v87e4fe1181->setSQL($v5faa4b8a01); try { $this->pafc99f2d = $this->v87e4fe1181->getVersion(); } catch (Exception $paec2c009) { $this->pafc99f2d = 0; } } catch (Exception $paec2c009) { echo "SB connection to " . $this->getDBDriverType()." failed: " . $paec2c009->getMessage() . "\n"; throw $paec2c009; } $this->v7c2fe1aa6f = DBDumper::create($this->v87e4fe1181, $this); return $this->v87e4fe1181->isConnected(); } public function disconnect() { if (!$this->pd9c00b9b || $this->v87e4fe1181->disconnect()) { if ($this->pdca59010) $this->v87e4fe1181->setOptions($this->pdca59010); return true; } return false; } public function run($v94983b9e6c = '') { if (!empty($v94983b9e6c)) $this->output_file_path = $v94983b9e6c; if (!$this->isConnected()) { throw new Exception("Exception on DBDumperHandler::start method because probably the " . $this->getDBDriverType()." DB is not connected"); return; } $this->pb6f5aa83->open($this->output_file_path); $v39e1347c93 = $this->f52878d18fc(); $v39e1347c93 .= $this->v7c2fe1aa6f->backupParameters(); if ($this->pc5a23cfc['databases']) { $v39e1347c93 .= $this->v7c2fe1aa6f->getDatabaseHeader( $this->getConnectionSelectedDBName() ); if ($this->pc5a23cfc['add-drop-database']) $v39e1347c93 .= $this->v7c2fe1aa6f->getDropDatabaseStmt( $this->getConnectionSelectedDBName() ); } $this->pb6f5aa83->write($v39e1347c93); $this->f985a3a31c7(); $this->f46f919a404(); $this->f3df198bf92(); $this->mfda752e955e3(); $this->me0271330d45a(); $this->f322bbc8224(); if ($this->pc5a23cfc['databases']) { $v39e1347c93 = $this->v7c2fe1aa6f->databases( $this->getConnectionSelectedDBName() ); $this->pb6f5aa83->write($v39e1347c93); } if (count($this->pc5a23cfc['include-tables']) > 0) { $v5e813b295b = implode(",", $this->pc5a23cfc['include-tables']); throw new Exception("Error: User table (" . $v5e813b295b . ") does NOT exists in database"); } $this->medfd6a1aca88(); $this->f93d64366b7(); $this->mdc00b732734a(); $this->f88dc0275df(); $this->f4c741a8701(); $this->macae72d831ed(); $v39e1347c93 = $this->v7c2fe1aa6f->restoreParameters(); $v39e1347c93 .= $this->mfe70da39a69c(); $this->pb6f5aa83->write($v39e1347c93); $this->pb6f5aa83->close(); return true; } private function f52878d18fc() { $v6c438ea8cd = ''; if (!$this->pc5a23cfc['skip-comments']) { $v244067a7fe = $this->v87e4fe1181->getoption("host"); $v6c438ea8cd = "--" . PHP_EOL . "-- Host: {$v244067a7fe}" . PHP_EOL . "-- Database: " . $this->getConnectionSelectedDBName() . PHP_EOL . "-- ------------------------------------------------------" . PHP_EOL; if (!empty($this->pafc99f2d)) $v6c438ea8cd .= "-- Server version: " . $this->pafc99f2d . PHP_EOL; if (!$this->pc5a23cfc['skip-dump-date']) $v6c438ea8cd .= "-- Date: " . date('r') . PHP_EOL . PHP_EOL; } return $v6c438ea8cd; } private function mfe70da39a69c() { $v4d8c145c21 = ''; if (!$this->pc5a23cfc['skip-comments']) { $v4d8c145c21 .= '-- Dump completed'; if (!$this->pc5a23cfc['skip-dump-date']) $v4d8c145c21 .= ' on: ' . date('r'); $v4d8c145c21 .= PHP_EOL; } return $v4d8c145c21; } private function f985a3a31c7() { $v3c76382d93 = $this->v7c2fe1aa6f->getShowTablesStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); if ($v3dd67d635b) { if (empty($this->pc5a23cfc['include-tables'])) { foreach ($v3dd67d635b as $pff59654a) { $v5e813b295b = current($pff59654a); if ($v5e813b295b) $this->pac4bc40a[] = $v5e813b295b; } } else { foreach ($v3dd67d635b as $pff59654a) { $v5e813b295b = current($pff59654a); if ($v5e813b295b && in_array($v5e813b295b, $this->pc5a23cfc['include-tables'], true)) { $this->pac4bc40a[] = $v5e813b295b; $pd69fb7d0 = array_search($v5e813b295b, $this->pc5a23cfc['include-tables']); unset($this->pc5a23cfc['include-tables'][$pd69fb7d0]); } } } $this->mc0b9922fbaa1(); } return; } private function mc0b9922fbaa1() { $this->pfef454b4 = array(); $v6be2309ce7 = array(); foreach ($this->pac4bc40a as $v43dd7d0051 => $pc661dc6b) if (!in_array($pc661dc6b, $v6be2309ce7)) { $this->pfef454b4[$pc661dc6b] = array(); $v3c76382d93 = $this->v7c2fe1aa6f->getShowForeignKeysStmt($pc661dc6b); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) if ($pff59654a) { if (!isset($pff59654a['child_column']) || !isset($pff59654a['parent_table']) || !isset($pff59654a['parent_column']) || !isset($pff59654a['constraint_name'])) throw new \Exception("Error getting table foreign keys, unknown output"); array_push($this->pfef454b4[$pc661dc6b], $pff59654a); } if ($this->pfef454b4[$pc661dc6b]) { unset($this->pac4bc40a[$v43dd7d0051]); array_push($this->pac4bc40a, $pc661dc6b); } } $v7bb8636f3b = array(); $this->pac4bc40a = array_values($this->pac4bc40a); for ($v43dd7d0051 = 0; $v43dd7d0051 < count($this->pac4bc40a); $v43dd7d0051++) { $pc661dc6b = $this->pac4bc40a[$v43dd7d0051]; if ($this->pfef454b4[$pc661dc6b]) { foreach ($this->pfef454b4[$pc661dc6b] as $pa7c14731) { $pfcfb6727 = $pa7c14731["parent_table"]; $v35f2dcdf16 = array_search($pfcfb6727, $this->pac4bc40a); if ($v35f2dcdf16 !== false && $v43dd7d0051 < $v35f2dcdf16) { if ($v7bb8636f3b[$pc661dc6b]) { $this->v921e35db25[$pc661dc6b][] = $pa7c14731; } else { $this->pac4bc40a = array_merge( array_slice($this->pac4bc40a, 0, $v43dd7d0051), array($this->pac4bc40a[$v35f2dcdf16]), array_slice($this->pac4bc40a, $v43dd7d0051, $v35f2dcdf16 - $v43dd7d0051), array_slice($this->pac4bc40a, $v35f2dcdf16 + 1) ); $this->pac4bc40a = array_values($this->pac4bc40a); $v43dd7d0051--; } } } } $v7bb8636f3b[$pc661dc6b] = true; } $this->pac4bc40a = array_values($this->pac4bc40a); return; } private function f46f919a404() { $v3c76382d93 = $this->v7c2fe1aa6f->getShowViewsStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); if ($v3dd67d635b) { if (empty($this->pc5a23cfc['include-views'])) { foreach ($v3dd67d635b as $pff59654a) { $v5e813b295b = current($pff59654a); if ($v5e813b295b) $this->pad5cfe31[] = $v5e813b295b; } } else { foreach ($v3dd67d635b as $pff59654a) { $v5e813b295b = current($pff59654a); if ($v5e813b295b && in_array($v5e813b295b, $this->pc5a23cfc['include-views'], true)) { $this->pad5cfe31[] = $v5e813b295b; $pd69fb7d0 = array_search($v5e813b295b, $this->pc5a23cfc['include-views']); unset($this->pc5a23cfc['include-views'][$pd69fb7d0]); } } } } return; } private function f3df198bf92() { if ($this->pc5a23cfc['skip-triggers'] === false) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowTriggersStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) if ($pff59654a['Trigger']) $this->v1496ce0491[] = $pff59654a['Trigger']; } return; } private function mfda752e955e3() { if ($this->pc5a23cfc['routines']) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowProceduresStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) if ($pff59654a['procedure_name']) $this->v3d168242ec[] = $pff59654a['procedure_name']; } return; } private function me0271330d45a() { if ($this->pc5a23cfc['routines']) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowFunctionsStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) if ($pff59654a['function_name']) $this->v12efdd30d7[] = $pff59654a['function_name']; } return; } private function f322bbc8224() { if ($this->pc5a23cfc['events']) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowEventsStmt( $this->getConnectionSelectedDBName() ); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) if ($pff59654a['event_name']) $this->pff4a669e[] = $pff59654a['event_name']; } return; } private function ma50d9ff81c52($pc661dc6b, $v9e319978a9) { $v7959970a41 = false; if (is_array($v9e319978a9)) { foreach ($v9e319978a9 as $pc7a51a2b) { if ($pc7a51a2b[0] != '/') continue; if (preg_match($pc7a51a2b, $pc661dc6b) == 1) $v7959970a41 = true; } return in_array($pc661dc6b, $v9e319978a9) || $v7959970a41; } return $v7959970a41; } private function medfd6a1aca88() { $v39e1347c93 = ""; if ($this->pc5a23cfc['add-drop-table']) { $v3c76382d93 = ""; foreach ($this->pac4bc40a as $pc661dc6b) if ($this->v921e35db25[$pc661dc6b]) foreach ($this->v921e35db25[$pc661dc6b] as $pa7c14731) if ($pa7c14731["constraint_name"]) $v3c76382d93 .= $this->v7c2fe1aa6f->getDropTableForeignConstraintStmt($pc661dc6b, $pa7c14731["constraint_name"]); if ($v3c76382d93) $v39e1347c93 .= "--" . PHP_EOL . "-- Disable some tables' foreign keys" . PHP_EOL . $v3c76382d93 . "--" . PHP_EOL . PHP_EOL; } $v39e1347c93 .= "--" . PHP_EOL . "-- Disable all constraints and triggers" . PHP_EOL . $this->v7c2fe1aa6f->startDisableConstraintsAndTriggersStmt($this->pac4bc40a) . "--" . PHP_EOL . PHP_EOL; $this->pb6f5aa83->write($v39e1347c93); foreach ($this->pac4bc40a as $pc661dc6b) { if ($this->ma50d9ff81c52($pc661dc6b, $this->pc5a23cfc['exclude-tables'])) continue; $this->f492110b7ec($pc661dc6b); if ($this->pc5a23cfc['no-data'] === false) $this->md966da23af18($pc661dc6b); else if ($this->pc5a23cfc['no-data'] === true || $this->ma50d9ff81c52($pc661dc6b, $this->pc5a23cfc['no-data'])) continue; else $this->md966da23af18($pc661dc6b); } foreach ($this->v2872dea9ed as $pc661dc6b => $pca4fccf3) if ($pca4fccf3) { if (!$this->pc5a23cfc['skip-comments']) $pca4fccf3 = "--" . PHP_EOL . "-- Foreign keys for table $pc661dc6b" . PHP_EOL . "--" . PHP_EOL . PHP_EOL . $pca4fccf3; $this->pb6f5aa83->write($pca4fccf3); } $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Re-enable all constraints and triggers" . PHP_EOL . $this->v7c2fe1aa6f->endDisableConstraintsAndTriggersStmt($this->pac4bc40a). "--" . PHP_EOL . PHP_EOL ); } private function f4c741a8701() { if ($this->pc5a23cfc['no-create-info'] === false) { foreach ($this->pad5cfe31 as $pa36e00ea) { if ($this->ma50d9ff81c52($pa36e00ea, $this->pc5a23cfc['exclude-tables'])) continue; $this->v83be22c76f[$pa36e00ea] = $this->f8de1bac2dd($pa36e00ea); $this->f6a27ceeb1a($pa36e00ea); } foreach ($this->pad5cfe31 as $pa36e00ea) { if ($this->ma50d9ff81c52($pa36e00ea, $this->pc5a23cfc['exclude-tables'])) continue; $this->f8c84c8dc14($pa36e00ea); } } } private function f93d64366b7() { foreach ($this->v1496ce0491 as $v5ed3bce1d1) $this->f0628ebab3d($v5ed3bce1d1); } private function f88dc0275df() { foreach ($this->v3d168242ec as $pbda8f16d) $this->maaddfbfd760f($pbda8f16d); } private function mdc00b732734a() { foreach ($this->v12efdd30d7 as $v2f4e66e00a) $this->f07e2ba174e($v2f4e66e00a); } private function macae72d831ed() { foreach ($this->pff4a669e as $v76392c9cad) $this->f08ff3194f3($v76392c9cad); } private function f492110b7ec($v8c5df8072b) { if (!$this->pc5a23cfc['no-create-info']) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateTableStmt($v8c5df8072b); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); $pba23d78c = array(); foreach ($v3dd67d635b as $v7a1b9c07b3) $pba23d78c[] = $v7a1b9c07b3; $v3c76382d93 = $this->v7c2fe1aa6f->createTable($pba23d78c, $v8c5df8072b, $this->v921e35db25[$v8c5df8072b]); if ($v3c76382d93) { if (!$this->pc5a23cfc['skip-comments']) $v3c76382d93 = "--" . PHP_EOL . "-- Structure for table $v8c5df8072b" . PHP_EOL . "--" . PHP_EOL . PHP_EOL . $v3c76382d93; if ($this->pc5a23cfc['add-drop-table']) $v3c76382d93 = $this->v7c2fe1aa6f->getDropTableStmt($v8c5df8072b) . $v3c76382d93; $this->pb6f5aa83->write($v3c76382d93); } } $this->v83be22c76f[$v8c5df8072b] = $this->f8de1bac2dd($v8c5df8072b); } private function meef853762565($v8c5df8072b, $pa7c14731) { if (!$this->pc5a23cfc['no-create-info']) { $v3c76382d93 = $this->v7c2fe1aa6f->alter_table_add_foreign_key($v8c5df8072b, $pa7c14731); if ($v3c76382d93) { if (!$this->pc5a23cfc['skip-comments']) $v3c76382d93 = "--" . PHP_EOL . "-- Foreign keys for table $v8c5df8072b -> " . $pa7c14731["parent_table"] . PHP_EOL . "--" . PHP_EOL . PHP_EOL . $v3c76382d93; $this->pb6f5aa83->write($v3c76382d93); } } } private function f8de1bac2dd($v8c5df8072b) { $v9f84e245aa = array(); $v3c76382d93 = $this->v7c2fe1aa6f->getShowTableColumnsStmt($v8c5df8072b); $ped0a6251 = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($ped0a6251 as $pbfa01ed1 => $v1b0cfa478b) { $pd152184b = $this->v7c2fe1aa6f->getTableAttributeProperties($v1b0cfa478b); $v9f84e245aa[ $pd152184b['field'] ] = array( 'is_numeric'=> $pd152184b['is_numeric'], 'is_blob' => $pd152184b['is_blob'], 'is_boolean' => $pd152184b['is_boolean'], 'type' => $pd152184b['type'], 'type_sql' => $pd152184b['type_sql'], 'is_virtual' => $pd152184b['is_virtual'], 'is_nullable' => $pd152184b['is_nullable'], ); } return $v9f84e245aa; } private function f6a27ceeb1a($v03205f9bb8) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Stand-In structure for view ${view_name}" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateViewStmt($v03205f9bb8); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $v7a1b9c07b3) { if ($this->pc5a23cfc['add-drop-table']) $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropTableStmt($v03205f9bb8) ); $pec5415bb = $this->prepareViewStandInTableSQL($v03205f9bb8); if ($pec5415bb) $this->pb6f5aa83->write($pec5415bb); break; } } public function prepareViewStandInTableSQL($v03205f9bb8) { $v50890f6f30 = array(); foreach ($this->v83be22c76f[$v03205f9bb8] as $pe5c5e2fe => $v956913c90f) $v50890f6f30[] = $this->f2e1aca6a7e($pe5c5e2fe, $v03205f9bb8) . " " . $v956913c90f["type_sql"]; $v50890f6f30 = implode(PHP_EOL . ",", $v50890f6f30); if (trim($v50890f6f30)) return $this->v7c2fe1aa6f->createStandInTableForView($v03205f9bb8, $v50890f6f30); return ""; } private function f8c84c8dc14($v03205f9bb8) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Structure for View ${view_name}" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateViewStmt($v03205f9bb8); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $v7a1b9c07b3) { $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropViewStmt($v03205f9bb8) ); $this->pb6f5aa83->write( $this->v7c2fe1aa6f->createView($v7a1b9c07b3) ); break; } } private function f0628ebab3d($v1b133889d9) { $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateTriggerStmt($v1b133889d9); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) { if ($this->pc5a23cfc['add-drop-trigger']) $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropTriggerStmt($v1b133889d9) ); $this->pb6f5aa83->write( $this->v7c2fe1aa6f->createTrigger($pff59654a) ); return; } } private function maaddfbfd760f($v77a7cdf5d8) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Procedures for '" . $this->getConnectionSelectedDBName()."' DB" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateProcedureStmt($v77a7cdf5d8); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) { if ($this->pc5a23cfc['add-drop-routine']) $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropProcedureStmt($v77a7cdf5d8) ); $this->pb6f5aa83->write( $this->v7c2fe1aa6f->createProcedure($pff59654a) ); return; } } private function f07e2ba174e($v9d33ecaf56) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- functions for '" . $this->getConnectionSelectedDBName()."' DB" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateFunctionStmt($v9d33ecaf56); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) { if ($this->pc5a23cfc['add-drop-routine']) $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropFunctionStmt($v9d33ecaf56) ); $this->pb6f5aa83->write( $this->v7c2fe1aa6f->createFunction($pff59654a) ); return; } } private function f08ff3194f3($v93ba3bd3f2) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Events for '" . $this->getConnectionSelectedDBName()."' DB" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); $v3c76382d93 = $this->v7c2fe1aa6f->getShowCreateEventStmt($v93ba3bd3f2); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); foreach ($v3dd67d635b as $pff59654a) { if ($this->pc5a23cfc['add-drop-event']) $this->pb6f5aa83->write( $this->v7c2fe1aa6f->getDropEventStmt($v9d33ecaf56) ); $this->pb6f5aa83->write( $this->v7c2fe1aa6f->createEvent($pff59654a) ); return; } } public function prepareTableRowAttributes($v8c5df8072b, array $pff59654a) { $v50890f6f30 = array(); $pd152184b = $this->v83be22c76f[$v8c5df8072b]; if ($this->pf676831f) $pff59654a = call_user_func($this->pf676831f, $v8c5df8072b, $pff59654a); foreach ($pff59654a as $v5e45ec9bb9 => $pd6321fb0) { if ($this->peb764c64) $pd6321fb0 = call_user_func($this->peb764c64, $v8c5df8072b, $v5e45ec9bb9, $pd6321fb0, $pff59654a); $v50890f6f30[] = $this->f20166dda4b($pd6321fb0, $pd152184b[$v5e45ec9bb9]); } return $v50890f6f30; } private function f20166dda4b($pd6321fb0, $v670a5790dd) { if (is_null($pd6321fb0)) return "NULL"; else if ($v670a5790dd['is_numeric']) return is_numeric($pd6321fb0) ? $pd6321fb0 : ($v670a5790dd["is_nullable"] ? "NULL" : $this->quote($pd6321fb0)); else if ($v670a5790dd['is_boolean']) return $pd6321fb0 ? "true" : "false"; else if ($this->pc5a23cfc['hex-blob'] && $v670a5790dd['is_blob'] && $this->v7c2fe1aa6f->getTableAttributesPropertiesBlobHexFunc("")) { if ($v670a5790dd['type'] == 'bit' || !empty($pd6321fb0)) return "0x${col_value}"; else return "''"; } else return $this->quote($pd6321fb0); } public function quote($v327f72fb62) { if ($this->link) switch ($this->extension) { case "pdo": $v50890f6f30 = $this->link->quote($v327f72fb62); if ($v50890f6f30 !== false) return $v50890f6f30; } return !is_null($v327f72fb62) ? "'" . addcslashes($v327f72fb62, "'\\") . "'" : "NULL"; } public function setCallableWhenParsingTableRow($v33c0108059) { $this->pf676831f = $v33c0108059; } public function setCallableWhenParsingTableRowAttribute($v33c0108059) { $this->peb764c64 = $v33c0108059; } public function setCallableToParseTableRecordsInfo($v33c0108059) { $this->pb10cc6a4 = $v33c0108059; } private function md966da23af18($v8c5df8072b) { $v5eaddbc862 = $this->getTableAttributesProperties($v8c5df8072b); $v5eaddbc862 = implode(",", $v5eaddbc862); $v3c76382d93 = "SELECT " . $v5eaddbc862 . " FROM " . $this->f67c002d588($v8c5df8072b); $v32dd06ab9b = $this->getTableSQLCondition($v8c5df8072b); if ($v32dd06ab9b) $v3c76382d93 .= " WHERE {$v32dd06ab9b}"; $v552b831ecd = $this->getTableLimit($v8c5df8072b); if ($v552b831ecd !== false) $v3c76382d93 = $this->v7c2fe1aa6f->getSqlStmtWithLimit($v3c76382d93, $v552b831ecd); $v3dd67d635b = $this->v87e4fe1181->getSQL($v3c76382d93); if ($v3dd67d635b) { $this->prepareTableRecordsStartSQL($v8c5df8072b); $v15f3268002 = $this->v7c2fe1aa6f->createRecordsInsertStmt($v8c5df8072b, $v3dd67d635b); $this->prepareTableRecordsEndSQL($v8c5df8072b, $v15f3268002); if ($this->pb10cc6a4) call_user_func($this->pb10cc6a4, 'table', array('name' => $v8c5df8072b, 'rowCount' => $v15f3268002)); } } public function prepareTableRecordsStartSQL($v8c5df8072b) { if (!$this->pc5a23cfc['skip-comments']) $this->pb6f5aa83->write( "--" . PHP_EOL . "-- Dumping data for table $v8c5df8072b" . PHP_EOL . "--" . PHP_EOL . PHP_EOL ); if ($this->pc5a23cfc['single-transaction']) { $this->v87e4fe1181->setSQL( $this->v7c2fe1aa6f->getSetupTransactionStmt() ); $this->v87e4fe1181->setSQL( $this->v7c2fe1aa6f->getStartTransactionStmt() ); } if ($this->pc5a23cfc['lock-tables'] && !$this->pc5a23cfc['single-transaction']) $this->v7c2fe1aa6f->lockTable($v8c5df8072b); $v39e1347c93 = ""; if ($this->pc5a23cfc['add-locks']) $v39e1347c93 .= $this->v7c2fe1aa6f->getStartLockTableWriteStmt($v8c5df8072b); if ($this->pc5a23cfc['disable-keys']) $v39e1347c93 .= $this->v7c2fe1aa6f->getStartDisableKeysStmt($v8c5df8072b); if ($this->pc5a23cfc['no-autocommit']) $v39e1347c93 .= $this->v7c2fe1aa6f->getStartDisableAutocommitStmt(); if ($v39e1347c93) $this->pb6f5aa83->write($v39e1347c93); return; } public function prepareTableRecordsEndSQL($v8c5df8072b, $v15f3268002 = 0) { $v39e1347c93 = ""; if ($this->pc5a23cfc['disable-keys']) $v39e1347c93 .= $this->v7c2fe1aa6f->getEndDisableKeysStmt($v8c5df8072b); if ($this->pc5a23cfc['add-locks']) $v39e1347c93 .= $this->v7c2fe1aa6f->getEndLockTableStmt($v8c5df8072b); if ($v39e1347c93) $this->pb6f5aa83->write($v39e1347c93); if ($this->pc5a23cfc['single-transaction']) $this->v87e4fe1181->setSQL( $this->v7c2fe1aa6f->getCommitTransactionStmt() ); if ($this->pc5a23cfc['lock-tables'] && !$this->pc5a23cfc['single-transaction']) $this->v7c2fe1aa6f->unlockTable($v8c5df8072b); $v39e1347c93 = ""; if ($this->pc5a23cfc['no-autocommit']) $v39e1347c93 .= $this->v7c2fe1aa6f->getEndDisableAutocommitStmt(); $v39e1347c93 .= PHP_EOL; if (!$this->pc5a23cfc['skip-comments']) $v39e1347c93 .= "-- Dumped table " . $v8c5df8072b." with $v15f3268002 row(s)" . PHP_EOL . "--" . PHP_EOL . PHP_EOL; if ($v39e1347c93) $this->pb6f5aa83->write($v39e1347c93); return; } public function getTableAttributesProperties($v8c5df8072b) { $ped0a6251 = array(); foreach ($this->v83be22c76f[$v8c5df8072b] as $v5e45ec9bb9 => $v670a5790dd) { $pe04f136f = $this->f2e1aca6a7e($v5e45ec9bb9, $v8c5df8072b); if ($v670a5790dd['type'] == 'bit' && $this->pc5a23cfc['hex-blob']) $ped0a6251[] = $this->v7c2fe1aa6f->getTableAttributesPropertiesBitHexFunc($pe04f136f) . " AS " . $this->f01903684ef($v5e45ec9bb9); else if ($v670a5790dd['is_blob'] && $this->pc5a23cfc['hex-blob']) $ped0a6251[] = $this->v7c2fe1aa6f->getTableAttributesPropertiesBlobHexFunc($pe04f136f) . " AS " . $this->f01903684ef($v5e45ec9bb9); else if ($v670a5790dd['is_virtual']) { $this->pc5a23cfc['complete-insert'] = true; continue; } else $ped0a6251[] = $pe04f136f; } return $ped0a6251; } public function getTableAttributesNames($v8c5df8072b, $pa3b8035e = false) { $v57c3cf2d15 = array(); foreach ($this->v83be22c76f[$v8c5df8072b] as $v5e45ec9bb9 => $v670a5790dd) { if ($v670a5790dd['is_virtual']) { $this->pc5a23cfc['complete-insert'] = true; continue; } else $v57c3cf2d15[] = $this->f2e1aca6a7e($v5e45ec9bb9, $pa3b8035e ? $v8c5df8072b : false); } return $v57c3cf2d15; } private function f01903684ef($v5e813b295b) { return $this->v7c2fe1aa6f->escapeTableAttributeAlias($v5e813b295b); } private function f67c002d588($v5e813b295b) { return $this->v7c2fe1aa6f->escapeTable($v5e813b295b); } private function f2e1aca6a7e($v5e45ec9bb9, $v8c5df8072b = false) { return $this->v7c2fe1aa6f->escapeTableAttribute($v5e45ec9bb9, $v8c5df8072b); } } ?>
