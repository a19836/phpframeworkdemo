<?php
/*
 * Copyright (c) 2024 Bloxtor - http://bloxtor.com
 * 
 * Please note that this code belongs to the Bloxtor framework and must comply with the Bloxtor license.
 * If you do not accept these provisions, or if the Bloxtor License is not present or cannot be found, you are not entitled to use this code and must stop and delete it immediately.
 */
include_once get_lib("org.phpframework.db.dump.DBDumper"); class MSSqlDBDumper extends DBDumper { public function __construct($v834e515e94) { $this->DBDumperHandler = $v834e515e94; } public function databases($pb67a2609) { $v3c76382d93 = "SELECT SERVERPROPERTY('collation') as 'collation';"; $v3dd67d635b = $this->DBDumperHandler->getDBDriver()->getSQL($v3c76382d93); $pf6d213c3 = isset($v3dd67d635b[0]["collation"]) ? $v3dd67d635b[0]["collation"] : null; $v50890f6f30 = ""; $v50890f6f30 .= "/* IF DB_ID ('{$pb67a2609}') IS NULL */". " CREATE DATABASE {$pb67a2609}". " /* COLLATE {$pf6d213c3} */;".PHP_EOL.PHP_EOL. "USE {$pb67a2609};".PHP_EOL.PHP_EOL; return $v50890f6f30; } public function createTable($pba23d78c, $v8c5df8072b, $v11f9d89738 = false) { $pff59654a = isset($pba23d78c[0]) ? $pba23d78c[0] : null; if (!$pff59654a || !isset($pff59654a['Create Table'])) { return "/* Error getting table code, unknown output. */".PHP_EOL .PHP_EOL; } $v813853251a = $pff59654a['Create Table'] . ";"; $v3c76382d93 = ""; $pb4eb2d6f = array(); $v9d1bf2c12a = array(); if ($v11f9d89738) foreach ($v11f9d89738 as $pa7c14731) { if (isset($pa7c14731["child_column"]) && isset($pa7c14731["parent_table"]) && isset($pa7c14731["parent_column"])) $v9d1bf2c12a[ $pa7c14731["child_column"] ][ $pa7c14731["parent_table"] ][ $pa7c14731["parent_column"] ] = $pa7c14731; if (isset($pa7c14731["constraint_name"])) $v9d1bf2c12a[ $pa7c14731["constraint_name"] ] = $pa7c14731; } $v5faa4b8a01 = $this->getShowForeignKeysStmt($v8c5df8072b); $v3dd67d635b = $this->DBDumperHandler->getDBDriver()->getSQL($v5faa4b8a01); foreach ($v3dd67d635b as $v7a1b9c07b3) { $pe04f136f = isset($v7a1b9c07b3["constraint_name"]) ? $v7a1b9c07b3["constraint_name"] : null; $v114ab04c01 = isset($v7a1b9c07b3["child_column"]) ? $v7a1b9c07b3["child_column"] : null; $v0e97b0c60d = isset($v7a1b9c07b3["parent_table"]) ? $v7a1b9c07b3["parent_table"] : null; $v3beaa307d1 = isset($v7a1b9c07b3["parent_column"]) ? $v7a1b9c07b3["parent_column"] : null; $v6912eee73f = !empty($v7a1b9c07b3["on_delete"]) ? " ON DELETE " . $v7a1b9c07b3["on_delete"] : ""; $pd7c78775 = !empty($v7a1b9c07b3["on_update"]) ? " ON UPDATE " . $v7a1b9c07b3["on_update"] : ""; $v13aa5fbc76 = !empty($v7a1b9c07b3["replication_code"]) ? $v7a1b9c07b3["replication_code"] : ""; $v2343c84346 = ($pe04f136f ? "CONSTRAINT [" . $pe04f136f . "] " : "") . " FOREIGN KEY ([" . $v114ab04c01 . "]) REFERENCES [" . $v0e97b0c60d . "] ([" . $v3beaa307d1 . "]) $v6912eee73f $pd7c78775 $v13aa5fbc76 $pf64b5abc"; if ( ($pe04f136f && $v9d1bf2c12a[$pe04f136f]) || ( $v9d1bf2c12a[$v114ab04c01] && $v9d1bf2c12a[$v114ab04c01][$v0e97b0c60d] && $v9d1bf2c12a[$v114ab04c01][$v0e97b0c60d][$v3beaa307d1] )) { $pa7c14731 = $v9d1bf2c12a[$pe04f136f] ? $v9d1bf2c12a[$pe04f136f] : $v9d1bf2c12a[$v114ab04c01][$v0e97b0c60d][$v3beaa307d1]; $this->DBDumperHandler->setTableExtraSql($pa7c14731["parent_table"], "ALTER TABLE [$v8c5df8072b] ADD $v2343c84346;" . PHP_EOL); } else $v3c76382d93 .= "," . PHP_EOL . "    " . $v2343c84346; $pb4eb2d6f[] = $pe04f136f; } $v5faa4b8a01 = str_replace("\t", "", "SELECT c.name as 'constraint_name', col.name as 'col_name', t.name as 'table_name'
				FROM sys.objects t
				INNER JOIN sys.indexes i ON t.object_id = i.object_id
				INNER JOIN sys.key_constraints c ON i.object_id = c.parent_object_id AND i.index_id = c.unique_index_id
				INNER JOIN sys.index_columns ic ON ic.object_id = t.object_id AND ic.index_id = i.index_id
				INNER JOIN sys.columns col ON ic.object_id = col.object_id AND ic.column_id = col.column_id
				WHERE i.is_unique = 1 AND t.type = 'U' AND c.type = 'UQ' AND t.name='$v8c5df8072b' AND t.is_ms_shipped=0;"); $v3dd67d635b = $this->DBDumperHandler->getDBDriver()->getSQL($v5faa4b8a01); foreach ($v3dd67d635b as $v7a1b9c07b3) { $pe04f136f = isset($v7a1b9c07b3["constraint_name"]) ? $v7a1b9c07b3["constraint_name"] : null; $v3c76382d93 .= "," . PHP_EOL . "    " . ($pe04f136f ? "CONSTRAINT [" . $pe04f136f . "] " : "") . " UNIQUE ([" . $v7a1b9c07b3["col_name"] . "])"; $pb4eb2d6f[] = $pe04f136f; } $v5faa4b8a01 = str_replace("\t", "", "SELECT 
    	   				i.name as 'index_name', 
    	   				i.type_desc 'index_type', 
    	   				col.name as 'col_name', 
    	   				t.name as 'table_name'
				FROM sys.objects t
				INNER JOIN sys.indexes i ON t.object_id = i.object_id
				INNER JOIN sys.index_columns ic ON ic.object_id = t.object_id AND ic.index_id = i.index_id
				INNER JOIN sys.columns col ON ic.object_id = col.object_id AND ic.column_id = col.column_id
				WHERE t.name='$v8c5df8072b' AND t.is_ms_shipped=0 and i.is_primary_key=0 AND i.is_unique_constraint=0 AND i.is_unique=0"); $v3dd67d635b = $this->DBDumperHandler->getDBDriver()->getSQL($v5faa4b8a01); foreach ($v3dd67d635b as $v7a1b9c07b3) { $v5eeb1c51a4 = isset($v7a1b9c07b3["index_name"]) ? $v7a1b9c07b3["index_name"] : null; if (!in_array($v5eeb1c51a4, $pb4eb2d6f)) { $v35a774938a = isset($v7a1b9c07b3["index_type"]) ? $v7a1b9c07b3["index_type"] : null; $pe04f136f = isset($v7a1b9c07b3["col_name"]) ? $v7a1b9c07b3["col_name"] : null; $v3c76382d93 .= "," . PHP_EOL . "    INDEX " . ($v5eeb1c51a4 ? "[" . $v5eeb1c51a4 . "] " : "") . $v35a774938a . " ([" . $pe04f136f . "])"; $pb4eb2d6f[] = $v5eeb1c51a4; } } if ($v3c76382d93) { $pbd1bc7b0 = strrpos($v813853251a, ")"); $v813853251a = trim(substr($v813853251a, 0, $pbd1bc7b0)) . $v3c76382d93 . PHP_EOL . substr($v813853251a, $pbd1bc7b0); } $v50890f6f30 = $v813853251a.PHP_EOL. PHP_EOL; return $v50890f6f30; } public function createRecordsInsertStmt($v8c5df8072b, $v3dd67d635b) { $pc5a23cfc = $this->DBDumperHandler->getDBDumperSettings(); $v8c9fa8af2d = $this->DBDumperHandler->getFileCompressionHandler(); $v8c9fa8af2d->write("SET IDENTITY_INSERT [" . $v8c5df8072b . "] ON;".PHP_EOL); if (!empty($pc5a23cfc['complete-insert'])) $v57c3cf2d15 = $this->DBDumperHandler->getTableAttributesNames($v8c5df8072b); $v2cc816973e = 0; $pc50aa7ff = true; $v15f3268002 = 0; $pa76f5849 = isset($pc5a23cfc['net_buffer_length']) ? $pc5a23cfc['net_buffer_length'] : null; foreach ($v3dd67d635b as $pff59654a) { $v15f3268002++; $v073724e2a6 = $this->DBDumperHandler->prepareTableRowAttributes($v8c5df8072b, $pff59654a); if ($pc50aa7ff || empty($pc5a23cfc['extended-insert'])) { if (!empty($pc5a23cfc['complete-insert'])) $v327f72fb62 = "INSERT INTO " . $this->escapeTable($v8c5df8072b) . " (" . implode(", ", $v57c3cf2d15) . ") VALUES (".implode(",", $v073724e2a6).")"; else $v327f72fb62 = "INSERT INTO " . $this->escapeTable($v8c5df8072b) . " VALUES (".implode(",", $v073724e2a6).")"; $pc50aa7ff = false; } else $v327f72fb62 = ",(".implode(",", $v073724e2a6).")"; $v2cc816973e += $v8c9fa8af2d->write($v327f72fb62); if (empty($pc5a23cfc['extended-insert']) || $v2cc816973e > $pa76f5849) { $pc50aa7ff = true; $v2cc816973e = $v8c9fa8af2d->write(";".PHP_EOL); } } if (!$pc50aa7ff) $v8c9fa8af2d->write(";".PHP_EOL); $v8c9fa8af2d->write("SET IDENTITY_INSERT [" . $v8c5df8072b . "] OFF;".PHP_EOL); return $v15f3268002; } public function getSqlStmtWithLimit($v3c76382d93, $v552b831ecd) { if (stripos($v3c76382d93, " order by ") === false) $v3c76382d93 .= " ORDER BY (SELECT NULL)"; return $v3c76382d93 . " OFFSET 0 ROWS FETCH NEXT $v552b831ecd ROWS ONLY;"; } public function createStandInTableForView($v03205f9bb8, $v6bc5012fff) { return "CREATE TABLE " . $this->escapeTable($v03205f9bb8) . " (". PHP_EOL.$pa2b29664.PHP_EOL.");".PHP_EOL; } public function getTableAttributeProperties($v670a5790dd) { $v26ddf2909a = $this->DBDumperHandler->getDBDriver()->getDBColumnNumericTypes(); $v7ee1284650 = $this->DBDumperHandler->getDBDriver()->getDBColumnBlobTypes(); $v415a32ad4d = $this->DBDumperHandler->getDBDriver()->getDBColumnBooleanTypes(); $pd152184b = array(); $pd152184b['field'] = isset($v670a5790dd['column_name']) ? $v670a5790dd['column_name'] : null; $pd152184b['type'] = isset($v670a5790dd['data_type']) ? $v670a5790dd['data_type'] : null; $pd152184b['type_sql'] = isset($v670a5790dd['data_type']) ? $v670a5790dd['data_type'] : null; $v0911c6122e = !empty($v670a5790dd["character_maximum_length"]) ? $v670a5790dd["character_maximum_length"] : (isset($v670a5790dd["numeric_precision"]) ? $v670a5790dd["numeric_precision"] : null); if (is_numeric($v0911c6122e) && isset($v670a5790dd["numeric_scale"]) && is_numeric($v670a5790dd["numeric_scale"])) $v0911c6122e += $v670a5790dd["numeric_scale"]; $pd152184b['is_nullable'] = !isset($v670a5790dd['is_nullable']) || strtolower($v670a5790dd['is_nullable']) != "no" ? false : true; $pd152184b['is_nullable'] = isset($v670a5790dd['is_nullable']) ? $v670a5790dd['is_nullable'] : null; $pd152184b['is_numeric'] = is_array($v26ddf2909a) && in_array($pd152184b['type'], $v26ddf2909a); $pd152184b['is_blob'] = is_array($v7ee1284650) && in_array($pd152184b['type'], $v7ee1284650); $pd152184b['is_boolean'] = is_array($v415a32ad4d) && in_array($pd152184b['type'], $v415a32ad4d); return $pd152184b; } public function getTableAttributesPropertiesBitHexFunc($v5e45ec9bb9) { return $v5e45ec9bb9; } public function getTableAttributesPropertiesBlobHexFunc($v5e45ec9bb9) { return $v5e45ec9bb9; } public function createView($pff59654a) { $v50890f6f30 = ""; if (!isset($pff59654a['Create View'])) { return "/* Error getting view structure, unknown output */".PHP_EOL. PHP_EOL; } $v50890f6f30 .= "/* DROP VIEW IF EXISTS ".(isset($pff59654a['View']) ? $pff59654a['View'] : null)." */;".PHP_EOL. "GO".PHP_EOL. $pff59654a['Create View'].(substr($pff59654a['Create View'], -1) == ";" ? "" : ";").PHP_EOL. "GO".PHP_EOL. PHP_EOL; return $v50890f6f30; } public function createTrigger($pff59654a) { $v50890f6f30 = ""; if (!isset($pff59654a['SQL Original Statement'])) { return "/* Error getting trigger code, unknown output */".PHP_EOL. PHP_EOL; } $v50890f6f30 .= "/* DROP TRIGGER IF EXISTS ".(isset($pff59654a['Trigger']) ? $pff59654a['Trigger'] : null)." */;".PHP_EOL. "GO".PHP_EOL. $pff59654a['SQL Original Statement'].(substr($pff59654a['SQL Original Statement'], -1) == ";" ? "" : ";").PHP_EOL. "GO".PHP_EOL. PHP_EOL; return $v50890f6f30; } public function createProcedure($pff59654a) { $v50890f6f30 = ""; if (!isset($pff59654a['Create Procedure'])) { return "/* Error getting procedure code, unknown output. */".PHP_EOL. PHP_EOL; } $v50890f6f30 .= "/* DROP PROCEDURE IF EXISTS ".(isset($pff59654a['Procedure']) ? $pff59654a['Procedure'] : null)." */;".PHP_EOL. "GO".PHP_EOL. $pff59654a['Create Procedure'].(substr($pff59654a['Create Procedure'], -1) == ";" ? "" : ";").PHP_EOL. "GO".PHP_EOL. PHP_EOL; return $v50890f6f30; } public function createFunction($pff59654a) { $v50890f6f30 = ""; if (!isset($pff59654a['Create Function'])) { return "/* Error getting function code, unknown output. */".PHP_EOL. PHP_EOL; } $v50890f6f30 .= "/* DROP FUNCTION IF EXISTS ".(isset($pff59654a['Function']) ? $pff59654a['Function'] : null)." */;".PHP_EOL. "GO".PHP_EOL. $pff59654a['Create Function'].(substr($pff59654a['Create Function'], -1) == ";" ? "" : ";").PHP_EOL. "GO".PHP_EOL. PHP_EOL; return $v50890f6f30; } public function createEvent($pff59654a) { $v50890f6f30 = ""; if (!isset($pff59654a['Create Event'])) { return "/* Error getting event code, unknown output. */".PHP_EOL. PHP_EOL; } $v50890f6f30 .= "/* DROP EVENT IF EXISTS ".(isset($pff59654a['Event']) ? $pff59654a['Event'] : null)." */;".PHP_EOL. "GO".PHP_EOL. $pff59654a['Create Event'].(substr($pff59654a['Create Event'], -1) == ";" ? "" : ";").PHP_EOL. "GO".PHP_EOL. PHP_EOL; return $v50890f6f30; } public function backupParameters() { return PHP_EOL; } public function restoreParameters() { return PHP_EOL; } public function startDisableConstraintsAndTriggersStmt($pac4bc40a) { $v3c76382d93 = "exec sp_msforeachtable \"ALTER TABLE ? NOCHECK CONSTRAINT all\";
exec sp_msforeachtable \"ALTER TABLE ? DISABLE TRIGGER  all\";".PHP_EOL; $pc5a23cfc = $this->DBDumperHandler->getDBDumperSettings(); if ($pac4bc40a && !empty($pc5a23cfc['add-drop-table'])) { $pac4bc40a = is_array($pac4bc40a) ? $pac4bc40a : array($pac4bc40a); $pa51282b5 = null; $v3c76382d93 .= "
DECLARE @drop_sql NVARCHAR(MAX) = '';

WHILE 1=1
BEGIN
  SELECT 
     @drop_sql = 'ALTER TABLE ' + isc.TABLE_NAME + ' DROP CONSTRAINT IF EXISTS ' + f.name + ';'
  FROM sys.foreign_keys AS f  
  INNER JOIN sys.foreign_key_columns AS fc ON f.object_id = fc.constraint_object_id
  INNER JOIN information_schema.COLUMNS AS isc ON isc.TABLE_CATALOG=DB_NAME() AND isc.TABLE_SCHEMA=SCHEMA_NAME(f.schema_id) AND OBJECT_ID(isc.TABLE_NAME)=f.parent_object_id AND isc.COLUMN_NAME=COL_NAME(fc.parent_object_id, fc.parent_column_id)
  WHERE " . ($pa51282b5 ? "isc.TABLE_SCHEMA='$pa51282b5' AND " : "") . "isc.TABLE_NAME in ('" . implode("', '", $pac4bc40a) . "')
  
  IF @@ROWCOUNT = 0 BREAK

  EXEC (@drop_sql);
END".PHP_EOL; } return $v3c76382d93; } public function endDisableConstraintsAndTriggersStmt($pac4bc40a) { return "exec sp_msforeachtable @command1=\"print '?'\", @command2=\"ALTER TABLE ? WITH CHECK CHECK CONSTRAINT all\";
exec sp_msforeachtable @command1=\"print '?'\", @command2=\"ALTER TABLE ? ENABLE TRIGGER  all\";" . PHP_EOL; } } ?>
