<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
include_once get_lib("org.phpframework.dbdiagram.ITableDiagram"); include_once get_lib("org.phpframework.dbdiagram.exception.TableDiagramException"); class TableDiagram implements ITableDiagram { public $data; public function printSQL() { $v3c76382d93 = ""; $v539082ff30 = $this->data; $v8c5df8072b = isset($v539082ff30["name"]) ? $v539082ff30["name"] : null; if (!empty($v539082ff30["drop_before_create"])) $v3c76382d93 .= "DROP TABLE IF EXISTS " . $v8c5df8072b . ";\n"; $v3c76382d93 .= "CREATE TABLE " . $v8c5df8072b . " ( \n"; if (!empty($v539082ff30["attributes"])) foreach ($v539082ff30["attributes"] as $v97915b9670) if (!empty($v97915b9670["name"]) && !empty($v97915b9670["type"])) { $v0911c6122e = !empty($v97915b9670["length"]) ? "(" . $v97915b9670["length"] . ")" : ""; $v4d96472c2f = !empty($v97915b9670["unsigned"]) ? "UNSIGNED" : ""; $pf6e8b316 = !empty($v97915b9670["not_null"]) ? "NOT NULL" : ""; $v6c33401cc3 = !empty($v97915b9670["auto_increment"]) ? "AUTO_INCREMENT" : ""; $v4bfe0500a2 = !empty($v97915b9670["default"]) ? "DEFAULT " . $v97915b9670["default"] : ""; $pd7c78775 = !empty($v97915b9670["on_update"]) ? "ON UPDATE " . $v97915b9670["on_update"] : ""; $v020036c951 = !empty($v97915b9670["comment"]) ? "COMMENT '" . $v97915b9670["comment"] . "'" : ""; $v5eaddbc862 = $v97915b9670["name"] . " " . $v97915b9670["type"] . "$v0911c6122e $v4d96472c2f $pf6e8b316 $v6c33401cc3 $v4bfe0500a2 $pd7c78775 $v020036c951"; $v3c76382d93 .= "   " . trim($v5eaddbc862) . ",\n"; } $v3c76382d93 .= !empty($v539082ff30["keys"]["primary_keys"][0]["attribute"]) ? "   PRIMARY KEY (" . $v539082ff30["keys"]["primary_keys"][0]["attribute"] . "),\n" : ""; if (!empty($v539082ff30["keys"]["unique_keys"]) && is_array($v539082ff30["keys"]["unique_keys"])) foreach ($v539082ff30["keys"]["unique_keys"] as $pbfa01ed1) { $v3fb9f41470 = isset($pbfa01ed1["type"]) && $pbfa01ed1["type"] ? "USING " . $pbfa01ed1["type"] : ""; $v3c76382d93 .= "   UNIQUE " . $pbfa01ed1["name"] . " $v3fb9f41470 (" . $pbfa01ed1["attribute"] . "),\n"; } if (!empty($v539082ff30["keys"]["foreign_keys"]) && is_array($v539082ff30["keys"]["foreign_keys"])) foreach ($v539082ff30["keys"]["foreign_keys"] as $pbfa01ed1) { $v6912eee73f = isset($pbfa01ed1["on_delete"]) && $pbfa01ed1["on_delete"] ? "ON DELETE " . $pbfa01ed1["on_delete"] : ""; $pd7c78775 = isset($pbfa01ed1["on_update"]) && $pbfa01ed1["on_update"] ? "ON UPDATE " . $pbfa01ed1["on_update"] : ""; $v3c76382d93 .= "   FOREIGN KEY (" . $pbfa01ed1["attribute"] . ") REFERENCES " . $pbfa01ed1["reference_table"] . " (" . $pbfa01ed1["reference_attribute"] . ") $v6912eee73f $pd7c78775,\n"; } if (!empty($v539082ff30["keys"]["index_keys"]) && is_array($v539082ff30["keys"]["index_keys"])) foreach ($v539082ff30["keys"]["index_keys"] as $pbfa01ed1) { $v3fb9f41470 = isset($pbfa01ed1["type"]) && $pbfa01ed1["type"] ? "USING " . $pbfa01ed1["type"] : ""; $v3c76382d93 .= "   INDEX " . $pbfa01ed1["name"] . " $v3fb9f41470 (" . $pbfa01ed1["attribute"] . "),\n"; } $pf554201e = !empty($v539082ff30["engine"]) ? "ENGINE=" . $v539082ff30["engine"] : ""; $v4bfe0500a2 = !empty($v539082ff30["charset"]) || !empty($v539082ff30["collate"]) ? ("DEFAULT " . (!empty($v539082ff30["charset"]) ? "CHARSET=" . $v539082ff30["charset"] : "") . " " . (!empty($v539082ff30["collate"]) ? "COLLATE=" . $v539082ff30["collate"] : "")) : ""; $v3c76382d93 = trim($v3c76382d93); $v3c76382d93 = substr($v3c76382d93, strlen($v3c76382d93) - 1) == "," ? substr($v3c76382d93, 0, strlen($v3c76382d93) - 1) . "\n" : $v3c76382d93; $v3c76382d93 .= ") $pf554201e $v4bfe0500a2;\n\n"; return $v3c76382d93; } public function parse($v87a92bb1ad) { $v539082ff30 = array(); if (isset($v87a92bb1ad["childs"]) && is_array($v87a92bb1ad["childs"])) { $v539082ff30["name"] = isset($v87a92bb1ad["childs"]["name"][0]["value"]) ? $v87a92bb1ad["childs"]["name"][0]["value"] : null; $v539082ff30["drop_before_create"] = isset($v87a92bb1ad["childs"]["drop_before_create"][0]["value"]) ? $v87a92bb1ad["childs"]["drop_before_create"][0]["value"] : null; $v539082ff30["drop_before_create"] = !empty($v539082ff30["drop_before_create"]) && ($v539082ff30["drop_before_create"] == "1" || $v539082ff30["drop_before_create"] == "true"); $v539082ff30["engine"] = isset($v87a92bb1ad["childs"]["engine"][0]["value"]) ? $v87a92bb1ad["childs"]["engine"][0]["value"] : null; $v539082ff30["charset"] = isset($v87a92bb1ad["childs"]["charset"][0]["value"]) ? $v87a92bb1ad["childs"]["charset"][0]["value"] : null; $v539082ff30["collate"] = isset($v87a92bb1ad["childs"]["collate"][0]["value"]) ? $v87a92bb1ad["childs"]["collate"][0]["value"] : null; $v539082ff30["attributes"] = array(); if (!empty($v87a92bb1ad["childs"]["attributes"][0]["childs"]["attribute"]) && is_array($v87a92bb1ad["childs"]["attributes"][0]["childs"]["attribute"])) foreach ($v87a92bb1ad["childs"]["attributes"][0]["childs"]["attribute"] as $v97915b9670) if (!empty($v97915b9670["@"])) { $pb4a546a4 = $v97915b9670["@"]; if (isset($pb4a546a4["unsigned"])) $pb4a546a4["unsigned"] = $pb4a546a4["unsigned"] == "1" || $pb4a546a4["unsigned"] == "true"; if (isset($pb4a546a4["not_null"])) $pb4a546a4["not_null"] = $pb4a546a4["not_null"] == "1" || $pb4a546a4["not_null"] == "true"; if (isset($pb4a546a4["auto_increment"])) $pb4a546a4["auto_increment"] = $pb4a546a4["auto_increment"] == "1" || $pb4a546a4["auto_increment"] == "true"; $v539082ff30["attributes"][] = $pb4a546a4; } $v539082ff30["keys"] = array(); if (!empty($v87a92bb1ad["childs"]["keys"][0]["childs"]) && is_array($v87a92bb1ad["childs"]["keys"][0]["childs"])) foreach ($v87a92bb1ad["childs"]["keys"][0]["childs"] as $v1491940c54 => $v9994512d98) { $v570136630e = !empty($v9994512d98[0]["childs"]) && is_array($v9994512d98[0]["childs"]) ? array_keys($v9994512d98[0]["childs"]) : array(); $v0065a286ab = isset($v570136630e[0]) ? $v570136630e[0] : null; if ($v0065a286ab && !empty($v9994512d98[0]["childs"][$v0065a286ab]) && is_array($v9994512d98[0]["childs"][$v0065a286ab])) foreach ($v9994512d98[0]["childs"][$v0065a286ab] as $pbfa01ed1) if (!empty($pbfa01ed1["@"])) $v539082ff30["keys"][$v1491940c54][] = $pbfa01ed1["@"]; } } $this->data = $v539082ff30; } public function isValid() { $v539082ff30 = $this->data; if (empty($v539082ff30["name"])) { launch_exception(new TableDiagramException(1, null)); return false; } if (!empty($v539082ff30["attributes"])) foreach ($v539082ff30["attributes"] as $v97915b9670) { if (empty($v97915b9670["name"])) { launch_exception(new TableDiagramException(2, array($v539082ff30["name"], $v97915b9670))); return false; } if (empty($v97915b9670["type"])) { launch_exception(new TableDiagramException(3, array($v539082ff30["name"], $v97915b9670))); return false; } } if (!empty($v539082ff30["keys"]["unique_keys"]) && is_array($v539082ff30["keys"]["unique_keys"])) foreach ($v539082ff30["keys"]["unique_keys"] as $pbfa01ed1) { if (empty($pbfa01ed1["name"])) { launch_exception(new TableDiagramException(4, array($v539082ff30["name"], $pbfa01ed1))); return false; } if (empty($pbfa01ed1["attribute"])) { launch_exception(new TableDiagramException(5, array($v539082ff30["name"], $pbfa01ed1))); return false; } } if (!empty($v539082ff30["keys"]["foreign_keys"]) && is_array($v539082ff30["keys"]["foreign_keys"])) foreach ($v539082ff30["keys"]["foreign_keys"] as $pbfa01ed1) { if (empty($pbfa01ed1["attribute"])) { launch_exception(new TableDiagramException(6, array($v539082ff30["name"], $pbfa01ed1))); return false; } if (empty($pbfa01ed1["reference_table"])) { launch_exception(new TableDiagramException(7, array($v539082ff30["name"], $pbfa01ed1))); return false; } if (empty($pbfa01ed1["reference_attribute"])) { launch_exception(new TableDiagramException(8, array($v539082ff30["name"], $pbfa01ed1))); return false; } } if (!empty($v539082ff30["keys"]["index_keys"]) && is_array($v539082ff30["keys"]["index_keys"])) foreach ($v539082ff30["keys"]["index_keys"] as $pbfa01ed1) { if (empty($pbfa01ed1["name"])) { launch_exception(new TableDiagramException(9, array($v539082ff30["name"], $pbfa01ed1))); return false; } if (empty($pbfa01ed1["attribute"])) { launch_exception(new TableDiagramException(10, array($v539082ff30["name"], $pbfa01ed1))); return false; } } return true; } } ?>
