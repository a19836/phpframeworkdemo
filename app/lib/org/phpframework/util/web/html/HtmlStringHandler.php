<?php
/*
 * Copyright (c) 2007 PHPMyFrameWork - Joao Pinto
 * AUTHOR: Joao Paulo Lopes Pinto -- http://jplpinto.com
 * 
 * The use of this code must be allowed first by the creator Joao Pinto, since this is a private and proprietary code.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER 
 * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT 
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE 
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
include_once get_lib("org.phpframework.util.text.TextSanitizer"); class HtmlStringHandler { public static $single_tags_name = array("area", "base", "br", "col", "embed", "hr", "img", "input", "link", "meta", "param", "source", "track", "wbr", "command", "keygen", "menuitem", "frame", "iframe", "basefont", "bgsound", "isindex"); public static $auto_close_siblings_tag_name = array("li" => array("li"), "dd" => array("dd", "dt"), "dt" => array("dd", "dt")); public static $tags_to_jump = array("style", "script"); public static function convertElementsArrayToHtml($pdfa15f64, $v5d3813882f = array("trim" => false, "auto_close_missing_tags" => false)) { $pf8ed4912 = ""; $pa021e40c = $v5d3813882f && !empty($v5d3813882f["auto_close_missing_tags"]); if ($pdfa15f64) foreach ($pdfa15f64 as $v06f2bc39aa) { if (is_array($v06f2bc39aa)) { $v9c4bf49720 = isset($v06f2bc39aa["nodeType"]) ? $v06f2bc39aa["nodeType"] : null; switch ($v9c4bf49720) { case 3: case 8: $pf8ed4912 .= isset($v06f2bc39aa["nodeValue"]) ? $v06f2bc39aa["nodeValue"] : (isset($v06f2bc39aa["textContent"]) ? $v06f2bc39aa["textContent"] : null); break; case 1: $pf4b9d8e6 = isset($v06f2bc39aa["nodeName"]) ? $v06f2bc39aa["nodeName"] : null; $pfe47f27e = isset($v06f2bc39aa["openTag"]) ? $v06f2bc39aa["openTag"] : null; $pf1a07d26 = isset($v06f2bc39aa["closeTag"]) ? $v06f2bc39aa["closeTag"] : null; $v597df9e3ae = isset($v06f2bc39aa["childNodes"]) ? $v06f2bc39aa["childNodes"] : null; $v6f44c6f6e1 = $v597df9e3ae ? self::convertElementsArrayToHtml($v597df9e3ae, $v5d3813882f) : ""; $pf8ed4912 .= $pfe47f27e . $v6f44c6f6e1 . ($pf1a07d26 ? $pf1a07d26 : ($pa021e40c ? "</$pf4b9d8e6>" : "")); break; } } else $pf8ed4912 .= $v06f2bc39aa; } return $pf8ed4912; } public static function joinElementsArrayTextNodes($pdfa15f64) { $v217a47cf7a = array(); if ($pdfa15f64) foreach ($pdfa15f64 as $v06f2bc39aa) { $v3124f74596 = count($v217a47cf7a) - 1; if (is_array($v06f2bc39aa)) { $v9c4bf49720 = isset($v06f2bc39aa["nodeType"]) ? $v06f2bc39aa["nodeType"] : null; if ($v9c4bf49720 == 3) { if ($v3124f74596 >= 0 && is_array($v217a47cf7a[$v3124f74596]) && isset($v217a47cf7a[$v3124f74596]["nodeType"]) && $v217a47cf7a[$v3124f74596]["nodeType"] == $v9c4bf49720) $v217a47cf7a[$v3124f74596]["nodeValue"] .= isset($v06f2bc39aa["nodeValue"]) ? $v06f2bc39aa["nodeValue"] : null; else $v217a47cf7a[] = $v06f2bc39aa; } else $v217a47cf7a[] = $v06f2bc39aa; } else { if ($v3124f74596 >= 0 && !is_array($v217a47cf7a[$v3124f74596])) $v217a47cf7a[$v3124f74596] .= $v06f2bc39aa; else $v217a47cf7a[] = $v06f2bc39aa; } } return $v217a47cf7a; } public static function convertHtmlToElementsArray($pf8ed4912, $v5d3813882f = array("force_no_closing_tag_to_end" => true, "trim" => false)) { $pdfa15f64 = array(); if ($pf8ed4912) { $pbc81a3fa = $v5d3813882f && !empty($v5d3813882f["force_no_closing_tag_to_end"]); $peccb2fdc = $v5d3813882f && !empty($v5d3813882f["trim"]); $v29b7e75ba8 = strlen($pf8ed4912); $pac65f06f = 0; do { $v74821e235b = strpos($pf8ed4912, "<", $pac65f06f); if ($v74821e235b !== false) { $pb14f0deb = substr($pf8ed4912, $pac65f06f, $v74821e235b - $pac65f06f); $v15d6ec062d = null; if ( ($peccb2fdc && trim($pb14f0deb)) || (!$peccb2fdc && $pb14f0deb) ) $v15d6ec062d = array( "nodeType" => 3, "nodeValue" => $pb14f0deb, ); if (substr($pf8ed4912, $v74821e235b + 1, 3) == "!--") { $pcb7dc681 = strpos($pf8ed4912, "-->", $v74821e235b + 3); $pcb7dc681 = $pcb7dc681 === false ? $v29b7e75ba8 : $pcb7dc681 + 3; $v020036c951 = substr($pf8ed4912, $v74821e235b, $pcb7dc681 - $v74821e235b); $pac65f06f = $pcb7dc681; if ($v15d6ec062d) $pdfa15f64[] = $v15d6ec062d; $pdfa15f64[] = array( "nodeType" => 8, "textContent" => $v020036c951, ); } else { $pcb7dc681 = strpos($pf8ed4912, ">", $v74821e235b); $pcb7dc681 = $pcb7dc681 === false ? $v29b7e75ba8 : $pcb7dc681; $v1b1c6a10a2 = substr($pf8ed4912, $v74821e235b, ($pcb7dc681 + 1) - $v74821e235b); preg_match("/<\/?([^>\s]+)/", $v1b1c6a10a2, $v87ae7286da, PREG_OFFSET_CAPTURE); $pf4b9d8e6 = isset($v87ae7286da[1]) ? $v87ae7286da[1][0] : null; if ($pf4b9d8e6) { $pac65f06f = $pcb7dc681 + 1; if ($v15d6ec062d) $pdfa15f64[] = $v15d6ec062d; if (isset($pf8ed4912[$v74821e235b + 1]) && $pf8ed4912[$v74821e235b + 1] == "/") { $pdfa15f64[] = array( "nodeType" => 3, "nodeValue" => $v1b1c6a10a2, ); } else { $v06f2bc39aa = array( "nodeType" => 1, "nodeName" => $pf4b9d8e6, "openTag" => $v1b1c6a10a2, ); $v43209c0518 = in_array(strtolower($pf4b9d8e6), self::$single_tags_name); if ($pf8ed4912[$pcb7dc681 - 1] == "/" || $v43209c0518) { $v06f2bc39aa["singleTag"] = true; if ($v43209c0518) { $v6bfaac4650 = self::f0f65afcc01($pf8ed4912, $pf4b9d8e6, $pac65f06f); if ($v6bfaac4650 != $pac65f06f) { $v63b0df9c35 = substr($pf8ed4912, $pac65f06f, ($v6bfaac4650 + 1) - $pac65f06f); $v21bd44b305 = strripos($v63b0df9c35, "</$pf4b9d8e6"); $pa6c95151 = substr($v63b0df9c35, $v21bd44b305, ($v6bfaac4650 + 1) - $v21bd44b305); $v06f2bc39aa["closeTag"] = $pa6c95151; $pb14f0deb = substr($v63b0df9c35, 0, $v21bd44b305); if ( ($peccb2fdc && trim($pb14f0deb)) || (!$peccb2fdc && $pb14f0deb) ) $v06f2bc39aa["childNodes"] = array( array( "nodeType" => 3, "nodeValue" => $pb14f0deb, ) ); $pac65f06f = $v6bfaac4650 + 1; } } } else if (in_array(strtolower($pf4b9d8e6), self::$tags_to_jump)) { $v21bd44b305 = stripos($pf8ed4912, "</$pf4b9d8e6", $pac65f06f); if ($v21bd44b305 !== false) $v6bfaac4650 = stripos($pf8ed4912, ">", $v21bd44b305); else { $v21bd44b305 = $v29b7e75ba8; $v6bfaac4650 = false; } $v6bfaac4650 = $v6bfaac4650 !== false ? $v6bfaac4650 : $v29b7e75ba8; $pa6c95151 = substr($pf8ed4912, $v21bd44b305, ($v6bfaac4650 + 1) - $v21bd44b305); $v06f2bc39aa["closeTag"] = $pa6c95151; $v067674f4e4 = substr($pf8ed4912, $pac65f06f, $v21bd44b305 - $pac65f06f); $v06f2bc39aa["childNodes"] = array( array( "nodeType" => 3, "nodeValue" => $v067674f4e4, ) ); $pac65f06f = $v6bfaac4650 + 1; } else { $pf0aaa7e4 = self::f617f039d68($pf8ed4912, $pf4b9d8e6, $pac65f06f); if ($pf0aaa7e4 !== false) $pf0aaa7e4 = self::mb952836307db($pf8ed4912, $pf4b9d8e6, $v74821e235b, $pf0aaa7e4); if ($pf0aaa7e4 !== false) { $v6bfaac4650 = $pf0aaa7e4; $v63b0df9c35 = substr($pf8ed4912, $pac65f06f, ($v6bfaac4650 + 1) - $pac65f06f); $v21bd44b305 = strripos($v63b0df9c35, "</$pf4b9d8e6"); $pa6c95151 = substr($v63b0df9c35, $v21bd44b305, ($v6bfaac4650 + 1) - $v21bd44b305); $v06f2bc39aa["closeTag"] = $pa6c95151; $v6f44c6f6e1 = substr($v63b0df9c35, 0, $v21bd44b305); $v06f2bc39aa["childNodes"] = self::convertHtmlToElementsArray($v6f44c6f6e1, $v5d3813882f); $pac65f06f = $v6bfaac4650 + 1; } else if ($pbc81a3fa) { $pbaeb17fb = $v29b7e75ba8; $pbaeb17fb = self::mdc699ed87901($pf8ed4912, $pf4b9d8e6, $pac65f06f, $pbaeb17fb); $v6f44c6f6e1 = substr($pf8ed4912, $pac65f06f, $pbaeb17fb - $pac65f06f); $v06f2bc39aa["childNodes"] = self::convertHtmlToElementsArray($v6f44c6f6e1, $v5d3813882f); $pac65f06f = $pbaeb17fb; } } $pdfa15f64[] = $v06f2bc39aa; } } } } } while ($v74821e235b !== false); if ($pac65f06f < $v29b7e75ba8) { $pb14f0deb = substr($pf8ed4912, $pac65f06f, $v29b7e75ba8 - $pac65f06f); if ( ($peccb2fdc && trim($pb14f0deb)) || (!$peccb2fdc && $pb14f0deb) ) $pdfa15f64[] = array( "nodeType" => 3, "nodeValue" => $pb14f0deb, ); } } return $pdfa15f64; } public static function getHtmlTagAttributes($pf8ed4912) { $ped0a6251 = []; $pf8ed4912 = preg_replace("/<([<-z0-9_\-:]+)([^>]*)>/i", "\${2}", $pf8ed4912); if (substr($pf8ed4912, -1) == "/") $pf8ed4912 = substr($pf8ed4912, 0, -1); $pf8ed4912 = "<div $pf8ed4912></div>"; $v30163feac8 = new DOMDocument(); @$v30163feac8->loadHTML($pf8ed4912); $pe5367bde = $v30163feac8->getElementsByTagName('div'); $v0716c05faf = $pe5367bde[0]; if ($v0716c05faf && $v0716c05faf->attributes) foreach ($v0716c05faf->attributes as $v97915b9670) $ped0a6251[ $v97915b9670->nodeName ] = $v97915b9670->nodeValue; return $ped0a6251; } public static function containsHtmlTagAttributeValue($pf8ed4912, $v5e45ec9bb9, $pd6321fb0, $v5fce363e7a = false) { $pfdbbc383 = self::getHtmlTagAttributes($pf8ed4912); foreach ($pfdbbc383 as $pe5c5e2fe => $v956913c90f) if ($v5fce363e7a && ($pe5c5e2fe == $v5e45ec9bb9 && $v956913c90f == $pd6321fb0) || (!$v5fce363e7a && strtolower($pe5c5e2fe) == $v5e45ec9bb9 && strtolower($v956913c90f) == $pd6321fb0)) return true; return false; } public static function getHtmlTags($pf8ed4912, $pf4b9d8e6, $pbc81a3fa = false) { $v8a9674a7c9 = array(); $pac65f06f = 0; $v29b7e75ba8 = strlen($pf8ed4912); $v1c29ad0d17 = strlen($pf4b9d8e6); do { preg_match("/<$pf4b9d8e6([^>]*)>/i", $pf8ed4912, $pbae7526c, PREG_OFFSET_CAPTURE, $pac65f06f); if (!$pbae7526c || !$pbae7526c[0]) break; $v7e4b517c18 = $pbae7526c[0][1]; $v1b1c6a10a2 = $pbae7526c[0][0]; $v43209c0518 = in_array(strtolower($pf4b9d8e6), self::$single_tags_name); if (substr($v1b1c6a10a2, -2) == "/>" || $v43209c0518) { $v27e200bd34 = $v7e4b517c18 + strlen($v1b1c6a10a2); if ($v43209c0518) { $v4808b34628 = self::f0f65afcc01($pf8ed4912, $pf4b9d8e6, $v27e200bd34); if ($v4808b34628 != $v27e200bd34) { $v27e200bd34 = $v4808b34628 + 1; $v1b1c6a10a2 = substr($pf8ed4912, $v7e4b517c18, $v27e200bd34 - $v7e4b517c18); } } } else { $pf0aaa7e4 = self::f617f039d68($pf8ed4912, $pf4b9d8e6, $v7e4b517c18 + $v1c29ad0d17); if ($pf0aaa7e4 !== false) $pf0aaa7e4 = self::mb952836307db($pf8ed4912, $pf4b9d8e6, $v7e4b517c18, $pf0aaa7e4); if ($pf0aaa7e4 !== false) { $v27e200bd34 = $pf0aaa7e4 + 1; $v1b1c6a10a2 = substr($pf8ed4912, $v7e4b517c18, $v27e200bd34 - $v7e4b517c18); } else { if ($pbc81a3fa) $v1b1c6a10a2 = substr($pf8ed4912, $v7e4b517c18, $v29b7e75ba8 - $v7e4b517c18); $v27e200bd34 = $v29b7e75ba8; } } $v8a9674a7c9[] = $v1b1c6a10a2; $pac65f06f = $v27e200bd34; } while (true); return $v8a9674a7c9; } private static function mb952836307db($pf8ed4912, $pf4b9d8e6, $v7e4b517c18, $v27e200bd34) { $v29b7e75ba8 = strlen($pf8ed4912); $v1c29ad0d17 = strlen($pf4b9d8e6); $pac65f06f = $v7e4b517c18 + $v1c29ad0d17; $v12239b6473 = self::f8b6db59bd6($pf8ed4912, $pac65f06f, $v27e200bd34); $v70de8d2d7e = 0; do { $pbd1bc7b0 = stripos($pf8ed4912, "<$pf4b9d8e6", $pac65f06f); if ($pbd1bc7b0 === false || $pbd1bc7b0 >= $v27e200bd34) break; if (!self::me084d8809418($v12239b6473, $pbd1bc7b0)) $v70de8d2d7e++; $pac65f06f = $pbd1bc7b0 + $v1c29ad0d17; } while (true); if ($v70de8d2d7e > 0) { $pac65f06f = $v7e4b517c18 + $v1c29ad0d17; $pf0aaa7e4 = $v27e200bd34; while ($v70de8d2d7e >= 0) { do { $pf0aaa7e4 = self::f617f039d68($pf8ed4912, $pf4b9d8e6, $pac65f06f); if ($pf0aaa7e4 !== false && self::me084d8809418($v12239b6473, $pf0aaa7e4)) $pac65f06f = $pf0aaa7e4 + $v1c29ad0d17; else break; } while (true); if ($pf0aaa7e4 === false || $pf0aaa7e4 >= $v29b7e75ba8) break; $pac65f06f = $pf0aaa7e4; $v70de8d2d7e--; } if ($pf0aaa7e4 === false) return false; if ($v27e200bd34 != $pf0aaa7e4) $v27e200bd34 = self::mb952836307db($pf8ed4912, $pf4b9d8e6, $v7e4b517c18, $pf0aaa7e4); } return $v27e200bd34; } private static function f617f039d68($pf8ed4912, $pf4b9d8e6, $v7e4b517c18) { $v27e200bd34 = stripos($pf8ed4912, "</$pf4b9d8e6", $v7e4b517c18); if ($v27e200bd34 !== false) { $v12239b6473 = self::f8b6db59bd6($pf8ed4912, $v7e4b517c18, $v27e200bd34); if (self::me084d8809418($v12239b6473, $v27e200bd34)) $v27e200bd34 = self::f617f039d68($pf8ed4912, $pf4b9d8e6, $v27e200bd34 + strlen($pf4b9d8e6)); if ($v27e200bd34 !== false) $v27e200bd34 = stripos($pf8ed4912, ">", $v27e200bd34); } return $v27e200bd34; } private static function f0f65afcc01($pf8ed4912, $pf4b9d8e6, $pca701271) { $pbd1bc7b0 = strpos($pf8ed4912, "<", $pca701271); if ($pbd1bc7b0 !== false) { $v6b5e8f7eca = substr($pf8ed4912, $pbd1bc7b0); if (!preg_match("/^<\/?[a-z_]/i", $v6b5e8f7eca)) { $pa087bf87 = self::f0f65afcc01($pf8ed4912, $pf4b9d8e6, $pbd1bc7b0 + 1); if ($pbd1bc7b0 + 1 != $pa087bf87) $pca701271 = $pa087bf87; } else if (preg_match("/^<\/$pf4b9d8e6/i", $v6b5e8f7eca)) { preg_match("/^<\/$pf4b9d8e6([^>]*)>/i", $v6b5e8f7eca, $v8e4e2629ca, PREG_OFFSET_CAPTURE); $pca701271 = $pbd1bc7b0 + strlen($v8e4e2629ca[0][0]) - 1; } } return $pca701271; } private static function mdc699ed87901($pf8ed4912, $pf4b9d8e6, $v7e4b517c18, $v27e200bd34) { if (in_array($pf4b9d8e6, self::$auto_close_siblings_tag_name) || self::$auto_close_siblings_tag_name[$pf4b9d8e6]) { $v9ffac79e8c = self::$auto_close_siblings_tag_name[$pf4b9d8e6]; $v9ffac79e8c = is_array($v9ffac79e8c) ? $v9ffac79e8c : array( (trim($v9ffac79e8c) ? $v9ffac79e8c : $pf4b9d8e6) ); $v11994d2e50 = false; $v0c49a0bbb5 = self::f8b6db59bd6($pf8ed4912, $v7e4b517c18, $v27e200bd34); foreach ($v9ffac79e8c as $v9f98a7e826) { $v670b14a5b5 = $v7e4b517c18; $v9f98a7e826 = trim($v9f98a7e826); if ($v9f98a7e826) { while (true) { $pbd1bc7b0 = stripos($pf8ed4912, "<" . $v9f98a7e826, $v670b14a5b5); if ($pbd1bc7b0 !== false) { if (self::me084d8809418($v0c49a0bbb5, $pbd1bc7b0)) $v670b14a5b5 = $pbd1bc7b0 + strlen($v9f98a7e826); else if ($pbd1bc7b0 < $v11994d2e50 || $v11994d2e50 === false) { $v11994d2e50 = $pbd1bc7b0; break; } else break; } else break; } } } if ($v11994d2e50 !== false) $v27e200bd34 = $v11994d2e50; } return $v27e200bd34; } private static function me084d8809418($v12239b6473, $pac65f06f) { foreach ($v12239b6473 as $v297f456509) { $v7e4b517c18 = $v297f456509[0]; $v27e200bd34 = $v297f456509[1]; if ($pac65f06f > $v7e4b517c18 && $pac65f06f < $v27e200bd34) return true; } return false; } private static function f8b6db59bd6($pf8ed4912, $v7e4b517c18, $v27e200bd34) { $v12239b6473 = array(); $v29b7e75ba8 = strlen($pf8ed4912); foreach (self::$tags_to_jump as $v86269ee981) { $pac65f06f = $v7e4b517c18; $v51b796adce = strlen($v86269ee981); while($pac65f06f < $v27e200bd34) { $v9d9a3a54cb = stripos($pf8ed4912, "<$v86269ee981", $pac65f06f); if ($v9d9a3a54cb !== false && $v9d9a3a54cb < $v27e200bd34) { $v0d3c28b9a6 = self::f617f039d68($pf8ed4912, $v86269ee981, $v9d9a3a54cb + $v51b796adce); $v0d3c28b9a6 = $v0d3c28b9a6 === false ? $v29b7e75ba8 : $v0d3c28b9a6; $v12239b6473[] = array($v9d9a3a54cb, $v0d3c28b9a6); $pac65f06f = $v0d3c28b9a6 + 1; } else break; } } return $v12239b6473; } } ?>
