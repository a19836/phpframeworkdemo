<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sql_mapping>
	<insert id="insert_message">
		insert into mmsg_message (from_user_id, to_user_id, subject, content, from_user_status, to_user_status, created_date, modified_date) values (#from_user_id#, #to_user_id#, '#subject#', '#content#', '#from_user_status#', '#to_user_status#', '#created_date#', '#modified_date#')
	</insert>
	<insert id="insert_message_with_ai_pk" hard_coded_ai_pk="1">
		insert into mmsg_message (message_id, from_user_id, to_user_id, subject, content, from_user_status, to_user_status, created_date, modified_date) values (#message_id#, #from_user_id#, #to_user_id#, '#subject#', '#content#', '#from_user_status#', '#to_user_status#', '#created_date#', '#modified_date#')
	</insert>
	
	<update id="update_message_seen_date">
		update mmsg_message set seen_date='#seen_date#', modified_date='#modified_date#' where message_id=#message_id# and from_user_id=#from_user_id# and to_user_id=#to_user_id#
	</update>
	
	<update id="update_messages_from_user_status">
		update mmsg_message set from_user_status=#from_user_status#, modified_date='#modified_date#' where from_user_id=#from_user_id# and to_user_id=#to_user_id#
	</update>
	
	<update id="update_messages_to_user_status">
		update mmsg_message set to_user_status=#to_user_status#, modified_date='#modified_date#' where from_user_id=#from_user_id# and to_user_id=#to_user_id#
	</update>
	
	<delete id="delete_message">
		delete from mmsg_message where message_id=#message_id# and from_user_id=#from_user_id# and to_user_id=#to_user_id#
	</delete>
	
	<delete id="delete_expired_messages">
		delete from mmsg_message where from_user_status=2 and to_user_status=2
	</delete>
	
	<delete id="delete_user_messages">
		delete from mmsg_message where from_user_id=#user_id# or to_user_id=#user_id#
	</delete>
	
	<select id="get_message">
		select * from mmsg_message where message_id=#message_id# and from_user_id=#from_user_id# and to_user_id=#to_user_id#
	</select>
	
	<select id="get_all_messages">
		select * from mmsg_message
	</select>
	
	<select id="count_all_messages">
		select count(message_id) total from mmsg_message
	</select>
	
	<select id="get_messages_by_message_ids">
		select * from mmsg_message where message_id in (#message_ids#)
	</select>
	
	<select id="get_messages_by_conditions">
		select * from mmsg_message where #conditions#
	</select>
	
	<select id="count_messages_by_conditions">
		select count(message_id) total from mmsg_message where #conditions#
	</select>
	
	<select id="get_chat_messages">
		select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1
		union
		select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1
	</select>
	
	<select id="count_chat_messages">
		select count(message_id) as total from (
			select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1
			union
			select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1
		) m
	</select>
	
	<select id="get_previous_chat_messages_from_message">
		select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1 and message_id &lt; #message_id#
		union
		select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1 and message_id &lt; #message_id#
	</select>
	
	<select id="count_previous_chat_messages_from_message">
		select count(message_id) as total from (
			select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1 and message_id &lt; #message_id#
			union
			select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1 and message_id &lt; #message_id#
		) m
	</select>
	
	<select id="get_next_chat_messages_from_message">
		select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1 and message_id > #message_id#
		union
		select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1 and message_id > #message_id#
	</select>
	
	<select id="count_next_chat_messages_from_message">
		select count(message_id) as total from (
			select * from mmsg_message where from_user_id=#from_user_id# and to_user_id=#to_user_id# and from_user_status=1 and message_id > #message_id#
			union
			select * from mmsg_message where from_user_id=#to_user_id# and to_user_id=#from_user_id# and to_user_status=1 and message_id > #message_id#
		) m
	</select>
	
	<select id="get_user_chat_users">
		select u.*, cu.created_date last_chat_date 
		from (
			select user_id, max(created_date) created_date from (
				select to_user_id as user_id, created_date from mmsg_message where from_user_id=#user_id# and from_user_status=1
				union
				select from_user_id as user_id, created_date from mmsg_message where to_user_id=#user_id# and to_user_status=1
			) m
			group by user_id
		) cu 
		inner join mu_user u on u.user_id=cu.user_id
		order by last_chat_date desc
	</select>
	
	<select id="get_user_last_unique_chats">
		select mu.user_id, m.*
		from (
			select user_id, max(message_id) message_id from (
				select to_user_id as user_id, message_id from mmsg_message where from_user_id=#user_id# and from_user_status=1
				union
				select from_user_id as user_id, message_id from mmsg_message where to_user_id=#user_id# and to_user_status=1
			) m
			group by user_id
			order by message_id desc
		) mu
		inner join mmsg_message m on m.message_id=mu.message_id 
		order by created_date desc
	</select>
</sql_mapping>
