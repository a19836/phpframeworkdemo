<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sql_mapping>
	<insert id="insert_menu_group">
		insert into mmenu_group (name, created_date, modified_date) values ('#name#', '#created_date#', '#modified_date#')
	</insert>
	
	<update id="update_menu_group">
		update mmenu_group set name='#name#', modified_date='#modified_date#' where group_id=#group_id#
	</update>
	
	<delete id="delete_menu_group">
		delete from mmenu_group where group_id=#group_id#
	</delete>
	
	<select id="get_menu_group">
		select * from mmenu_group where group_id=#group_id#
	</select>
	
	<select id="get_all_menu_groups">
		select * from mmenu_group
	</select>
	
	<select id="count_all_menu_groups">
		select count(group_id) total from mmenu_group
	</select>
	
	<select id="get_menu_groups_by_ids">
		select * from mmenu_group where group_id in (#group_ids#)
	</select>
	
	<select id="get_menu_groups_by_conditions">
		select * from mmenu_group where #conditions#
	</select>
	
	<select id="count_menu_groups_by_conditions">
		select count(group_id) total from mmenu_group where #conditions#
	</select>
	
	<select id="get_menu_groups_by_object_and_conditions">
		select g.*, og.`group` `group`, og.`order` `order`
		from mmenu_group g
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.group_id=g.group_id
		where #conditions#
	</select>
	
	<select id="count_menu_groups_by_object_and_conditions">
		select count(g.group_id) total 
		from mmenu_group g
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.group_id=g.group_id
		where #conditions#
	</select>
	
	<select id="get_menu_groups_by_object">
		select g.*, og.`group` `group`, og.`order` `order`
		from mmenu_group g 
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.group_id=g.group_id
	</select>
	
	<select id="count_menu_groups_by_object">
		select count(g.group_id) total
		from mmenu_group g 
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.group_id=g.group_id
	</select>
	
	<select id="get_menu_groups_by_object_group">
		select g.*, og.`group` `group`, og.`order` `order`
		from mmenu_group g 
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.`group`=#group# and og.group_id=g.group_id
	</select>
	
	<select id="count_menu_groups_by_object_group">
		select count(g.group_id) total
		from mmenu_group g 
		inner join mmenu_object_group og on og.object_type_id=#object_type_id# and og.object_id=#object_id# and og.`group`=#group# and og.group_id=g.group_id
	</select>
	
	<select id="get_menu_groups_with_all_tags">
		select g.*, z.tag_group, z.tag_order, z.tags_count 
		from mmenu_group g 
		inner join (
			select g.group_id, group_concat(distinct ot.`group`) tag_group, max(ot.`order`) tag_order, count(t.tag) tags_count
			from mmenu_group g 
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=g.group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by g.group_id having count(t.tag) >= #tags_count#
		) z on z.group_id=g.group_id
	</select>
	
	<select id="count_menu_groups_with_all_tags">
		select count(group_id) total
		from (
			select g.group_id, count(t.tag) tags_count
			from mmenu_group g 
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=g.group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by g.group_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_menu_groups_by_tags">
		select g.*, ot.`group` tag_group, ot.`order` tag_order
		from mmenu_group g 
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=g.group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="count_menu_groups_by_tags">
		select count(g.group_id) total
		from mmenu_group g 
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=g.group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
</sql_mapping>
