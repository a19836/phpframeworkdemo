<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sql_mapping>
	<insert id="insert_event">
		insert into me_event (title, sub_title, description, published, photo_id, allow_comments, address, zip_id, locality, country_id, latitude, longitude, begin_date, end_date, created_date, modified_date) values ('#title#', '#sub_title#', '#description#', #published#, #photo_id#, #allow_comments#, '#address#', '#zip_id#', '#locality#', #country_id#, '#latitude#', '#longitude#', '#begin_date#', '#end_date#', '#created_date#', '#modified_date#')
	</insert>
	
	<update id="update_event">
		update me_event set title='#title#', sub_title='#sub_title#', description='#description#', published=#published#, photo_id=#photo_id#, allow_comments=#allow_comments#, address='#address#', zip_id='#zip_id#', locality='#locality#', country_id=#country_id#, latitude='#latitude#', longitude='#longitude#', begin_date='#begin_date#', end_date='#end_date#', modified_date='#modified_date#' where event_id=#event_id#
	</update>
	
	<delete id="delete_event">
		delete from me_event where event_id=#event_id#
	</delete>
	
	<select id="get_event">
		select * from me_event where event_id=#event_id#
	</select>
	
	<select id="get_all_events">
		select * from me_event
	</select>
	
	<select id="count_all_events">
		select count(event_id) total from me_event
	</select>
	
	<select id="get_events_by_ids">
		select * from me_event where event_id in (#event_ids#)
	</select>
	
	<select id="get_events_by_conditions">
		select * from me_event where #conditions#
	</select>
	
	<select id="count_events_by_conditions">
		select count(event_id) total from me_event where #conditions#
	</select>
	
	<select id="get_events_by_tags">
		select e.*, ot.`group` tag_group, ot.`order` tag_order
		from me_event e
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="count_events_by_tags">
		select count(e.event_id) total
		from me_event e
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="get_events_by_object_and_tags">
		select e.*, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
		from me_event e
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
		inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="count_events_by_object_and_tags">
		select count(e.event_id) total
		from me_event e
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
		inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="get_events_by_object_group_and_tags">
		select e.*, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
		from me_event e
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
		inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>

	<select id="count_events_by_object_group_and_tags">
		select count(e.event_id) total
		from me_event e
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
		inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
		where #conditions#
	</select>
	
	<select id="get_events_with_all_tags">
		select e.*, z.tag_group, z.tag_order, z.tags_count 
		from me_event e 
		inner join (
			select e.event_id, group_concat(distinct ot.`group`) tag_group, max(ot.`order`) tag_order, count(t.tag) tags_count
			from me_event e
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) z on z.event_id=e.event_id
	</select>
	
	<select id="count_events_with_all_tags">
		select count(event_id) total
		from (
			select e.event_id, count(t.tag) tags_count
			from me_event e
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_events_by_object_with_all_tags">
		select e.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
		from me_event e 
		inner join (
			select e.event_id, group_concat(distinct oe.`group`) `group`, max(oe.`order`) `order`, group_concat(distinct ot.`group`) tag_group, max(ot.`order`) tag_order, count(t.tag) tags_count
			from me_event e
			inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
			inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) z on z.event_id=e.event_id
	</select>
	
	<select id="count_events_by_object_with_all_tags">
		select count(event_id) total
		from (
			select e.event_id, count(t.tag) tags_count
			from me_event e
			inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
			inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_events_by_object_group_with_all_tags">
		select e.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
		from me_event e 
		inner join (
			select e.event_id, group_concat(distinct oe.`group`) `group`, max(oe.`order`) `order`, group_concat(distinct ot.`group`) tag_group, max(ot.`order`) tag_order, count(t.tag) tags_count
			from me_event e
			inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
			inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) z on z.event_id=e.event_id
	</select>
	
	<select id="count_events_by_object_group_with_all_tags">
		select count(event_id) total
		from (
			select e.event_id, count(t.tag) tags_count
			from me_event e
			inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
			inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			where #conditions#
			group by e.event_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_events_by_object">
		select e.*, oe.`group` `group`, oe.`order` `order`
		from me_event e 
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
		where #conditions#
	</select>
	
	<select id="count_events_by_object">
		select count(e.event_id) total
		from me_event e 
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
		where #conditions#
	</select>
	
	<select id="get_events_by_object_group">
		select e.*, oe.`group` `group`, oe.`order` `order`
		from me_event e 
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.`group`=#group#
		where #conditions#
	</select>
	
	<select id="count_events_by_object_group">
		select count(e.event_id) total
		from me_event e 
		inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.`group`=#group#
		where #conditions#
	</select>
</sql_mapping>
