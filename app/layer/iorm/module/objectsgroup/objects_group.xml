<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sql_mapping>
	<insert id="insert_objects_group">
		insert into mog_objects_group (object, created_date, modified_date) values ('#object#', '#created_date#', '#modified_date#')
	</insert>
	
	<update id="update_objects_group">
		update mog_objects_group set object='#object#', modified_date='#modified_date#' where objects_group_id=#objects_group_id#
	</update>
	
	<delete id="delete_objects_group">
		delete from mog_objects_group where objects_group_id=#objects_group_id#
	</delete>
	
	<select id="get_objects_group">
		select * from mog_objects_group where objects_group_id=#objects_group_id#
	</select>
	
	<select id="get_all_objects_groups">
		select * from mog_objects_group
	</select>
	
	<select id="count_all_objects_groups">
		select count(objects_group_id) total from mog_objects_group
	</select>
	
	<select id="get_objects_groups_by_ids">
		select * from mog_objects_group where objects_group_id in (#objects_group_ids#)
	</select>
	
	<select id="get_objects_groups_by_conditions">
		select * from mog_objects_group where #conditions#
	</select>
	
	<select id="count_objects_groups_by_conditions">
		select count(objects_group_id) total from mog_objects_group where #conditions#
	</select>

	<select id="get_objects_groups_by_tags">
		select og.*, ot.`group` tag_group, ot.`order` tag_order
		from mog_objects_group og
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>

	<select id="count_objects_groups_by_tags">
		select count(og.objects_group_id) total
		from mog_objects_group og
		inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>
	
	<select id="get_objects_groups_by_object_and_tags">
		select og.*, oog.`group` `group`, oog.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
		inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>
	
	<select id="count_objects_groups_by_object_and_tags">
		select count(og.objects_group_id) total
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
		inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>
			
	<select id="get_objects_groups_by_object_group_and_tags">
		select og.*, oog.`group` `group`, oog.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
		inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>
	
	<select id="count_objects_groups_by_object_group_and_tags">
		select count(og.objects_group_id) total
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
		inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
		inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
	</select>
	
	<select id="get_objects_groups_with_all_tags">
		select og.*, z.tag_group, z.tag_order, z.tags_count 
		from mog_objects_group og 
		inner join (
			select og.objects_group_id, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
			from mog_objects_group og
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
		) z on z.objects_group_id=og.objects_group_id
	</select>

	<select id="count_objects_groups_with_all_tags">
		select count(objects_group_id) total
		from (
			select og.objects_group_id, count(t.tag) tags_count
			from mog_objects_group og
			inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_objects_groups_by_object_with_all_tags">
		select og.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
		from mog_objects_group og 
		inner join (
			select og.objects_group_id, oog.`group` `group`, oog.`order` `order`, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
			from mog_objects_group og
			inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
			inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id, oog.`group`, oog.`order`, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
		) z on z.objects_group_id=og.objects_group_id
	</select>

	<select id="count_objects_groups_by_object_with_all_tags">
		select count(objects_group_id) total
		from (
			select og.objects_group_id, count(t.tag) tags_count
			from mog_objects_group og
			inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
			inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_objects_groups_by_object_group_with_all_tags">
		select og.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
		from mog_objects_group og 
		inner join (
			select og.objects_group_id, oog.`group` `group`, oog.`order` `order`, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
			from mog_objects_group og
			inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
			inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id, oog.`group`, oog.`order`, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
		) z on z.objects_group_id=og.objects_group_id
	</select>
	
	<select id="count_objects_groups_by_object_group_with_all_tags">
		select count(objects_group_id) total
		from (
			select og.objects_group_id, count(t.tag) tags_count
			from mog_objects_group og
			inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
			inner join mt_object_tag ot on ot.object_type_id=#objects_group_object_type_id# and ot.object_id=og.objects_group_id
			inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
			group by og.objects_group_id having count(t.tag) >= #tags_count#
		) Z
	</select>
	
	<select id="get_objects_groups_by_object_and_conditions">
		select og.*, oog.`group` `group`, oog.`order` `order`
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
		where #conditions#
	</select>
	
	<select id="count_objects_groups_by_object_and_conditions">
		select count(og.objects_group_id) total 
		from mog_objects_group og
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
		where #conditions#
	</select>
	
	<select id="get_objects_groups_by_object">
		select og.*, oog.`group` `group`, oog.`order` `order`
		from mog_objects_group og 
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
	</select>
	
	<select id="count_objects_groups_by_object">
		select count(og.objects_group_id) total
		from mog_objects_group og 
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id#
	</select>
	
	<select id="get_objects_groups_by_object_group">
		select og.*, oog.`group` `group`, oog.`order` `order`
		from mog_objects_group og 
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
	</select>
	
	<select id="count_objects_groups_by_object_group">
		select count(og.objects_group_id) total
		from mog_objects_group og 
		inner join mog_object_objects_group oog on oog.objects_group_id=og.objects_group_id and oog.object_type_id=#object_type_id# and oog.object_id=#object_id# and oog.`group`=#group#
	</select>
</sql_mapping>
