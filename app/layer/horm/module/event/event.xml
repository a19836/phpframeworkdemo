<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<sql_mapping>
	<class name="Event" table="me_event">
		<id column="event_id"></id>
		
		<relationships>
			<one_to_many name="tags">
				<attribute column="tag" table="mt_tag" />
				
				<key pcolumn="object_id" fcolumn="object_id" ftable="mt_object_tag" />
				<key pcolumn="tag_id" ptable="mt_object_tag" fcolumn="tag_id" ftable="mt_tag" />
				
				<condition column="object_type_id" table="mt_object_tag" value="#object_type_id#" />
			</one_to_many>
		</relationships>
		
		<queries>
			<select id="get_events_by_tags">
				select e.*, ot.`group` tag_group, ot.`order` tag_order
				from me_event e
				inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>
	
			<select id="count_events_by_tags">
				select count(e.event_id) total
				from me_event e
				inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>
	
			<select id="get_events_by_object_and_tags">
				select e.*, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
				from me_event e
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
				inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>
	
			<select id="count_events_by_object_and_tags">
				select count(e.event_id) total
				from me_event e
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
				inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>
	
			<select id="get_events_by_object_group_and_tags">
				select e.*, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order
				from me_event e
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
				inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>

			<select id="count_events_by_object_group_and_tags">
				select count(e.event_id) total
				from me_event e
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
				inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
				inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
				where #conditions#
			</select>
	
			<select id="get_events_with_all_tags">
				select e.*, z.tag_group, z.tag_order, z.tags_count 
				from me_event e 
				inner join (
					select e.event_id, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
					from me_event e
					inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
				) z on z.event_id=e.event_id
			</select>
	
			<select id="count_events_with_all_tags">
				select count(event_id) total
				from (
					select e.event_id, count(t.tag) tags_count
					from me_event e
					inner join mt_object_tag ot on ot.object_type_id=#object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id having count(t.tag) >= #tags_count#
				) Z
			</select>
	
			<select id="get_events_by_object_with_all_tags">
				select e.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
				from me_event e 
				inner join (
					select e.event_id, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
					from me_event e
					inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
					inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id, oe.`group`, oe.`order`, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
				) z on z.event_id=e.event_id
			</select>
	
			<select id="count_events_by_object_with_all_tags">
				select count(event_id) total
				from (
					select e.event_id, count(t.tag) tags_count
					from me_event e
					inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
					inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id having count(t.tag) >= #tags_count#
				) Z
			</select>
	
			<select id="get_events_by_object_group_with_all_tags">
				select e.*, z.`group`, z.`order`, z.tag_group, z.tag_order, z.tags_count 
				from me_event e 
				inner join (
					select e.event_id, oe.`group` `group`, oe.`order` `order`, ot.`group` tag_group, ot.`order` tag_order, count(t.tag) tags_count
					from me_event e
					inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
					inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id, oe.`group`, oe.`order`, ot.`group`, ot.`order` having count(t.tag) >= #tags_count#
				) z on z.event_id=e.event_id
			</select>
	
			<select id="count_events_by_object_group_with_all_tags">
				select count(event_id) total
				from (
					select e.event_id, count(t.tag) tags_count
					from me_event e
					inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.group=#group#
					inner join mt_object_tag ot on ot.object_type_id=#event_object_type_id# and ot.object_id=e.event_id
					inner join mt_tag t on t.tag_id=ot.tag_id and t.tag in (#tags#)
					where #conditions#
					group by e.event_id having count(t.tag) >= #tags_count#
				) Z
			</select>
	
			<select id="get_events_by_object">
				select e.*, oe.`group` `group`, oe.`order` `order`
				from me_event e 
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
				where #conditions#
			</select>
	
			<select id="count_events_by_object">
				select count(e.event_id) total
				from me_event e 
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id#
				where #conditions#
			</select>
	
			<select id="get_events_by_object_group">
				select e.*, oe.`group` `group`, oe.`order` `order`
				from me_event e 
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.`group`=#group#
				where #conditions#
			</select>
	
			<select id="count_events_by_object_group">
				select count(e.event_id) total
				from me_event e 
				inner join me_object_event oe on oe.event_id=e.event_id and oe.object_type_id=#object_type_id# and oe.object_id=#object_id# and oe.`group`=#group#
				where #conditions#
			</select>
		</queries>
	</class>
</sql_mapping>
