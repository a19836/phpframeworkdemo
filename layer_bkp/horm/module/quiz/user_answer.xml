<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<sql_mapping>
	<class name="UserAnswer" table="mq_user_answer">
		<id column="user_id"></id>
		<id column="answer_id"></id>
		
		<relationships>
			<one_to_many name="answer">
				<attribute column="*" table="mq_answer" />
				
				<key pcolumn="answer_id" fcolumn="answer_id" ftable="mq_answer" />
			</one_to_many>
		</relationships>
		
		<queries>
			<delete id="delete_user_answers_by_question_ids">
				delete ua.* from mq_user_answer ua
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
			</delete>
			
			<delete id="delete_user_answers_by_user_and_question_ids">
				delete ua.* from mq_user_answer ua
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
				where ua.user_id=#user_id#
			</delete>
			
			<select id="get_user_answers_by_question_ids">
				select u.*, ua.*, a.question_id
				from mq_user_answer ua 
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
				inner join mu_user u on u.user_id=ua.user_id
			</select>
	
			<select id="get_user_answers_by_user_and_question_ids">
				select ua.*, a.question_id
				from mq_user_answer ua 
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
				where ua.user_id=#user_id#
			</select>
			
			<select id="get_user_answers_by_question_object">
				select u.*, ua.*, a.question_id
				from mq_user_answer ua 
				inner join mq_object_question oq on oq.object_type_id=#object_type_id# and oq.object_id=#object_id#
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id=oq.question_id
				inner join mu_user u on u.user_id=ua.user_id
			</select>
			
			<select id="get_user_answers_by_question_ids_grouped_by_users">
				select ua.user_id, GROUP_CONCAT(DISTINCT ua.answer_id) AS answers_id
				from mq_user_answer ua 
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
				group by ua.user_id
			</select>
			
			<select id="count_user_answers_by_question_ids_grouped_by_users">
				select count(distinct(ua.user_id)) total
				from mq_user_answer ua 
				inner join mq_answer a on a.answer_id=ua.answer_id and a.question_id in (#question_ids#)
			</select>
		</queries>
	</class>
</sql_mapping>
